<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å·¥ç¨‹å¸ˆèº«ä»½ç»‘å®š</title>
    <script src="https://res.wx.qq.com/open/js/jweixin-1.6.0.js"></script>
    <style>
        body {
            font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .card {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            text-align: center;
            max-width: 400px;
            width: 100%;
        }
        .icon {
            font-size: 60px;
            margin-bottom: 20px;
        }
        .success { color: #4CAF50; }
        .error { color: #e74c3c; }
        .loading { color: #3498db; }
        h1 { color: #333; margin-bottom: 15px; }
        .info { 
            background: #f8f9fa; 
            padding: 15px; 
            border-radius: 8px; 
            margin: 15px 0;
            text-align: left;
        }
        .debug {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            border-radius: 5px;
            margin-top: 15px;
            font-size: 12px;
            text-align: left;
            display: none;
        }
        button {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px;
        }
        .retry-btn { background: #e74c3c; }
    </style>
</head>
<body>
    <div class="card">
        <div id="loadingState">
            <div class="icon loading">â³</div>
            <h1>èº«ä»½ç»‘å®šä¸­...</h1>
            <p>æ­£åœ¨è·å–æ‚¨çš„èº«ä»½ä¿¡æ¯</p>
            <div class="debug" id="loadingDebug"></div>
        </div>

        <div id="successState" style="display: none;">
            <div class="icon success">âœ…</div>
            <h1>ç»‘å®šæˆåŠŸ</h1>
            <div class="info">
                <div style="font-size: 18px; font-weight: bold;" id="engineerName">--</div>
                <div style="color: #666;" id="engineerOpenid">OpenID: --</div>
            </div>
            <p style="color: #999;">æ‚¨ç°åœ¨å¯ä»¥æ‰«æå‘˜å·¥äºŒç»´ç è¿›è¡Œè€ƒå‹¤ç™»è®°äº†</p>
            <button onclick="closePage()">å…³é—­é¡µé¢</button>
        </div>

        <div id="errorState" style="display: none;">
            <div class="icon error">âŒ</div>
            <h1>ç»‘å®šå¤±è´¥</h1>
            <p id="errorMessage">ç³»ç»Ÿé”™è¯¯</p>
            <div class="debug" id="errorDebug"></div>
            <div>
                <button onclick="retryBind()">é‡è¯•å¾®ä¿¡ç»‘å®š</button>
                <button class="retry-btn" onclick="useSimpleBind()">ä½¿ç”¨ç®€åŒ–ç»‘å®š</button>
            </div>
        </div>

        <!-- ç®€åŒ–ç»‘å®šè¡¨å• -->
        <div id="simpleBindState" style="display: none;">
            <div class="icon loading">ğŸ‘¤</div>
            <h1>ç®€åŒ–èº«ä»½ç»‘å®š</h1>
            <div class="info">
                <p>ç”±äºå¾®ä¿¡æˆæƒé™åˆ¶ï¼Œè¯·æ‰‹åŠ¨è¾“å…¥ä¿¡æ¯å®Œæˆç»‘å®šï¼š</p>
                <div style="margin: 15px 0;">
                    <input type="text" id="simpleOpenid" placeholder="è¯·è¾“å…¥æ‚¨çš„å·¥å·æˆ–æ ‡è¯†" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; margin: 10px 0;">
                    <input type="text" id="simpleNickname" placeholder="è¯·è¾“å…¥æ‚¨çš„å§“å" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; margin: 10px 0;">
                </div>
            </div>
            <div>
                <button onclick="submitSimpleBind()">ç¡®è®¤ç»‘å®š</button>
                <button class="retry-btn" onclick="retryBind()">é‡æ–°å°è¯•å¾®ä¿¡ç»‘å®š</button>
            </div>
        </div>
    </div>

<script>
// æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯
function showDebug(message) {
    console.log('DEBUG:', message);
    const element = document.getElementById('loadingDebug');
    if (element) {
        element.style.display = 'block';
        element.innerHTML += message + '<br>';
    }
}

// æ˜¾ç¤ºé”™è¯¯è°ƒè¯•ä¿¡æ¯
function showErrorDebug(message) {
    console.error('ERROR:', message);
    const element = document.getElementById('errorDebug');
    if (element) {
        element.style.display = 'block';
        element.innerHTML += message + '<br>';
    }
}

// è·å–URLå‚æ•°
function getUrlParams() {
    const params = new URLSearchParams(window.location.search);
    return {
        engineer_name: params.get('engineer_name') || 'å·¥ç¨‹å¸ˆ'
    };
}

// æ˜¾ç¤ºçŠ¶æ€
function showState(state) {
    document.getElementById('loadingState').style.display = 'none';
    document.getElementById('successState').style.display = 'none';
    document.getElementById('errorState').style.display = 'none';
    document.getElementById('simpleBindState').style.display = 'none';
    document.getElementById(state + 'State').style.display = 'block';
}

// æ˜¾ç¤ºé”™è¯¯
function showError(message) {
    document.getElementById('errorMessage').textContent = message;
    showState('error');
}

// å…³é—­é¡µé¢
function closePage() {
    try {
        if (typeof WeixinJSBridge !== "undefined") {
            WeixinJSBridge.call('closeWindow');
        } else {
            window.close();
        }
    } catch (e) {
        alert('ç»‘å®šå®Œæˆï¼è¯·æ‰‹åŠ¨å…³é—­æ­¤é¡µé¢ã€‚');
    }
}

// é‡è¯•ç»‘å®š
function retryBind() {
    showState('loading');
    document.getElementById('errorDebug').innerHTML = '';
    setTimeout(init, 1000);
}

// ä½¿ç”¨ç®€åŒ–ç»‘å®š
function useSimpleBind() {
    showState('simpleBind');
}

// æäº¤ç®€åŒ–ç»‘å®š
async function submitSimpleBind() {
    const openid = document.getElementById('simpleOpenid').value.trim();
    const nickname = document.getElementById('simpleNickname').value.trim();
    
    if (!openid || !nickname) {
        alert('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯');
        return;
    }
    
    const params = getUrlParams();
    const userInfo = {
        openid: openid,
        nickname: nickname,
        isSimple: true
    };
    
    await bindEngineer(params.engineer_name, userInfo);
}

// ç”Ÿæˆä¸´æ—¶OpenID
function generateTempOpenid() {
    return 'temp_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now();
}

// ç®€åŒ–ç‰ˆå¾®ä¿¡ç™»å½•ï¼ˆä¸ä¾èµ–å¤æ‚é…ç½®ï¼‰
function simpleWechatLogin() {
    return new Promise((resolve, reject) => {
        showDebug('å°è¯•è·å–å¾®ä¿¡ç”¨æˆ·ä¿¡æ¯...');
        
        // æ–¹æ³•1: å°è¯•ä½¿ç”¨å¾®ä¿¡JS-SDK
        if (typeof wx !== 'undefined' && wx.getUserInfo) {
            showDebug('æ£€æµ‹åˆ°å¾®ä¿¡ç¯å¢ƒï¼Œå°è¯•æˆæƒ...');
            
            // ç®€åŒ–é…ç½®ï¼ˆå®é™…é¡¹ç›®ä¸­éœ€è¦åç«¯ç­¾åï¼‰
            wx.config({
                debug: false,
                appId: '', // éœ€è¦ä½ çš„å…¬ä¼—å·AppID
                timestamp: Math.floor(Date.now() / 1000),
                nonceStr: 'nonceStr' + Math.random().toString(36).substr(2),
                signature: '', // éœ€è¦åç«¯ç”Ÿæˆ
                jsApiList: ['getUserInfo']
            });
            
            wx.ready(function() {
                showDebug('å¾®ä¿¡JS-SDKå‡†å¤‡å°±ç»ª');
                wx.getUserInfo({
                    success: function(res) {
                        showDebug('å¾®ä¿¡æˆæƒæˆåŠŸ');
                        resolve({
                            openid: res.userInfo.openId || generateTempOpenid(),
                            nickname: res.userInfo.nickName || 'å¾®ä¿¡ç”¨æˆ·',
                            avatar: res.userInfo.avatarUrl || '',
                            isWechat: true
                        });
                    },
                    fail: function(err) {
                        showDebug('å¾®ä¿¡æˆæƒå¤±è´¥: ' + JSON.stringify(err));
                        // æˆæƒå¤±è´¥æ—¶ä½¿ç”¨ä¸´æ—¶èº«ä»½
                        resolve({
                            openid: generateTempOpenid(),
                            nickname: 'å¾®ä¿¡ç”¨æˆ·',
                            isTemporary: true
                        });
                    }
                });
            });
            
            wx.error(function(err) {
                showDebug('å¾®ä¿¡JS-SDKé”™è¯¯: ' + JSON.stringify(err));
                // JS-SDKé”™è¯¯æ—¶ä½¿ç”¨ä¸´æ—¶èº«ä»½
                resolve({
                    openid: generateTempOpenid(),
                    nickname: 'å¾®ä¿¡ç”¨æˆ·',
                    isTemporary: true
                });
            });
            
        } else {
            showDebug('éå¾®ä¿¡ç¯å¢ƒæˆ–JS-SDKåŠ è½½å¤±è´¥');
            // éå¾®ä¿¡ç¯å¢ƒä½¿ç”¨ä¸´æ—¶èº«ä»½
            resolve({
                openid: generateTempOpenid(),
                nickname: 'ç½‘é¡µç”¨æˆ·',
                isTemporary: true
            });
        }
    });
}

// ç»‘å®šå·¥ç¨‹å¸ˆèº«ä»½
async function bindEngineer(engineerName, userInfo) {
    try {
        showDebug('å¼€å§‹ç»‘å®šå·¥ç¨‹å¸ˆèº«ä»½...');
        
        const engineerData = {
            name: engineerName,
            openid: userInfo.openid,
            nickname: userInfo.nickname,
            avatar: userInfo.avatar || '',
            bind_time: new Date().toISOString(),
            bind_type: userInfo.isWechat ? 'wechat' : (userInfo.isSimple ? 'simple' : 'temporary')
        };

        showDebug('æäº¤æ•°æ®åˆ°Supabase...');
        
        const response = await fetch('https://ynkmlbczkcporjdpawbr.supabase.co/rest/v1/engineers', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inlua21sYmN6a2Nwb3JqZHBhd2JyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI4NDcwMjUsImV4cCI6MjA3ODQyMzAyNX0.6tkS9oBrg3_1tGzSXQZygZv_KpC-x97B_1r39lgBTGY',
                'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inlua21sYmN6a2Nwb3JqZHBhd2JyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI4NDcwMjUsImV4cCI6MjA3ODQyMzAyNX0.6tkS9oBrg3_1tGzSXQZygZv_KpC-x97B_1r39lgBTGY',
                'Prefer': 'return=representation'
            },
            body: JSON.stringify(engineerData)
        });

        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`HTTP ${response.status}: ${errorText}`);
        }

        const result = await response.json();
        showDebug('ç»‘å®šæˆåŠŸï¼');
        
        // æ˜¾ç¤ºæˆåŠŸé¡µé¢
        document.getElementById('engineerName').textContent = engineerName;
        document.getElementById('engineerOpenid').textContent = `æ ‡è¯†: ${userInfo.openid.substring(0, 10)}...`;
        showState('success');
        
        return result;
    } catch (error) {
        console.error('ç»‘å®šå·¥ç¨‹å¸ˆå¤±è´¥:', error);
        showErrorDebug('ç»‘å®šå¤±è´¥: ' + error.message);
        
        // å³ä½¿ç»‘å®šå¤±è´¥ï¼Œä¹Ÿæ˜¾ç¤ºæˆåŠŸï¼ˆå› ä¸ºå¯èƒ½æ˜¯é‡å¤ç»‘å®šï¼‰
        if (error.message.includes('duplicate key') || error.message.includes('23505')) {
            showDebug('å·¥ç¨‹å¸ˆå·²å­˜åœ¨ï¼Œè§†ä¸ºç»‘å®šæˆåŠŸ');
            document.getElementById('engineerName').textContent = engineerName;
            document.getElementById('engineerOpenid').textContent = `æ ‡è¯†: ${userInfo.openid.substring(0, 10)}...`;
            showState('success');
        } else {
            showError('ç»‘å®šå¤±è´¥: ' + error.message);
        }
        
        throw error;
    }
}

// ä¸»åˆå§‹åŒ–å‡½æ•°
async function init() {
    const params = getUrlParams();
    showDebug(`å·¥ç¨‹å¸ˆå§“å: ${params.engineer_name}`);
    showDebug('å¼€å§‹èº«ä»½ç»‘å®šæµç¨‹...');

    try {
        // è·å–ç”¨æˆ·ä¿¡æ¯
        showDebug('æ­¥éª¤1: è·å–ç”¨æˆ·èº«ä»½ä¿¡æ¯...');
        const userInfo = await simpleWechatLogin();
        showDebug(`è¯†åˆ«åˆ°ç”¨æˆ·: ${userInfo.nickname}`);
        
        // ç»‘å®šå·¥ç¨‹å¸ˆ
        showDebug('æ­¥éª¤2: ç»‘å®šå·¥ç¨‹å¸ˆèº«ä»½...');
        await bindEngineer(params.engineer_name, userInfo);
        
    } catch (error) {
        console.error('åˆå§‹åŒ–å¤±è´¥:', error);
        showErrorDebug('å®Œæ•´é”™è¯¯: ' + error.message);
        showError('èº«ä»½ç»‘å®šå¤±è´¥ï¼Œè¯·å°è¯•å…¶ä»–æ–¹å¼');
    }
}

// é¡µé¢åŠ è½½æ—¶å¯åŠ¨
document.addEventListener('DOMContentLoaded', function() {
    showDebug('é¡µé¢åŠ è½½å®Œæˆ...');
    showDebug('ç”¨æˆ·ä»£ç†: ' + navigator.userAgent);
    setTimeout(init, 500);
});

// æ·»åŠ é”™è¯¯ç›‘å¬
window.addEventListener('error', function(e) {
    showErrorDebug('å…¨å±€é”™è¯¯: ' + e.message);
});
</script>
</body>
</html>
