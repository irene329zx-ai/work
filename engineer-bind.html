<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å·¥ç¨‹å¸ˆèº«ä»½ç»‘å®š</title>
    <script src="https://res.wx.qq.com/open/js/jweixin-1.6.0.js"></script>
    <style>
        body {
            font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .card {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            text-align: center;
            max-width: 400px;
            width: 100%;
        }
        .icon {
            font-size: 60px;
            margin-bottom: 20px;
        }
        .success { color: #4CAF50; }
        .error { color: #e74c3c; }
        .loading { color: #3498db; }
        h1 { color: #333; margin-bottom: 15px; }
        .info { 
            background: #f8f9fa; 
            padding: 15px; 
            border-radius: 8px; 
            margin: 15px 0;
            text-align: left;
        }
        .debug {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            border-radius: 5px;
            margin-top: 15px;
            font-size: 12px;
            text-align: left;
            display: none;
        }
        button {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px;
        }
        .retry-btn { background: #e74c3c; }
    </style>
</head>
<body>
    <div class="card">
        <div id="loadingState">
            <div class="icon loading">â³</div>
            <h1>èº«ä»½ç»‘å®šä¸­...</h1>
            <p>æ­£åœ¨è·å–æ‚¨çš„å¾®ä¿¡èº«ä»½ä¿¡æ¯</p>
            <div class="debug" id="loadingDebug"></div>
        </div>

        <div id="successState" style="display: none;">
            <div class="icon success">âœ…</div>
            <h1>ç»‘å®šæˆåŠŸ</h1>
            <div class="info">
                <div style="font-size: 18px; font-weight: bold;" id="engineerName">--</div>
                <div style="color: #666;" id="engineerOpenid">OpenID: --</div>
            </div>
            <p style="color: #999;">æ‚¨ç°åœ¨å¯ä»¥æ‰«æå‘˜å·¥äºŒç»´ç è¿›è¡Œè€ƒå‹¤ç™»è®°äº†</p>
            <button onclick="closeWindow()">å…³é—­é¡µé¢</button>
        </div>

        <div id="errorState" style="display: none;">
            <div class="icon error">âŒ</div>
            <h1>ç»‘å®šå¤±è´¥</h1>
            <p id="errorMessage">ç³»ç»Ÿé”™è¯¯</p>
            <div class="debug" id="errorDebug"></div>
            <div>
                <button onclick="retryBind()">é‡è¯•</button>
                <button class="retry-btn" onclick="useSimpleBind()">ä½¿ç”¨ç®€åŒ–ç»‘å®š</button>
            </div>
        </div>

        <!-- ç®€åŒ–ç»‘å®šè¡¨å• -->
        <div id="simpleBindState" style="display: none;">
            <div class="icon loading">ğŸ‘¤</div>
            <h1>æ‰‹åŠ¨èº«ä»½ç»‘å®š</h1>
            <div class="info">
                <p>ç”±äºå¾®ä¿¡æˆæƒé™åˆ¶ï¼Œè¯·æ‰‹åŠ¨è¾“å…¥æ‚¨çš„ä¿¡æ¯ï¼š</p>
                <input type="text" id="manualName" placeholder="è¯·è¾“å…¥æ‚¨çš„å§“å" style="width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 5px;">
                <input type="text" id="manualPhone" placeholder="è¯·è¾“å…¥æ‰‹æœºå·ï¼ˆå¯é€‰ï¼‰" style="width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 5px;">
            </div>
            <div>
                <button onclick="submitManualBind()">ç¡®è®¤ç»‘å®š</button>
                <button class="retry-btn" onclick="retryBind()">é‡æ–°å°è¯•å¾®ä¿¡ç»‘å®š</button>
            </div>
        </div>
    </div>

<script>
// æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯
function showDebug(elementId, message) {
    console.log('DEBUG:', message);
    const element = document.getElementById(elementId);
    if (element) {
        element.style.display = 'block';
        element.innerHTML += message + '<br>';
    }
}

// è·å–URLå‚æ•°
function getUrlParams() {
    const params = new URLSearchParams(window.location.search);
    return {
        engineer_name: params.get('engineer_name')
    };
}

// æ˜¾ç¤ºçŠ¶æ€
function showState(state) {
    document.getElementById('loadingState').style.display = 'none';
    document.getElementById('successState').style.display = 'none';
    document.getElementById('errorState').style.display = 'none';
    document.getElementById('simpleBindState').style.display = 'none';
    document.getElementById(state + 'State').style.display = 'block';
}

// æ˜¾ç¤ºé”™è¯¯
function showError(message) {
    document.getElementById('errorMessage').textContent = message;
    showState('error');
}

// å…³é—­çª—å£
function closeWindow() {
    try {
        if (typeof WeixinJSBridge !== "undefined") {
            WeixinJSBridge.call('closeWindow');
        } else {
            window.close();
        }
    } catch (e) {
        // å¦‚æœæ— æ³•å…³é—­ï¼Œæ˜¾ç¤ºæç¤º
        document.getElementById('successState').innerHTML += 
            '<p style="color: #999; margin-top: 10px;">è¯·æ‰‹åŠ¨å…³é—­æ­¤é¡µé¢</p>';
    }
}

// é‡è¯•ç»‘å®š
function retryBind() {
    showState('loading');
    document.getElementById('errorDebug').innerHTML = '';
    setTimeout(init, 500);
}

// ä½¿ç”¨ç®€åŒ–ç»‘å®š
function useSimpleBind() {
    showState('simpleBindState');
    const params = getUrlParams();
    if (params.engineer_name) {
        document.getElementById('manualName').value = params.engineer_name;
    }
}

// ç”Ÿæˆå”¯ä¸€ID
function generateUniqueId() {
    return 'eng_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now();
}

// è·å–è®¾å¤‡æŒ‡çº¹ï¼ˆç®€åŒ–ç‰ˆOpenIDï¼‰
function getDeviceFingerprint() {
    // ä½¿ç”¨å¤šç§ä¿¡æ¯ç”Ÿæˆè®¾å¤‡æŒ‡çº¹
    const fingerprint = {
        userAgent: navigator.userAgent,
        language: navigator.language,
        platform: navigator.platform,
        hardwareConcurrency: navigator.hardwareConcurrency || 'unknown',
        deviceMemory: navigator.deviceMemory || 'unknown',
        timezone: Intl.DateTimeFormat().resolvedOptions().timeZone
    };
    
    // ç”Ÿæˆç®€å•å“ˆå¸Œ
    const str = JSON.stringify(fingerprint);
    let hash = 0;
    for (let i = 0; i < str.length; i++) {
        const char = str.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash; // Convert to 32bit integer
    }
    return 'device_' + Math.abs(hash).toString(36);
}

// å°è¯•å¾®ä¿¡JS-SDKæˆæƒ
async function tryWechatAuth() {
    return new Promise((resolve, reject) => {
        // æ£€æŸ¥æ˜¯å¦åœ¨å¾®ä¿¡ç¯å¢ƒä¸­
        if (!navigator.userAgent.includes('MicroMessenger')) {
            reject(new Error('éå¾®ä¿¡ç¯å¢ƒ'));
            return;
        }

        showDebug('loadingDebug', 'æ£€æµ‹åˆ°å¾®ä¿¡ç¯å¢ƒï¼Œå°è¯•åˆå§‹åŒ–JS-SDK...');

        // ç”±äºå¾®ä¿¡JS-SDKéœ€è¦åç«¯ç­¾åï¼Œè¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ç®€åŒ–æ–¹æ¡ˆ
        // åœ¨å®é™…é¡¹ç›®ä¸­ï¼Œä½ éœ€è¦ä¸€ä¸ªåç«¯APIæ¥ç”Ÿæˆç­¾å
        
        wx.ready(function() {
            showDebug('loadingDebug', 'å¾®ä¿¡JS-SDKå‡†å¤‡å°±ç»ª');
            
            // å°è¯•è·å–ç”¨æˆ·ä¿¡æ¯ï¼ˆéœ€è¦ç”¨æˆ·æˆæƒï¼‰
            wx.getUserInfo({
                success: function(res) {
                    showDebug('loadingDebug', 'è·å–ç”¨æˆ·ä¿¡æ¯æˆåŠŸ');
                    const userInfo = res.userInfo;
                    resolve({
                        openid: generateUniqueId(), // å®é™…é¡¹ç›®ä¸­åº”è¯¥ç”¨çœŸå®çš„openid
                        nickname: userInfo.nickName,
                        avatar: userInfo.avatarUrl,
                        gender: userInfo.gender,
                        province: userInfo.province,
                        city: userInfo.city,
                        source: 'wechat'
                    });
                },
                fail: function(err) {
                    showDebug('loadingDebug', 'è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥: ' + JSON.stringify(err));
                    // ç”¨æˆ·æ‹’ç»æˆæƒæˆ–å…¶ä»–é”™è¯¯ï¼Œä½¿ç”¨è®¾å¤‡æŒ‡çº¹
                    resolve({
                        openid: getDeviceFingerprint(),
                        nickname: 'å¾®ä¿¡ç”¨æˆ·',
                        avatar: '',
                        source: 'device_fingerprint',
                        isTemporary: true
                    });
                }
            });
        });

        wx.error(function(err) {
            showDebug('loadingDebug', 'å¾®ä¿¡JS-SDKåˆå§‹åŒ–å¤±è´¥: ' + JSON.stringify(err));
            reject(new Error('å¾®ä¿¡æˆæƒåˆå§‹åŒ–å¤±è´¥'));
        });

        // è®¾ç½®è¶…æ—¶
        setTimeout(() => {
            reject(new Error('å¾®ä¿¡æˆæƒè¶…æ—¶'));
        }, 10000);
    });
}

// ç»‘å®šå·¥ç¨‹å¸ˆèº«ä»½
async function bindEngineer(engineerName, userInfo) {
    try {
        showDebug('loadingDebug', 'å¼€å§‹ç»‘å®šå·¥ç¨‹å¸ˆèº«ä»½...');

        const engineerData = {
            openid: userInfo.openid,
            name: engineerName,
            nickname: userInfo.nickname || engineerName,
            avatar: userInfo.avatar || '',
            bind_time: new Date().toISOString(),
            source: userInfo.source || 'unknown',
            is_temporary: userInfo.isTemporary || false
        };

        showDebug('loadingDebug', 'æäº¤æ•°æ®: ' + JSON.stringify(engineerData));

        const response = await fetch('https://ynkmlbczkcporjdpawbr.supabase.co/rest/v1/engineers', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inlua21sYmN6a2Nwb3JqZHBhd2JyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI4NDcwMjUsImV4cCI6MjA3ODQyMzAyNX0.6tkS9oBrg3_1tGzSXQZygZv_KpC-x97B_1r39lgBTGY',
                'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inlua21sYmN6a2Nwb3JqZHBhd2JyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI4NDcwMjUsImV4cCI6MjA3ODQyMzAyNX0.6tkS9oBrg3_1tGzSXQZygZv_KpC-x97B_1r39lgBTGY',
                'Prefer': 'return=representation'
            },
            body: JSON.stringify(engineerData)
        });

        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`HTTP ${response.status}: ${errorText}`);
        }

        const result = await response.json();
        showDebug('loadingDebug', 'ç»‘å®šæˆåŠŸ: ' + JSON.stringify(result));
        return result;

    } catch (error) {
        throw new Error('ç»‘å®šå·¥ç¨‹å¸ˆå¤±è´¥: ' + error.message);
    }
}

// æäº¤æ‰‹åŠ¨ç»‘å®š
async function submitManualBind() {
    const manualName = document.getElementById('manualName').value.trim();
    const manualPhone = document.getElementById('manualPhone').value.trim();
    
    if (!manualName) {
        alert('è¯·è¾“å…¥å§“å');
        return;
    }

    showState('loading');
    
    const userInfo = {
        openid: generateUniqueId(),
        nickname: manualName,
        phone: manualPhone,
        source: 'manual',
        isTemporary: false
    };

    try {
        const result = await bindEngineer(manualName, userInfo);
        showSuccess(manualName, userInfo.openid);
    } catch (error) {
        console.error('æ‰‹åŠ¨ç»‘å®šå¤±è´¥:', error);
        showError(error.message);
    }
}

// æ˜¾ç¤ºæˆåŠŸ
function showSuccess(name, openid) {
    document.getElementById('engineerName').textContent = name;
    document.getElementById('engineerOpenid').textContent = `èº«ä»½ID: ${openid.substring(0, 10)}...`;
    showState('success');
    
    // 3ç§’åè‡ªåŠ¨å…³é—­
    setTimeout(closeWindow, 3000);
}

// ä¸»åˆå§‹åŒ–å‡½æ•°
async function init() {
    const params = getUrlParams();
    
    if (!params.engineer_name) {
        showError('ç¼ºå°‘å·¥ç¨‹å¸ˆå§“åå‚æ•°');
        return;
    }

    showDebug('loadingDebug', `å¼€å§‹ç»‘å®šå·¥ç¨‹å¸ˆ: ${params.engineer_name}`);

    try {
        // å°è¯•å¾®ä¿¡æˆæƒ
        showDebug('loadingDebug', 'å°è¯•å¾®ä¿¡æˆæƒ...');
        const userInfo = await tryWechatAuth();
        
        showDebug('loadingDebug', `æˆæƒæˆåŠŸ: ${userInfo.nickname}`);
        
        // ç»‘å®šå·¥ç¨‹å¸ˆèº«ä»½
        const result = await bindEngineer(params.engineer_name, userInfo);
        
        // æ˜¾ç¤ºæˆåŠŸ
        showSuccess(params.engineer_name, userInfo.openid);
        
    } catch (error) {
        console.error('ç»‘å®šå¤±è´¥:', error);
        showDebug('errorDebug', 'è¯¦ç»†é”™è¯¯: ' + error.message);
        showDebug('errorDebug', 'ç”¨æˆ·ä»£ç†: ' + navigator.userAgent);
        
        if (error.message.includes('å¾®ä¿¡') || error.message.includes('éå¾®ä¿¡ç¯å¢ƒ')) {
            showError('å¾®ä¿¡æˆæƒå¤±è´¥ï¼Œè¯·ä½¿ç”¨æ‰‹åŠ¨ç»‘å®š');
        } else {
            showError('ç»‘å®šå¤±è´¥: ' + error.message);
        }
    }
}

// é…ç½®å¾®ä¿¡JS-SDKï¼ˆç®€åŒ–ç‰ˆï¼‰
function configureWechatSDK() {
    // è¿™é‡Œåº”è¯¥æ˜¯ä»åç«¯è·å–çš„é…ç½®ï¼Œç°åœ¨ä½¿ç”¨ç®€åŒ–ç‰ˆæœ¬
    wx.config({
        debug: false,
        appId: '', // éœ€è¦å¡«å†™ä½ çš„å…¬ä¼—å·AppID
        timestamp: Math.floor(Date.now() / 1000),
        nonceStr: 'noncestr' + Math.random().toString(36).substr(2),
        signature: '', // å®é™…é¡¹ç›®ä¸­éœ€è¦åç«¯ç”Ÿæˆ
        jsApiList: [
            'checkJsApi',
            'getNetworkType',
            'getLocation',
            'chooseImage',
            'previewImage',
            'uploadImage',
            'downloadImage',
            'getLocalImgData',
            'startRecord',
            'stopRecord',
            'onVoiceRecordEnd',
            'playVoice',
            'pauseVoice',
            'stopVoice',
            'onVoicePlayEnd',
            'uploadVoice',
            'downloadVoice',
            'translateVoice',
            'openLocation',
            'getLocation',
            'hideOptionMenu',
            'showOptionMenu',
            'hideMenuItems',
            'showMenuItems',
            'hideAllNonBaseMenuItem',
            'showAllNonBaseMenuItem',
            'closeWindow',
            'scanQRCode',
            'chooseWXPay',
            'openProductSpecificView',
            'addCard',
            'chooseCard',
            'openCard',
            'openAddress',
            'getWeRunData',
            'startSearchBeacons',
            'stopSearchBeacons',
            'onSearchBeacons',
            'openEnterpriseChat',
            'openEnterpriseRedPacket',
            'startRecord',
            'stopRecord',
            'onVoiceRecordEnd',
            'playVoice',
            'pauseVoice',
            'stopVoice',
            'onVoicePlayEnd',
            'uploadVoice',
            'downloadVoice',
            'translateVoice',
            'openLocation',
            'getLocation',
            'getUserInfo' // ç¡®ä¿åŒ…å«è¿™ä¸ª
        ]
    });
}

// é¡µé¢åŠ è½½æ—¶å¯åŠ¨
document.addEventListener('DOMContentLoaded', function() {
    showDebug('loadingDebug', 'é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–...');
    
    // é…ç½®å¾®ä¿¡JS-SDK
    configureWechatSDK();
    
    // å»¶è¿Ÿåˆå§‹åŒ–ï¼Œç¡®ä¿å¾®ä¿¡SDKåŠ è½½å®Œæˆ
    setTimeout(init, 1000);
});
</script>
</body>
</html>
