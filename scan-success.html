<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‰«ç è€ƒå‹¤</title>
    <style>
        body {
            font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh; /* ç¡®ä¿å æ»¡æ•´ä¸ªè§†å£ */
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .card {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            text-align: center;
            max-width: 400px;
            width: 100%;
        }
        .icon {
            font-size: 60px;
            margin-bottom: 20px;
        }
        .success { color: #4CAF50; }
        .error { color: #e74c3c; }
        .loading { color: #3498db; }
        .input-icon { color: #f39c12; } /* æ–°å¢è¾“å…¥çŠ¶æ€å›¾æ ‡é¢œè‰² */
        h1 { color: #333; margin-bottom: 15px; }
        .info { background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 15px 0; }
        .debug { 
            background: #fff3cd; 
            border: 1px solid #ffeaa7; 
            padding: 10px; 
            border-radius: 5px; 
            margin-top: 15px;
            font-size: 12px;
            text-align: left;
            display: none;
        }
        button {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .retry-btn { background: #e74c3c; }
        
        /* æ–°å¢ï¼šä¸‹å·¥çŠ¶æ€æç¤ºæ¡†æ ·å¼ */
        .stop-work-prompt {
            background: #ffeaa7;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #f39c12;
            text-align: left;
        }
        .stop-work-prompt p { margin: 5px 0; }
    </style>
</head>
<body>
    <div class="card">
        <div id="loadingState">
            <div class="icon loading">â³</div>
            <h1>å¤„ç†ä¸­...</h1>
            <p>æ­£åœ¨è®°å½•è€ƒå‹¤ä¿¡æ¯</p>
            <div class="debug" id="loadingDebug"></div>
        </div>
        
        <div id="stopWorkState" style="display: none;">
            <div class="icon input-icon">ğŸ›‘</div>
            <h1>ä¸‹å·¥ç¡®è®¤</h1>
            <div class="stop-work-prompt">
                <p><strong><span id="workerNameStop">--</span></strong> æ­£åœ¨å·¥ä½œä¸­ã€‚</p>
                <p style="font-size: 14px; margin-top: 10px;">
                    ä¸Šæ¬¡ä¸Šå·¥åœ°ç‚¹ï¼š<span id="lastLocation">N/A</span><br>
                    ä¸Šæ¬¡ä¸Šå·¥å·¥ç§ï¼š<span id="lastWorkType">N/A</span>
                </p>
            </div>
            <p>æ˜¯å¦ç¡®è®¤**ä¸‹å·¥**ï¼Ÿ</p>
            <button id="confirmStopWork" class="retry-btn">ç¡®è®¤ä¸‹å·¥</button>
            <div class="debug" id="stopWorkDebug"></div>
        </div>
        
        <div id="inputState" style="display: none;">
            <div class="icon input-icon">ğŸ“</div>
            <h1>å¡«å†™è€ƒå‹¤ä¿¡æ¯ (ä¸Šå·¥)</h1>
            <p>è¯·ä¸º <span id="workerNameInput" style="font-weight: bold;">--</span> å¡«å†™ç”¨å·¥åœ°ç‚¹å’Œå·¥ç§ã€‚</p>
            
            <div style="text-align: left; margin: 20px 0;">
                <label for="workLocation" style="font-weight: bold; display: block; margin-bottom: 5px;">ç”¨å·¥åœ°ç‚¹ï¼š</label>
                <input type="text" id="workLocation" placeholder="ä¾‹ï¼šAåŒºä¸»ä½“ç»“æ„" required style="width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 5px;">
                
                <label for="workType" style="font-weight: bold; display: block; margin-bottom: 5px;">å·¥ç§ï¼š</label>
                <input type="text" id="workType" placeholder="ä¾‹ï¼šç”µç„Šå·¥" required style="width: 100%; padding: 10px; margin-bottom: 20px; border: 1px solid #ddd; border-radius: 5px;">
            </div>
            
            <button id="submitAttendance">æäº¤ä¸Šå·¥</button>
            <div class="debug" id="inputDebug"></div>
        </div>

        <div id="successState" style="display: none;">
            <div class="icon success">âœ…</div>
            <h1>è€ƒå‹¤æˆåŠŸ</h1>
            <div class="info">
                <div style="font-size: 18px; font-weight: bold;" id="successName">--</div>
                <div style="color: #666;" id="successId">å·¥å·: --</div>
                <div style="color: #3498db; margin-top: 8px;">åœ°ç‚¹: <span id="successLocation"></span> | å·¥ç§: <span id="successWorkType"></span></div>
            </div>
            <p id="successTime"></p>
            <p style="color: #999; font-size: 14px;" id="closeInfo"></p>
            <div class="debug" id="successDebug"></div>
        </div>

        <div id="errorState" style="display: none;">
            <div class="icon error">âŒ</div>
            <h1>è€ƒå‹¤å¤±è´¥</h1>
            <p id="errorMessage">ç³»ç»Ÿé”™è¯¯</p>
            <div>
                <button onclick="retry()">é‡è¯•</button>
            </div>
            <div class="debug" id="errorDebug"></div>
        </div>
    </div>

<script>
// å…¨å±€å˜é‡ï¼Œç”¨äºå­˜å‚¨ç”¨æˆ·è¾“å…¥çš„åœ°ç‚¹å’Œå·¥ç§
let globalLocation = '';
let globalWorkType = '';
let supabaseInstance = null; // å­˜å‚¨ Supabase å®¢æˆ·ç«¯å®ä¾‹

// ç›´æ¥ä»URLè·å–å‚æ•°
function getUrlParams() {
    const params = new URLSearchParams(window.location.search);
    return {
        id: params.get('id'),
        name: params.get('name') || 'å‘˜å·¥'
    };
}

// è·å–æ‰«æè€…ID
function getScannerIdFromLocal() {
    return localStorage.getItem('active_scanner_id');
}

// æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯
function showDebug(elementId, message) {
    console.log('DEBUG:', message);
    const element = document.getElementById(elementId);
    if (element) {
        element.style.display = 'block';
        element.innerHTML += message + '<br>';
    }
}

// åˆå§‹åŒ–Supabaseå®¢æˆ·ç«¯
function initializeSupabase() {
    if (supabaseInstance) return supabaseInstance;

    const supabaseUrl = 'https://ynkmlbczkcporjdpawbr.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inlua21sYmN6a2Nwb3JqZHBhd2JyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI4NDcwMjUsImV4cCI6MjA3ODQyMzAyNX0.6tkS9oBrg3_1tGzSXQZygZv_KpC-x97B_1r39lgBTGY';
    supabaseInstance = window.supabase.createClient(supabaseUrl, supabaseKey);
    return supabaseInstance;
}

// NOTE: å¤‡ç”¨æ–¹æ¡ˆå‡½æ•° fallbackToRestAPI å·²è¢«ç§»é™¤

// æ˜¾ç¤ºæˆåŠŸé¡µé¢
function showSuccess(name, id, location, workType, action = '') {
    document.getElementById('loadingState').style.display = 'none';
    document.getElementById('inputState').style.display = 'none'; 
    document.getElementById('stopWorkState').style.display = 'none';
    document.getElementById('errorState').style.display = 'none';
    document.getElementById('successState').style.display = 'block';
    
    document.getElementById('successName').textContent = name;
    document.getElementById('successId').textContent = `å·¥å·: ${id}`;
    document.getElementById('successLocation').textContent = location;
    document.getElementById('successWorkType').textContent = workType;
    
    if (action) {
        document.getElementById('successTime').textContent = `${action}æˆåŠŸ - æ—¶é—´: ${new Date().toLocaleString('zh-CN')}`;
    } else {
        document.getElementById('successTime').textContent = `æ—¶é—´: ${new Date().toLocaleString('zh-CN')}`;
    }
    
    document.getElementById('closeInfo').textContent = 'èº«ä»½å·²ä¿ç•™ã€‚è¯·æ‰‹åŠ¨é€€å‡ºæ­¤é¡µé¢ï¼Œæ‰«æä¸‹ä¸€ä½å·¥äººã€‚'; 
    
    setTimeout(() => {
        try { 
            document.getElementById('closeInfo').textContent = 'èº«ä»½å·²ä¿ç•™ã€‚è¯·æ‰‹åŠ¨é€€å‡ºæ­¤é¡µé¢ï¼Œæ‰«æä¸‹ä¸€ä½å·¥äººã€‚';
        } 
        catch (e) { 
            document.getElementById('closeInfo').textContent = 'èº«ä»½å·²ä¿ç•™ã€‚è¯·æ‰‹åŠ¨é€€å‡ºæ­¤é¡µé¢ï¼Œæ‰«æä¸‹ä¸€ä½å·¥äººã€‚';
        }
    }, 3000);
}

// æ˜¾ç¤ºé”™è¯¯é¡µé¢
function showError(title, message) {
    document.getElementById('loadingState').style.display = 'none';
    document.getElementById('inputState').style.display = 'none'; 
    document.getElementById('stopWorkState').style.display = 'none';
    document.getElementById('successState').style.display = 'none';
    document.getElementById('errorState').style.display = 'block';
    
    const errorContainer = document.getElementById('errorState').querySelector('div');
    
    if (message) {
         document.getElementById('errorMessage').innerHTML = `<strong>${title}</strong><br><br>${message}`;
    } else {
         document.getElementById('errorMessage').textContent = title;
    }

    if (title.includes('è®¤è¯èº«ä»½')) {
        errorContainer.innerHTML = 
            '<p style="margin-top: 15px; font-weight: bold; color: #7f8c8d;">å®Œæˆè®¤è¯åè¯·é‡æ–°æ‰«æå·¥äººäºŒç»´ç ã€‚</p>';
    } else {
        // ä»…æ˜¾ç¤ºé‡è¯•æŒ‰é’®
        errorContainer.innerHTML = 
            `<div>
                <button onclick="retry()">é‡è¯•</button>
            </div>`;
    }
}

// å±•ç¤ºä¸‹å·¥ç¡®è®¤ç•Œé¢
function showStopWorkState(name, id, location, workType) {
    document.getElementById('loadingState').style.display = 'none';
    document.getElementById('inputState').style.display = 'none';
    document.getElementById('errorState').style.display = 'none';
    document.getElementById('successState').style.display = 'none';
    
    const stopWorkState = document.getElementById('stopWorkState');
    stopWorkState.style.display = 'block';
    document.getElementById('workerNameStop').textContent = name;
    document.getElementById('lastLocation').textContent = location || 'ï¼ˆè®°å½•ç¼ºå¤±ï¼‰';
    document.getElementById('lastWorkType').textContent = workType || 'ï¼ˆè®°å½•ç¼ºå¤±ï¼‰';
    
    // å°†åœ°ç‚¹å’Œå·¥ç§å­˜å‚¨ä¸ºå…¨å±€å˜é‡ï¼Œä¾›è€ƒå‹¤è®°å½•ä½¿ç”¨
    globalLocation = location;
    globalWorkType = workType;
    
    // ç»‘å®šç¡®è®¤ä¸‹å·¥æŒ‰é’®äº‹ä»¶
    document.getElementById('confirmStopWork').onclick = async () => {
        // åˆ‡æ¢å›åŠ è½½çŠ¶æ€
        stopWorkState.style.display = 'none';
        document.getElementById('loadingState').style.display = 'block';
        
        // æ‰§è¡Œè€ƒå‹¤è®°å½•
        const params = getUrlParams();
        
        // ä¼ å…¥ä¸‹å·¥æ—¶æ‰€éœ€çš„åœ°ç‚¹å’Œå·¥ç§ï¼ˆä»ä¸Šæ¬¡ä¸Šå·¥è®°å½•ä¸­è·å–ï¼‰
        const workStatusResult = await recordAttendance(params.id, params.name, globalLocation, globalWorkType);

        if (workStatusResult && workStatusResult.action) {
            showSuccess(params.name, params.id, globalLocation, globalWorkType, workStatusResult.action);
        } else {
            // ç§»é™¤å¤‡ç”¨æ–¹æ¡ˆçš„æç¤º
            showError('è€ƒå‹¤è®°å½•å¤±è´¥', 'è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•ã€‚');
        }
    };
}

// å±•ç¤ºè¾“å…¥ç•Œé¢ (ä»…ç”¨äºä¸Šå·¥)
function showInputState(name, id) {
    document.getElementById('loadingState').style.display = 'none';
    document.getElementById('stopWorkState').style.display = 'none';
    document.getElementById('errorState').style.display = 'none';
    document.getElementById('successState').style.display = 'none';
    
    const inputState = document.getElementById('inputState');
    inputState.style.display = 'block';
    document.getElementById('workerNameInput').textContent = name;
    
    // ç»‘å®šæäº¤æŒ‰é’®äº‹ä»¶
    document.getElementById('submitAttendance').onclick = async () => {
        const locationInput = document.getElementById('workLocation');
        const workTypeInput = document.getElementById('workType');
        
        globalLocation = locationInput.value.trim();
        globalWorkType = workTypeInput.value.trim();
        
        if (!globalLocation || !globalWorkType) {
            alert('ç”¨å·¥åœ°ç‚¹å’Œå·¥ç§ä¸èƒ½ä¸ºç©ºï¼');
            locationInput.focus();
            return;
        }
        
        // åˆ‡æ¢å›åŠ è½½çŠ¶æ€
        document.getElementById('inputState').style.display = 'none';
        document.getElementById('loadingState').style.display = 'block';
        
        // æ‰§è¡Œè€ƒå‹¤è®°å½• (ä¸Šå·¥)
        const params = getUrlParams();
        const workStatusResult = await recordAttendance(params.id, params.name, globalLocation, globalWorkType);

        if (workStatusResult && workStatusResult.action) {
            showSuccess(params.name, params.id, globalLocation, globalWorkType, workStatusResult.action);
        } else {
            // ç§»é™¤å¤‡ç”¨æ–¹æ¡ˆçš„æç¤º
            showError('è€ƒå‹¤è®°å½•å¤±è´¥', 'è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•ã€‚');
        }
    };
}


// é‡è¯•å‡½æ•° (å›åˆ° init é‡æ–°æ£€æµ‹çŠ¶æ€)
function retry() {
    document.getElementById('errorState').style.display = 'none';
    
    // é‡ç½®å…¨å±€å˜é‡
    globalLocation = '';
    globalWorkType = '';
    document.getElementById('errorDebug').innerHTML = '';

    // é‡æ–°å¯åŠ¨æµç¨‹
    init();
}

// NOTE: useFallback() å‡½æ•°å·²ç§»é™¤

// ã€æ–°å¢å‡½æ•°ã€‘è·å–å·¥äººæœ€è¿‘çš„ä¸Šå·¥è®°å½•ï¼ˆç”¨äºä¸‹å·¥æ—¶æ˜¾ç¤ºåœ°ç‚¹å’Œå·¥ç§ï¼‰
async function getLastWorkDetails(employeeId) {
    const supabase = initializeSupabase();
    
    // 1. æŸ¥æ‰¾æœ€æ–°çš„ä¸Šå·¥è®°å½• (action åŒ…å« 'ä¸Šå·¥' çš„å†å²è®°å½•)
    const { data: record, error } = await supabase
        .from('work_records')
        .select('history')
        .eq('employee_id', employeeId)
        .maybeSingle();

    if (error || !record || !record.history || record.history.length === 0) {
        return { location: null, workType: null };
    }

    // 2. éå†å†å²è®°å½•ï¼Œæ‰¾åˆ°æœ€è¿‘çš„ä¸Šå·¥è®°å½•ï¼Œå¹¶ä»ä¸­æå–åœ°ç‚¹å’Œå·¥ç§
    for (let i = record.history.length - 1; i >= 0; i--) {
        const historyItem = record.history[i];
        
        // æ£€æŸ¥ action æ˜¯å¦åŒ…å« "æ‰«ç ä¸Šå·¥" 
        if (historyItem.action.includes('æ‰«ç ä¸Šå·¥')) {
            // æå– [åœ°ç‚¹: X, å·¥ç§: Y] éƒ¨åˆ†
            const match = historyItem.action.match(/\[åœ°ç‚¹: (.*?), å·¥ç§: (.*?)\]/);
            if (match && match.length === 3) {
                return {
                    location: match[1],
                    workType: match[2]
                };
            }
        }
    }
    
    return { location: null, workType: null };
}


// ä¸»åˆå§‹åŒ–å‡½æ•° (å·²ä¿®æ”¹ï¼šæ–°å¢çŠ¶æ€æ£€æµ‹é€»è¾‘)
async function init() {
    const params = getUrlParams();
    showDebug('loadingDebug', `å‘˜å·¥: ${params.name} (${params.id})`);
    
    if (!params.id) {
        showError('æ— æ•ˆçš„äºŒç»´ç ', 'ç¼ºå°‘å‘˜å·¥ä¿¡æ¯ï¼Œè¯·æ£€æŸ¥äºŒç»´ç é“¾æ¥ã€‚');
        return;
    }

    // å¼ºåˆ¶æ£€æŸ¥å·¥ç¨‹å¸ˆèº«ä»½
    const currentScannerId = getScannerIdFromLocal();
    if (!currentScannerId) {
        showError('âš ï¸ è€ƒå‹¤å‰è¯·å…ˆè®¤è¯èº«ä»½ï¼', 'è¯·**å…ˆæ‰«ææ‚¨çš„å·¥ç¨‹å¸ˆèº«ä»½ç **è¿›è¡Œèº«ä»½ç¡®è®¤ï¼Œç„¶åå†æ‰«æå·¥äººäºŒç»´ç ã€‚');
        return;
    }
    showDebug('loadingDebug', `å·²è®¤è¯å·¥ç¨‹å¸ˆID: ${currentScannerId}`);

    try {
        showDebug('loadingDebug', 'æ­£åœ¨åŠ è½½Supabaseåº“...');
        await loadSupabase();
        const supabase = initializeSupabase();
        showDebug('loadingDebug', 'SupabaseåŠ è½½å®Œæˆï¼Œæ£€æµ‹å·¥äººå½“å‰çŠ¶æ€...');

        // 1. è·å–å‘˜å·¥å½“å‰çš„å·¥ä½œçŠ¶æ€
        const { data: currentRecord, error: fetchError } = await supabase
            .from('work_records')
            .select('is_working')
            .eq('employee_id', params.id)
            .maybeSingle();
            
        // å¦‚æœæœ‰ç½‘ç»œé”™è¯¯æˆ– Supabase é”™è¯¯ï¼ŒæŠ›å‡ºå¼‚å¸¸ï¼Œè®© catch å—å¤„ç†
        if (fetchError && fetchError.code !== 'PGRST116') {
             throw new Error("æŸ¥è¯¢çŠ¶æ€å¤±è´¥: " + fetchError.message);
        }

        const isWorking = currentRecord?.is_working || false;
        
        if (isWorking) {
            // çŠ¶æ€ï¼šæ­£åœ¨å·¥ä½œ (æ‰§è¡Œä¸‹å·¥æµç¨‹)
            showDebug('loadingDebug', 'å·¥äººæ­£åœ¨å·¥ä½œä¸­ï¼Œè¿›å…¥ä¸‹å·¥ç¡®è®¤æµç¨‹ã€‚');
            
            // 2. è·å–ä¸Šå·¥æ—¶çš„åœ°ç‚¹å’Œå·¥ç§
            const lastDetails = await getLastWorkDetails(params.id);
            
            // 3. è¿›å…¥ä¸‹å·¥ç¡®è®¤ç•Œé¢ï¼Œå¹¶ä½¿ç”¨ä¸Šå·¥æ—¶çš„åœ°ç‚¹å’Œå·¥ç§ä½œä¸ºä¸‹å·¥è®°å½•
            showStopWorkState(params.name, params.id, lastDetails.location, lastDetails.workType);

        } else {
            // çŠ¶æ€ï¼šæœªå·¥ä½œ (æ‰§è¡Œä¸Šå·¥æµç¨‹)
            showDebug('loadingDebug', 'å·¥äººæœªåœ¨å·¥ä½œï¼Œè¿›å…¥ä¸Šå·¥ä¿¡æ¯å¡«å†™æµç¨‹ã€‚');
            
            // 2. è¿›å…¥ä¸Šå·¥ä¿¡æ¯å¡«å†™ç•Œé¢
            showInputState(params.name, params.id);
        }
        
    } catch (error) {
        console.error('åˆå§‹åŒ–å¤±è´¥:', error);
        showDebug('errorDebug', 'é”™è¯¯è¯¦æƒ…: ' + error.message);
        showError('ç³»ç»ŸåŠ è½½æˆ–çŠ¶æ€æ£€æµ‹å¤±è´¥', 'è¯·æ£€æŸ¥ç½‘ç»œæˆ–è”ç³»ç®¡ç†å‘˜ã€‚');
    }
}

// åŠ¨æ€åŠ è½½Supabase
function loadSupabase() {
    return new Promise((resolve, reject) => {
        // æ£€æŸ¥æ˜¯å¦å·²åŠ è½½
        if (window.supabase) {
            resolve();
            return;
        }

        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2';
        script.onload = () => {
            // ç»™ç‚¹æ—¶é—´è®©åº“åˆå§‹åŒ–
            setTimeout(resolve, 100);
        };
        script.onerror = () => reject(new Error('Failed to load Supabase'));
        document.head.appendChild(script);
    });
}

// è®°å½•è€ƒå‹¤ - æ ¸å¿ƒè®°å½•å‡½æ•°
async function recordAttendance(employeeId, employeeName, location, workType) {
    try {
        const supabase = initializeSupabase();
        const scannerId = getScannerIdFromLocal(); 
        
        showDebug('loadingDebug', `ç”¨å·¥åœ°ç‚¹: ${location}, å·¥ç§: ${workType}`); 
        
        showDebug('loadingDebug', '1. æ’å…¥æ‰«ç è®°å½•...');
        
        // æ„å»ºè®°å½•å¯¹è±¡ - æ¯æ¬¡æ‰«ç éƒ½éœ€è¦è®°å½•åœ°ç‚¹å’Œå·¥ç§ï¼Œç”¨äºæŠ¥è¡¨å»é‡
        const scanRecord = { 
            employee_id: employeeId,
            user_agent: navigator.userAgent,
            scan_time: new Date().toISOString(),
            work_location: location, 
            work_type: workType 
        };
        
        if (scannerId) {
            scanRecord.scanner_id = scannerId;
        }
        
        // 1. æ’å…¥æ‰«ç è®°å½• (åŒ…å«åœ°ç‚¹å’Œå·¥ç§)
        const { data: scanData, error: scanError } = await supabase
            .from('wechat_scans')
            .insert([scanRecord])
            .select();

        if (scanError) {
            showDebug('errorDebug', 'æ‰«ç è®°å½•æ’å…¥å¤±è´¥(ä¸å½±å“è€ƒå‹¤): ' + scanError.message);
        } else {
            showDebug('successDebug', 'æ‰«ç è®°å½•æ’å…¥æˆåŠŸ');
        }

        showDebug('loadingDebug', '2. æ›´æ–°å·¥ä½œçŠ¶æ€...');
        
        // 2. æ›´æ–°å·¥ä½œçŠ¶æ€ï¼ˆè¿™æ˜¯å…³é”®ï¼ï¼‰
        const workStatusResult = await updateWorkStatus(supabase, employeeId, employeeName, scannerId, location, workType); 
        
        if (workStatusResult.success) {
            showDebug('successDebug', `å·¥ä½œçŠ¶æ€æ›´æ–°æˆåŠŸ: ${workStatusResult.action}`);
            return workStatusResult; 
        } else {
            showDebug('errorDebug', 'å·¥ä½œçŠ¶æ€æ›´æ–°å¤±è´¥: ' + workStatusResult.error);
            return false;
        }
        
    } catch (error) {
        showDebug('errorDebug', 'è®°å½•è€ƒå‹¤å¼‚å¸¸: ' + error.message);
        return false;
    }
}

// æ›´æ–°å·¥ä½œçŠ¶æ€ - æ ¸å¿ƒé€»è¾‘ (ä¼˜åŒ–ï¼šä¸‹å·¥æ—¶å†å²è®°å½•ä¸é‡å¤è®°å½•åœ°ç‚¹å·¥ç§)
async function updateWorkStatus(supabase, employeeId, employeeName, scannerId, location, workType) { 
    try {
        // 1. è·å–å‘˜å·¥å½“å‰çš„å·¥ä½œçŠ¶æ€ (é‡æ–°è·å–ï¼Œç¡®ä¿åœ¨è®°å½•å‰çš„æœ€åç¡®è®¤)
        const { data: currentRecord, error: fetchError } = await supabase
            .from('work_records')
            .select('*')
            .eq('employee_id', employeeId)
            .maybeSingle();

        if (fetchError && fetchError.code !== 'PGRST116') {
            throw fetchError;
        }

        const now = new Date().toISOString();
        let action = '';
        let newRecord = {};
        
        const scannerInfo = scannerId ? ` (ç”± ${scannerId} æ‰«æ)` : '';
        let locationInfo = ''; 

        if (currentRecord && currentRecord.is_working) {
            // æƒ…å†µ1ï¼šå‘˜å·¥æ­£åœ¨å·¥ä½œ â†’ æš‚åœå·¥ä½œ (ä¸‹å·¥)
            action = 'ä¸‹å·¥';
            
            // è®¡ç®—æœ¬æ¬¡å·¥ä½œæ—¶é•¿
            const startTime = new Date(currentRecord.start_time).getTime(); 
            const rawDurationMs = Math.max(100, new Date().getTime() - startTime); 
            const workTimeHours = rawDurationMs / (1000 * 60 * 60);

            const fixedWorkTimeHours = parseFloat(workTimeHours.toFixed(4)); 
            const newTotalHours = (parseFloat(currentRecord.total_hours) || 0) + fixedWorkTimeHours;
            
            let newTodayHours = parseFloat(currentRecord.today_hours) || 0;
            if (currentRecord.start_time && new Date().toDateString() === new Date(currentRecord.start_time).toDateString()) {
                newTodayHours += fixedWorkTimeHours;
            } else {
                newTodayHours += fixedWorkTimeHours;
            }
            
            // æ›´æ–°è®°å½•ï¼šæš‚åœå·¥ä½œ
            newRecord = {
                employee_id: employeeId,
                is_working: false,
                start_time: null,
                total_hours: newTotalHours,
                today_hours: newTodayHours,
                last_updated: now,
                history: [
                    ...(currentRecord.history || []),
                    {
                        // ä¸‹å·¥æ—¶ä¸è®°å½•åœ°ç‚¹/å·¥ç§
                        action: `å¾®ä¿¡æ‰«ç ä¸‹å·¥${scannerInfo} - å·¥ä½œæ—¶é•¿: ${fixedWorkTimeHours.toFixed(2)}å°æ—¶`, 
                        timestamp: now
                    }
                ]
            };
            
        } else {
            // æƒ…å†µ2ï¼šå‘˜å·¥æœªå·¥ä½œæˆ–è®°å½•ä¸å­˜åœ¨ï¼ˆå«æ–°å‘˜å·¥ï¼‰ â†’ å¼€å§‹å·¥ä½œ (ä¸Šå·¥)
            action = 'ä¸Šå·¥';
            
            // åªæœ‰ä¸Šå·¥æ—¶æ‰æ„é€ å¹¶è®°å½•åœ°ç‚¹/å·¥ç§ä¿¡æ¯
            locationInfo = location ? ` [åœ°ç‚¹: ${location}, å·¥ç§: ${workType}]` : ''; 

            // åˆ¤æ–­æ˜¯å¦éœ€è¦é‡ç½®ä»Šæ—¥å·¥æ—¶
            let currentTodayHours = currentRecord ? parseFloat(currentRecord.today_hours) : 0;
            if (currentRecord && currentRecord.last_updated) {
                const lastUpdateDate = new Date(currentRecord.last_updated);
                if (new Date().toDateString() !== lastUpdateDate.toDateString()) {
                    currentTodayHours = 0; 
                }
            }
            
            // åˆ›å»ºæˆ–æ›´æ–°è®°å½•ï¼šå¼€å§‹å·¥ä½œ
            newRecord = {
                employee_id: employeeId,
                is_working: true,
                start_time: now,
                total_hours: currentRecord ? parseFloat(currentRecord.total_hours) : 0,
                today_hours: currentTodayHours, 
                last_updated: now,
                history: [
                    ...(currentRecord?.history || []),
                    {
                        // **å…³é”®ï¼š** ä¸Šå·¥æ—¶è®°å½•åœ°ç‚¹å’Œå·¥ç§
                        action: `å¾®ä¿¡æ‰«ç ä¸Šå·¥${scannerInfo}${locationInfo}`,
                        timestamp: now
                    }
                ]
            };
        }
        
        // æ’å…¥æˆ–æ›´æ–°å·¥ä½œè®°å½•
        const { data: workData, error: workError } = await supabase
            .from('work_records')
            .upsert(newRecord, {
                onConflict: 'employee_id',
                ignoreDuplicates: false
            })
            .select();

        if (workError) {
            throw new Error(`å·¥ä½œè®°å½•æ›´æ–°å¤±è´¥: ${workError.message}`);
        }
        
        return {
            success: true,
            action: action,
            data: workData 
        };

    } catch (error) {
        console.error('æ›´æ–°å·¥ä½œçŠ¶æ€å¤±è´¥:', error);
        return {
            success: false,
            error: error.message
        };
    }
}

// é¡µé¢åŠ è½½æ—¶å¯åŠ¨
document.addEventListener('DOMContentLoaded', function() {
    showDebug('loadingDebug', 'é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–...');
    setTimeout(init, 100);
});
</script>
</body>
</html>
