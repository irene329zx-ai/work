<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>扫码成功</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .success-card {
            background: white;
            border-radius: 20px;
            padding: 40px 30px;
            text-align: center;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            max-width: 400px;
            width: 100%;
        }
        
        .success-icon {
            width: 80px;
            height: 80px;
            background: #4CAF50;
            border-radius: 50%;
            margin: 0 auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            color: white;
        }
        
        h1 {
            color: #333;
            margin-bottom: 15px;
            font-size: 24px;
        }
        
        .employee-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
        }
        
        .employee-name {
            font-size: 20px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .employee-id {
            color: #7f8c8d;
            font-size: 16px;
        }
        
        .scan-time {
            color: #95a5a6;
            font-size: 14px;
            margin-top: 10px;
        }
        
        .auto-close {
            color: #bdc3c7;
            font-size: 12px;
            margin-top: 20px;
        }
        
        .loading {
            display: none;
        }
        
        .loading .spinner {
            width: 30px;
            height: 30px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="success-card">
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>正在记录考勤...</p>
        </div>
        
        <div id="successContent" style="display: none;">
            <div class="success-icon">✓</div>
            <h1>考勤成功</h1>
            <div class="employee-info">
                <div class="employee-name" id="employeeName">--</div>
                <div class="employee-id">工号: <span id="employeeId">--</span></div>
            </div>
            <div class="scan-time" id="scanTime"></div>
            <div class="auto-close" id="autoCloseInfo"></div>
        </div>
        
        <div id="errorContent" style="display: none;">
            <div class="success-icon" style="background: #e74c3c;">✗</div>
            <h1>考勤失败</h1>
            <p id="errorMessage">系统错误，请重试</p>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Supabase配置 - 使用你现有的配置
        const supabaseUrl = 'https://ynkmlbczkcporjdpawbr.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inlua21sYmN6a2Nwb3JqZHBhd2JyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI4NDcwMjUsImV4cCI6MjA3ODQyMzAyNX0.6tkS9oBrg3_1tGzSXQZygZv_KpC-x97B_1r39lgBTGY';
        const supabase = supabase.createClient(supabaseUrl, supabaseKey);

        // 从URL参数获取员工信息
        const urlParams = new URLSearchParams(window.location.search);
        const employeeId = urlParams.get('id');
        const employeeName = urlParams.get('name') || '未知员工';

        // 显示元素
        const loadingEl = document.getElementById('loading');
        const successContentEl = document.getElementById('successContent');
        const errorContentEl = document.getElementById('errorContent');
        const employeeNameEl = document.getElementById('employeeName');
        const employeeIdEl = document.getElementById('employeeId');
        const scanTimeEl = document.getElementById('scanTime');
        const autoCloseInfoEl = document.getElementById('autoCloseInfo');
        const errorMessageEl = document.getElementById('errorMessage');

        // 显示加载状态
        loadingEl.style.display = 'block';

        async function recordAttendance() {
            if (!employeeId) {
                showError('无效的二维码：缺少员工信息');
                return;
            }

            try {
                // 1. 记录到扫码记录表
                const { data: scanData, error: scanError } = await supabase
                    .from('wechat_scans')
                    .insert([{ 
                        employee_id: employeeId,
                        user_agent: navigator.userAgent,
                        scan_time: new Date().toISOString()
                    }])
                    .select();

                if (scanError) throw scanError;

                // 2. 智能切换工作状态（复制你主站点的逻辑）
                await toggleWorkStatus(employeeId);

                // 3. 显示成功界面
                showSuccess();

            } catch (error) {
                console.error('记录考勤失败:', error);
                showError('系统繁忙，请稍后重试');
            }
        }

        // 智能切换工作状态（从你的主站点复制这个函数）
        async function toggleWorkStatus(employeeId) {
            try {
                // 先获取现有的工作记录
                const { data: existingRecords, error: fetchError } = await supabase
                    .from('work_records')
                    .select('*')
                    .eq('employee_id', employeeId);
                
                if (fetchError && !fetchError.message.includes('不存在')) {
                    throw fetchError;
                }

                const existingRecord = existingRecords && existingRecords[0];
                const now = new Date().toISOString();

                if (existingRecord && existingRecord.is_working) {
                    // 如果正在工作，则暂停工作
                    const startTime = new Date(existingRecord.start_time);
                    const workTimeHours = (new Date() - startTime) / (1000 * 60 * 60);
                    const newTotalHours = (existingRecord.total_hours || 0) + workTimeHours;

                    const { error: updateError } = await supabase
                        .from('work_records')
                        .update({
                            is_working: false,
                            start_time: null,
                            total_hours: newTotalHours,
                            last_updated: now
                        })
                        .eq('employee_id', employeeId);

                    if (updateError) throw updateError;

                } else {
                    // 如果未工作，则开始工作
                    const recordData = {
                        employee_id: employeeId,
                        is_working: true,
                        start_time: now,
                        total_hours: existingRecord ? existingRecord.total_hours : 0,
                        last_updated: now
                    };

                    const { error: upsertError } = await supabase
                        .from('work_records')
                        .upsert(recordData, { onConflict: 'employee_id' });

                    if (upsertError) throw upsertError;
                }

                return true;

            } catch (error) {
                console.error('切换工作状态失败:', error);
                // 这里不抛出错误，因为扫码记录已经成功，只是状态切换失败
                return false;
            }
        }

        function showSuccess() {
            loadingEl.style.display = 'none';
            successContentEl.style.display = 'block';
            
            // 显示员工信息
            employeeNameEl.textContent = employeeName;
            employeeIdEl.textContent = employeeId;
            
            // 显示扫码时间
            const now = new Date();
            scanTimeEl.textContent = `扫码时间: ${now.toLocaleString('zh-CN')}`;
            
            // 自动关闭提示
            autoCloseInfoEl.textContent = '本页面将在3秒后自动关闭';
            
            // 3秒后尝试关闭窗口
            setTimeout(() => {
                try {
                    // 尝试关闭窗口（在微信中可能无效，但尝试一下）
                    window.close();
                } catch (e) {
                    // 如果无法关闭，显示提示
                    autoCloseInfoEl.textContent = '您可以手动关闭此页面';
                }
            }, 3000);
        }

        function showError(message) {
            loadingEl.style.display = 'none';
            errorContentEl.style.display = 'block';
            errorMessageEl.textContent = message;
        }

        // 页面加载完成后开始记录
        document.addEventListener('DOMContentLoaded', recordAttendance);
    </script>
</body>
</html>