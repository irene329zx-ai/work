<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‰«ç è€ƒå‹¤</title>
    <style>
        body {
            font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh; /* ç¡®ä¿å æ»¡æ•´ä¸ªè§†å£ */
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .card {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            text-align: center;
            max-width: 400px;
            width: 100%;
        }
        .icon {
            font-size: 60px;
            margin-bottom: 20px;
        }
        .success { color: #4CAF50; }
        .error { color: #e74c3c; }
        .loading { color: #3498db; }
        .input-icon { color: #f39c12; } /* æ–°å¢è¾“å…¥çŠ¶æ€å›¾æ ‡é¢œè‰² */
        h1 { color: #333; margin-bottom: 15px; }
        .info { background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 15px 0; }
        .debug { 
            background: #fff3cd; 
            border: 1px solid #ffeaa7; 
            padding: 10px; 
            border-radius: 5px; 
            margin-top: 15px;
            font-size: 12px;
            text-align: left;
            display: none;
        }
        button {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .retry-btn { background: #e74c3c; }
    </style>
</head>
<body>
    <div class="card">
        <div id="loadingState">
            <div class="icon loading">â³</div>
            <h1>å¤„ç†ä¸­...</h1>
            <p>æ­£åœ¨è®°å½•è€ƒå‹¤ä¿¡æ¯</p>
            <div class="debug" id="loadingDebug"></div>
        </div>
        
        <div id="inputState" style="display: none;">
            <div class="icon input-icon">ğŸ“</div>
            <h1>å¡«å†™è€ƒå‹¤ä¿¡æ¯</h1>
            <p>è¯·ä¸º <span id="workerNameInput" style="font-weight: bold;">--</span> å¡«å†™ç”¨å·¥åœ°ç‚¹å’Œå·¥ç§ã€‚</p>
            
            <div style="text-align: left; margin: 20px 0;">
                <label for="workLocation" style="font-weight: bold; display: block; margin-bottom: 5px;">ç”¨å·¥åœ°ç‚¹ï¼š</label>
                <input type="text" id="workLocation" placeholder="ä¾‹ï¼šAåŒºä¸»ä½“ç»“æ„" required style="width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 5px;">
                
                <label for="workType" style="font-weight: bold; display: block; margin-bottom: 5px;">å·¥ç§ï¼š</label>
                <input type="text" id="workType" placeholder="ä¾‹ï¼šç”µç„Šå·¥" required style="width: 100%; padding: 10px; margin-bottom: 20px; border: 1px solid #ddd; border-radius: 5px;">
            </div>
            
            <button id="submitAttendance">æäº¤è€ƒå‹¤</button>
            <div class="debug" id="inputDebug"></div>
        </div>

        <div id="successState" style="display: none;">
            <div class="icon success">âœ…</div>
            <h1>è€ƒå‹¤æˆåŠŸ</h1>
            <div class="info">
                <div style="font-size: 18px; font-weight: bold;" id="successName">--</div>
                <div style="color: #666;" id="successId">å·¥å·: --</div>
                <div style="color: #3498db; margin-top: 8px;">åœ°ç‚¹: <span id="successLocation"></span> | å·¥ç§: <span id="successWorkType"></span></div>
            </div>
            <p id="successTime"></p>
            <p style="color: #999; font-size: 14px;" id="closeInfo"></p>
            <div class="debug" id="successDebug"></div>
        </div>

        <div id="errorState" style="display: none;">
            <div class="icon error">âŒ</div>
            <h1>è€ƒå‹¤å¤±è´¥</h1>
            <p id="errorMessage">ç³»ç»Ÿé”™è¯¯</p>
            <div>
                <button onclick="retry()">é‡è¯•</button>
                <button class="retry-btn" onclick="useFallback()">ä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ</button>
            </div>
            <div class="debug" id="errorDebug"></div>
        </div>
    </div>

<script>
// å…¨å±€å˜é‡ï¼Œç”¨äºå­˜å‚¨ç”¨æˆ·è¾“å…¥çš„åœ°ç‚¹å’Œå·¥ç§
let globalLocation = '';
let globalWorkType = '';

// ç›´æ¥ä»URLè·å–å‚æ•°
function getUrlParams() {
    const params = new URLSearchParams(window.location.search);
    return {
        id: params.get('id'),
        name: params.get('name') || 'å‘˜å·¥'
    };
}

// **å…³é”®ä¿®æ”¹ï¼šä½¿ç”¨ localStorage è¯»å–å¹¶æ¸…é™¤æ‰«æè€…ID**
function getScannerIdFromLocal() {
    const scannerId = localStorage.getItem('active_scanner_id');
    
    // åŸå§‹ä»£ç ï¼šæ— è®ºæ˜¯å¦è¯»å–åˆ°ï¼Œéƒ½å°è¯•æ¸…é™¤ï¼Œé˜²æ­¢èº«ä»½ä¿¡æ¯é•¿æœŸä¿ç•™
    // // ä¸ºäº†å®‰å…¨å’Œé¿å…èº«ä»½æ®‹ç•™ï¼Œè¿™é‡Œåªè¯»å–ï¼Œä¸åœ¨è€ƒå‹¤æˆåŠŸä¹‹å‰ä¸»åŠ¨æ¸…é™¤
    return scannerId;
}

// æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯
function showDebug(elementId, message) {
    console.log('DEBUG:', message);
    const element = document.getElementById(elementId);
    if (element) {
        element.style.display = 'block';
        element.innerHTML += message + '<br>';
    }
}

// å¤‡ç”¨æ–¹æ¡ˆï¼šä½¿ç”¨Fetch APIç›´æ¥è°ƒç”¨Supabase REST API (å·²æ›´æ–°)
async function fallbackToRestAPI(employeeId, employeeName) {
    showDebug('errorDebug', 'å°è¯•å¤‡ç”¨æ–¹æ¡ˆ...');
    
    // ä» localStorage è·å–æ‰«æè€… ID
    const scannerId = getScannerIdFromLocal(); 
    showDebug('errorDebug', `æ‰«æè€…ID: ${scannerId || 'æœªè¯†åˆ«'}`);
    
    const scanData = {
        employee_id: employeeId,
        user_agent: navigator.userAgent,
        scan_time: new Date().toISOString(),
        // ã€æ–°å¢ã€‘åŒ…å«ç”¨å·¥åœ°ç‚¹å’Œå·¥ç§
        work_location: globalLocation, 
        work_type: globalWorkType, 
    };
    
    // å¦‚æœå­˜åœ¨ scannerIdï¼Œåˆ™åŠ å…¥åˆ°æ•°æ®ä¸­
    if (scannerId) {
        scanData.scanner_id = scannerId;
    }

    try {
        // ä½¿ç”¨Supabase REST APIç›´æ¥æ’å…¥æ•°æ®
        const response = await fetch('https://ynkmlbczkcporjdpawbr.supabase.co/rest/v1/wechat_scans', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inlua21sYmN6a2Nwb3JqZHBhd2JyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI4NDcwMjUsImV4cCI6MjA3ODQyMzAyNX0.6tkS9oBrg3_1tGzSXQZygZv_KpC-x97B_1r39lgBTGY',
                'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inlua21sYmN6a2Nwb3JqZHBhd2JyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI4NDcwMjUsImV4cCI6MjA3ODQyMzAyNX0.6tkS9oBrg3_1tGzSXQZygZv_KpC-x97B_1r39lgBTGY',
                'Prefer': 'return=minimal'
            },
            body: JSON.stringify(scanData) // ä½¿ç”¨åŒ…å« scanner_id å’Œæ–°å¢å­—æ®µçš„ scanData
        });

        if (response.ok) {
            // **æˆåŠŸæ—¶æ¸…é™¤æ‰«æè€…èº«ä»½ (åŸå§‹ä»£ç ï¼Œç°å·²æ³¨é‡Š/ç§»é™¤)**
            // localStorage.removeItem('active_scanner_id'); // <--- ç§»é™¤æ­¤è¡Œ
            showDebug('errorDebug', 'å¤‡ç”¨æ–¹æ¡ˆæˆåŠŸï¼æ•°æ®å·²è®°å½•ã€‚');
            showSuccess(employeeName, employeeId, globalLocation, globalWorkType, 'ï¼ˆé€šè¿‡å¤‡ç”¨æ–¹æ¡ˆï¼‰');
            return true;
        } else {
            const errorText = await response.text();
            throw new Error(`HTTP response.status: ${response.status} ${errorText}`);
        }
    } catch (error) {
        showDebug('errorDebug', 'å¤‡ç”¨æ–¹æ¡ˆå¤±è´¥: ' + error.message);
        return false;
    }
}

// æ˜¾ç¤ºæˆåŠŸé¡µé¢ (å·²æ›´æ–°ï¼ŒåŠ å…¥åœ°ç‚¹å’Œå·¥ç§å‚æ•°)
function showSuccess(name, id, location, workType, action = '') {
    document.getElementById('loadingState').style.display = 'none';
    document.getElementById('inputState').style.display = 'none'; // éšè—è¾“å…¥çŠ¶æ€
    document.getElementById('errorState').style.display = 'none';
    document.getElementById('successState').style.display = 'block';
    
    document.getElementById('successName').textContent = name;
    document.getElementById('successId').textContent = `å·¥å·: ${id}`;
    // ã€æ–°å¢ã€‘æ˜¾ç¤ºåœ°ç‚¹å’Œå·¥ç§
    document.getElementById('successLocation').textContent = location;
    document.getElementById('successWorkType').textContent = workType;
    
    // æ˜¾ç¤ºå…·ä½“çš„æ“ä½œç»“æœ
    if (action) {
        document.getElementById('successTime').textContent = `${action}æˆåŠŸ - æ—¶é—´: ${new Date().toLocaleString('zh-CN')}`;
    } else {
        document.getElementById('successTime').textContent = `æ—¶é—´: ${new Date().toLocaleString('zh-CN')}`;
    }
    
    document.getElementById('closeInfo').textContent = 'æœ¬é¡µé¢å°†è‡ªåŠ¨å…³é—­';
    
    // **æˆåŠŸæ—¶æ¸…é™¤æ‰«æè€…èº«ä»½ (åŸå§‹ä»£ç ï¼Œç°å·²æ³¨é‡Š/ç§»é™¤)**
    // localStorage.removeItem('active_scanner_id'); // <--- ç§»é™¤æ­¤è¡Œ

    // æç¤ºï¼šç”±äºèº«ä»½ä¿¡æ¯ä¸ä¼šè¢«æ¸…é™¤ï¼Œå·¥ç¨‹å¸ˆå¯ä»¥ç»§ç»­æ‰«ç 
    document.getElementById('closeInfo').textContent = 'èº«ä»½å·²ä¿ç•™ã€‚è¯·ç›´æ¥è¿”å›ç»§ç»­æ‰«æä¸‹ä¸€ä½å·¥äººã€‚'; 
    
    // å»¶è¿Ÿå…³é—­ï¼Œä½†ç°åœ¨æˆ‘ä»¬å¸Œæœ›ä¿ç•™èº«ä»½ï¼Œæ‰€ä»¥å¯èƒ½ä¸è‡ªåŠ¨å…³é—­
    setTimeout(() => {
        try { 
            // window.close(); // ä¸å†è‡ªåŠ¨å…³é—­ï¼Œè®©å·¥ç¨‹å¸ˆæ‰‹åŠ¨é€€å‡º
            document.getElementById('closeInfo').textContent = 'èº«ä»½å·²ä¿ç•™ã€‚è¯·æ‰‹åŠ¨é€€å‡ºæ­¤é¡µé¢ï¼Œæ‰«æä¸‹ä¸€ä½å·¥äººã€‚';
        } 
        catch (e) { 
            document.getElementById('closeInfo').textContent = 'èº«ä»½å·²ä¿ç•™ã€‚è¯·æ‰‹åŠ¨é€€å‡ºæ­¤é¡µé¢ï¼Œæ‰«æä¸‹ä¸€ä½å·¥äººã€‚';
        }
    }, 3000);
}

// æ˜¾ç¤ºé”™è¯¯é¡µé¢
function showError(message) {
    document.getElementById('loadingState').style.display = 'none';
    document.getElementById('inputState').style.display = 'none'; // éšè—è¾“å…¥çŠ¶æ€
    document.getElementById('successState').style.display = 'none';
    document.getElementById('errorState').style.display = 'block';
    document.getElementById('errorMessage').textContent = message;
}

// ã€æ–°å¢ã€‘å±•ç¤ºè¾“å…¥ç•Œé¢
function showInputState(name, id) {
    document.getElementById('loadingState').style.display = 'none';
    document.getElementById('errorState').style.display = 'none';
    document.getElementById('successState').style.display = 'none';
    
    const inputState = document.getElementById('inputState');
    inputState.style.display = 'block';
    document.getElementById('workerNameInput').textContent = name;
    
    // ç»‘å®šæäº¤æŒ‰é’®äº‹ä»¶
    document.getElementById('submitAttendance').onclick = async () => {
        const locationInput = document.getElementById('workLocation');
        const workTypeInput = document.getElementById('workType');
        
        globalLocation = locationInput.value.trim();
        globalWorkType = workTypeInput.value.trim();
        
        if (!globalLocation || !globalWorkType) {
            alert('ç”¨å·¥åœ°ç‚¹å’Œå·¥ç§ä¸èƒ½ä¸ºç©ºï¼');
            locationInput.focus();
            return;
        }
        
        // åˆ‡æ¢å›åŠ è½½çŠ¶æ€
        document.getElementById('inputState').style.display = 'none';
        document.getElementById('loadingState').style.display = 'block';
        
        // æ‰§è¡Œè€ƒå‹¤è®°å½•
        const params = getUrlParams();
        const workStatusResult = await recordAttendance(params.id, params.name);

        if (workStatusResult && workStatusResult.action) {
            showSuccess(params.name, params.id, globalLocation, globalWorkType, workStatusResult.action);
        } else {
            showError('è€ƒå‹¤è®°å½•å¤±è´¥ï¼Œè¯·ä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ');
        }
    };
}


// é‡è¯•å‡½æ•°
function retry() {
    // é‡è¯•æ—¶ï¼Œæˆ‘ä»¬å›åˆ°è¾“å…¥çŠ¶æ€ï¼Œç¡®ä¿åœ°ç‚¹å’Œå·¥ç§ä¸ä¼šä¸¢å¤±
    const params = getUrlParams();
    document.getElementById('errorState').style.display = 'none';
    // é‡ç½®å…¨å±€å˜é‡
    globalLocation = '';
    globalWorkType = '';
    // é‡æ–°è¿›å…¥è¾“å…¥æµç¨‹
    showInputState(params.name, params.id);
    document.getElementById('errorDebug').innerHTML = '';
}

// ä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ
function useFallback() {
    const params = getUrlParams();
    
    // å¦‚æœæ²¡æœ‰ç»è¿‡è¾“å…¥é˜¶æ®µï¼Œåˆ™è­¦å‘Šå¹¶è¦æ±‚è¾“å…¥ (é˜²æ­¢ç›´æ¥ä»é”™è¯¯é¡µè¿›å…¥å¤‡ç”¨æ–¹æ¡ˆ)
    if (!globalLocation || !globalWorkType) {
        alert('è¯·å…ˆå¡«å†™ç”¨å·¥åœ°ç‚¹å’Œå·¥ç§åå†ä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆï¼');
        document.getElementById('errorState').style.display = 'none';
        showInputState(params.name, params.id);
        return;
    }
    
    fallbackToRestAPI(params.id, params.name);
}

// ä¸»åˆå§‹åŒ–å‡½æ•° (å·²ä¿®æ”¹ï¼šåªè¿›è¡ŒåŠ è½½ï¼Œç„¶åè¿›å…¥è¾“å…¥çŠ¶æ€)
async function init() {
    const params = getUrlParams();
    showDebug('loadingDebug', `å‘˜å·¥: ${params.name} (${params.id})`);
    
    // ã€æ–°å¢æ£€æŸ¥ã€‘å¦‚æœæ²¡æœ‰ scannerIdï¼Œåˆ™æç¤ºå¹¶è¦æ±‚å…ˆè®¤è¯
    const currentScannerId = getScannerIdFromLocal();
    if (!currentScannerId) {
        showError('è¯·å…ˆä½¿ç”¨æ‚¨çš„å·¥ç¨‹å¸ˆèº«ä»½ç è¿›è¡Œèº«ä»½è®¤è¯ï¼');
        return;
    }
    
    if (!params.id) {
        showError('æ— æ•ˆçš„äºŒç»´ç ï¼šç¼ºå°‘å‘˜å·¥ä¿¡æ¯');
        return;
    }

    try {
        showDebug('loadingDebug', 'æ­£åœ¨åŠ è½½Supabaseåº“...');
        
        // åŠ¨æ€åŠ è½½Supabaseåº“
        await loadSupabase();
        
        // SupabaseåŠ è½½å®Œæˆåï¼Œè¿›å…¥è¾“å…¥çŠ¶æ€
        showDebug('loadingDebug', 'SupabaseåŠ è½½å®Œæˆï¼Œå‡†å¤‡è¾“å…¥è€ƒå‹¤ä¿¡æ¯...');
        
        showInputState(params.name, params.id);
        
    } catch (error) {
        console.error('åˆå§‹åŒ–å¤±è´¥:', error);
        showDebug('errorDebug', 'é”™è¯¯è¯¦æƒ…: ' + error.message);
        showError('ç³»ç»ŸåŠ è½½å¤±è´¥ï¼Œè¯·ä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ');
    }
}

// åŠ¨æ€åŠ è½½Supabase
function loadSupabase() {
    return new Promise((resolve, reject) => {
        // æ£€æŸ¥æ˜¯å¦å·²åŠ è½½
        if (window.supabase) {
            resolve();
            return;
        }

        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2';
        script.onload = () => {
            // ç»™ç‚¹æ—¶é—´è®©åº“åˆå§‹åŒ–
            setTimeout(resolve, 100);
        };
        script.onerror = () => reject(new Error('Failed to load Supabase'));
        document.head.appendChild(script);
    });
}

// è®°å½•è€ƒå‹¤ - å®Œæ•´ç‰ˆæœ¬ (å·²æ›´æ–°ï¼Œå°†åœ°ç‚¹å’Œå·¥ç§åŠ å…¥æ‰«ç è®°å½•)
async function recordAttendance(employeeId, employeeName) {
    try {
        // **å…³é”®ï¼š** ä» localStorage è·å–æ‰«æè€… ID
        const scannerId = getScannerIdFromLocal(); 
        showDebug('loadingDebug', `æ‰«æè€… ID: ${scannerId || 'æœªè¯†åˆ«'}`);
        showDebug('loadingDebug', `ç”¨å·¥åœ°ç‚¹: ${globalLocation}, å·¥ç§: ${globalWorkType}`); // è°ƒè¯•ä¿¡æ¯
        
        showDebug('loadingDebug', 'åˆå§‹åŒ–Supabaseå®¢æˆ·ç«¯...');
        
        // åˆå§‹åŒ–Supabase
        const supabaseUrl = 'https://ynkmlbczkcporjdpawbr.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inlua21sYmN6a2Nwb3JqZHBhd2JyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI4NDcwMjUsImV4cCI6MjA3ODQyMzAyNX0.6tkS9oBrg3_1tGzSXQZygZv_KpC-x97B_1r39lgBTGY';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
        
        showDebug('loadingDebug', '1. æ’å…¥æ‰«ç è®°å½•...');
        
        // æ„å»ºè®°å½•å¯¹è±¡
        const scanRecord = { 
            employee_id: employeeId,
            user_agent: navigator.userAgent,
            scan_time: new Date().toISOString(),
            // ã€æ–°å¢ã€‘åœ°ç‚¹å’Œå·¥ç§
            work_location: globalLocation, 
            work_type: globalWorkType 
        };
        
        if (scannerId) { // å¦‚æœå­˜åœ¨ scannerIdï¼Œåˆ™åŠ å…¥
            scanRecord.scanner_id = scannerId;
        }
        
        // 1. æ’å…¥æ‰«ç è®°å½•
        const { data: scanData, error: scanError } = await supabase
            .from('wechat_scans')
            .insert([scanRecord]) // ä½¿ç”¨åŒ…å« scanner_id å’Œæ–°å¢å­—æ®µçš„è®°å½•å¯¹è±¡
            .select();

        if (scanError) {
            showDebug('errorDebug', 'æ‰«ç è®°å½•æ’å…¥å¤±è´¥(ä¸å½±å“è€ƒå‹¤): ' + scanError.message);
            // ç»§ç»­å°è¯•æ›´æ–°å·¥ä½œçŠ¶æ€ï¼Œä¸ç›´æ¥è¿”å›
        } else {
            showDebug('successDebug', 'æ‰«ç è®°å½•æ’å…¥æˆåŠŸ');
        }

        showDebug('loadingDebug', '2. æ›´æ–°å·¥ä½œçŠ¶æ€...');
        
        // 2. æ›´æ–°å·¥ä½œçŠ¶æ€ï¼ˆè¿™æ˜¯å…³é”®ï¼ï¼‰
        // å°† scannerId ä¼ é€’ç»™ updateWorkStatus
        const workStatusResult = await updateWorkStatus(supabase, employeeId, employeeName, scannerId, globalLocation, globalWorkType); 
        
        if (workStatusResult.success) {
            showDebug('successDebug', `å·¥ä½œçŠ¶æ€æ›´æ–°æˆåŠŸ: ${workStatusResult.action}`);
            // è¿”å› workStatusResult è€Œä¸æ˜¯ trueï¼Œä»¥ä¾¿ showSuccess æ‹¿åˆ° action
            return workStatusResult; 
        } else {
            showDebug('errorDebug', 'å·¥ä½œçŠ¶æ€æ›´æ–°å¤±è´¥: ' + workStatusResult.error);
            return false;
        }
        
    } catch (error) {
        showDebug('errorDebug', 'è®°å½•è€ƒå‹¤å¼‚å¸¸: ' + error.message);
        return false;
    }
}

// æ›´æ–°å·¥ä½œçŠ¶æ€ - æ ¸å¿ƒé€»è¾‘ (å·²æ›´æ–°ï¼Œåœ¨å†å²è®°å½•ä¸­åŠ å…¥åœ°ç‚¹å’Œå·¥ç§ä¿¡æ¯)
async function updateWorkStatus(supabase, employeeId, employeeName, scannerId, location, workType) { 
    try {
        showDebug('loadingDebug', 'è·å–å½“å‰å·¥ä½œçŠ¶æ€...');
        
        // 1. è·å–å‘˜å·¥å½“å‰çš„å·¥ä½œçŠ¶æ€
        const { data: currentRecord, error: fetchError } = await supabase
            .from('work_records')
            .select('*')
            .eq('employee_id', employeeId)
            .maybeSingle();

        // å¦‚æœå­˜åœ¨å…¶ä»–ç±»å‹çš„é”™è¯¯ï¼ˆé 0 è¡Œæˆ– 1 è¡Œçš„é”™è¯¯ï¼‰ï¼Œåˆ™æŠ›å‡º
        if (fetchError && fetchError.code !== 'PGRST116') {
            throw fetchError;
        }

        const now = new Date().toISOString();
        let action = '';
        let newRecord = {};
        
        // ç”¨äºæ·»åŠ åˆ°å†å²è®°å½•çš„æ–‡æœ¬ä¿¡æ¯
        const scannerInfo = scannerId ? ` (ç”± ${scannerId} æ‰«æ)` : '';
        const locationInfo = location ? ` [åœ°ç‚¹: ${location}, å·¥ç§: ${workType}]` : '';

        // currentRecord ä¸º null è¡¨ç¤ºæ–°å‘˜å·¥æˆ–è®°å½•ä¸å­˜åœ¨
        if (currentRecord && currentRecord.is_working) {
            // æƒ…å†µ1ï¼šå‘˜å·¥æ­£åœ¨å·¥ä½œ â†’ æš‚åœå·¥ä½œ (ä¸‹å·¥)
            showDebug('loadingDebug', 'å‘˜å·¥æ­£åœ¨å·¥ä½œï¼Œæ‰§è¡Œä¸‹å·¥æ“ä½œ...');
            action = 'ä¸‹å·¥';
            
            // ã€è§£å†³ç²¾åº¦é—®é¢˜ã€‘è®¡ç®—æœ¬æ¬¡å·¥ä½œæ—¶é•¿
            const startTime = new Date(currentRecord.start_time).getTime(); // è·å–æ¯«ç§’æ—¶é—´æˆ³
            // ç¡®ä¿æœ¬æ¬¡å·¥ä½œæ—¶é•¿è‡³å°‘ä¸º 100 æ¯«ç§’ï¼Œé˜²æ­¢ç½‘ç»œå»¶è¿Ÿå¯¼è‡´è´Ÿå€¼æˆ– 0
            const rawDurationMs = Math.max(100, new Date().getTime() - startTime); 
            const workTimeHours = rawDurationMs / (1000 * 60 * 60);

            // ç»Ÿä¸€ç²¾åº¦åˆ°å°æ•°ç‚¹åå››ä½
            const fixedWorkTimeHours = parseFloat(workTimeHours.toFixed(4)); 
            const newTotalHours = (parseFloat(currentRecord.total_hours) || 0) + fixedWorkTimeHours;
            
            // å¤„ç†ä»Šæ—¥å·¥æ—¶
            let newTodayHours = parseFloat(currentRecord.today_hours) || 0;
            if (currentRecord.start_time && new Date().toDateString() === new Date(currentRecord.start_time).toDateString()) {
                // å¦‚æœä¸Šå·¥å’Œä¸‹å·¥éƒ½åœ¨åŒä¸€å¤©ï¼Œç´¯åŠ ä»Šæ—¥å·¥æ—¶
                newTodayHours += fixedWorkTimeHours;
            } else {
                // å¦‚æœè·¨å¤©ï¼Œä»ç„¶ç´¯åŠ æœ¬æ¬¡å·¥ä½œæ—¶é•¿ï¼Œè®© work.html å¤„ç†æ¯æ—¥é‡ç½®å’Œå®æ—¶è®¡ç®—
                newTodayHours += fixedWorkTimeHours;
            }
            
            // æ›´æ–°è®°å½•ï¼šæš‚åœå·¥ä½œ
            newRecord = {
                employee_id: employeeId,
                is_working: false,
                start_time: null,
                total_hours: newTotalHours,
                today_hours: newTodayHours, // å†™å…¥ç´¯åŠ åçš„ä»Šæ—¥å·¥æ—¶
                last_updated: now,
                history: [
                    ...(currentRecord.history || []),
                    {
                        // **å…³é”®ï¼š** åœ¨ action ä¸­æ·»åŠ æ‰«æè€…ä¿¡æ¯ã€åœ°ç‚¹å’Œå·¥ç§
                        action: `å¾®ä¿¡æ‰«ç ä¸‹å·¥${scannerInfo}${locationInfo} - å·¥ä½œæ—¶é•¿: ${fixedWorkTimeHours.toFixed(2)}å°æ—¶`, 
                        timestamp: now
                    }
                ]
            };
            
        } else {
            // æƒ…å†µ2ï¼šå‘˜å·¥æœªå·¥ä½œæˆ–è®°å½•ä¸å­˜åœ¨ï¼ˆå«æ–°å‘˜å·¥ï¼‰ â†’ å¼€å§‹å·¥ä½œ (ä¸Šå·¥)
            showDebug('loadingDebug', 'å‘˜å·¥æœªå·¥ä½œ/æ–°å‘˜å·¥ï¼Œæ‰§è¡Œä¸Šå·¥æ“ä½œ...');
            action = 'ä¸Šå·¥';
            
            // åˆ¤æ–­æ˜¯å¦éœ€è¦é‡ç½®ä»Šæ—¥å·¥æ—¶
            let currentTodayHours = currentRecord ? parseFloat(currentRecord.today_hours) : 0;
            if (currentRecord && currentRecord.last_updated) {
                const lastUpdateDate = new Date(currentRecord.last_updated);
                // å¦‚æœä¸Šæ¬¡æ›´æ–°ä¸æ˜¯ä»Šå¤©ï¼ˆå³è·¨å¤©äº†ï¼‰ï¼Œé‡ç½®ä»Šæ—¥å·¥æ—¶
                if (new Date().toDateString() !== lastUpdateDate.toDateString()) {
                    currentTodayHours = 0; 
                }
            }
            
            // åˆ›å»ºæˆ–æ›´æ–°è®°å½•ï¼šå¼€å§‹å·¥ä½œ
            newRecord = {
                employee_id: employeeId,
                is_working: true,
                start_time: now,
                total_hours: currentRecord ? parseFloat(currentRecord.total_hours) : 0,
                today_hours: currentTodayHours, // ä½¿ç”¨é‡ç½®åçš„ä»Šæ—¥å·¥æ—¶
                last_updated: now,
                history: [
                    ...(currentRecord?.history || []),
                    {
                        // **å…³é”®ï¼š** åœ¨ action ä¸­æ·»åŠ æ‰«æè€…ä¿¡æ¯ã€åœ°ç‚¹å’Œå·¥ç§
                        action: `å¾®ä¿¡æ‰«ç ä¸Šå·¥${scannerInfo}${locationInfo}`,
                        timestamp: now
                    }
                ]
            };
        }

        showDebug('loadingDebug', `æ‰§è¡Œ${action}æ“ä½œï¼Œæ›´æ–°æ•°æ®...`);
        
        // æ’å…¥æˆ–æ›´æ–°å·¥ä½œè®°å½•
        const { data: workData, error: workError } = await supabase
            .from('work_records')
            .upsert(newRecord, {
                onConflict: 'employee_id',
                ignoreDuplicates: false
            })
            .select();

        if (workError) {
            throw new Error(`å·¥ä½œè®°å½•æ›´æ–°å¤±è´¥: ${workError.message}`);
        }
        
        showDebug('successDebug', `${action}æ“ä½œæˆåŠŸå®Œæˆ`);

        return {
            success: true,
            action: action,
            data: workData 
        };

    } catch (error) {
        console.error('æ›´æ–°å·¥ä½œçŠ¶æ€å¤±è´¥:', error);
        return {
            success: false,
            error: error.message
        };
    }
}

// é¡µé¢åŠ è½½æ—¶å¯åŠ¨
document.addEventListener('DOMContentLoaded', function() {
    showDebug('loadingDebug', 'é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–...');
    setTimeout(init, 100);
});
</script>
</body>
</html>
