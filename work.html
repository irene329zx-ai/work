<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‘˜å·¥å·¥æ—¶ç®¡ç†ç³»ç»Ÿ</title>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.0/build/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #3498db, #2c3e50);
            color: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        
        .tab-container {
            display: flex;
            margin-bottom: 20px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            background: #f8f9fa;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .tab.active {
            background: #3498db;
            color: white;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }
        
        @media (max-width: 900px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }
        
        .card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        
        .card h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        input[type="text"], select, input[type="month"] {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            transition: border 0.3s;
        }
        
        input[type="text"]:focus, select:focus, input[type="month"]:focus {
            border-color: #3498db;
            outline: none;
        }
        
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: background-color 0.3s;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        button:hover {
            background-color: #2980b9;
        }
        
        button.secondary {
            background-color: #2ecc71;
        }
        
        button.secondary:hover {
            background-color: #27ae60;
        }
        
        button.danger {
            background-color: #e74c3c;
        }
        
        button.danger:hover {
            background-color: #c0392b;
        }
        
        .qr-container {
            text-align: center;
            margin-top: 20px;
            padding: 15px;
            border: 1px dashed #ddd;
            border-radius: 5px;
            min-height: 200px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        
        #qrcode {
            margin-top: 15px;
        }
        
        .employee-list {
            margin-top: 20px;
        }
        
        .employee-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
            margin-bottom: 10px; /* å¢åŠ è¡Œé—´è· */
            border-radius: 5px;
            transition: background-color 0.2s;
        }
        
        .employee-item:hover {
             background-color: #f8f9fa;
        }
        
        .employee-item:last-child {
            border-bottom: none;
        }
        
        .employee-info {
            flex-grow: 1;
        }
        
        .employee-name {
            font-weight: 600;
            font-size: 18px;
        }
        
        .employee-id {
            color: #7f8c8d;
            font-size: 14px;
        }
        
        .employee-status {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .status-working {
            background-color: #e8f6f3;
            color: #27ae60;
        }
        
        .status-idle {
            background-color: #fef9e7;
            color: #f39c12;
        }

        /* å·¥ç¨‹å¸ˆçŠ¶æ€ç”¨ status-online/status-online */
        .status-online {
            background-color: #f0f0f8;
            color: #3498db;
        }
        
        .work-time {
            font-size: 14px;
            color: #2c3e50;
            margin-top: 5px;
        }
        
        .logs-container {
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .log-item {
            padding: 10px 15px;
            border-bottom: 1px solid #eee;
            font-size: 14px;
        }
        
        .log-time {
            color: #7f8c8d;
            font-size: 12px;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 5px;
            color: white;
            font-weight: 600;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .notification.success {
            background-color: #2ecc71;
        }
        
        .notification.error {
            background-color: #e74c3c;
        }
        
        .notification.show {
            opacity: 1;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .total-hours {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
            text-align: center;
            font-size: 18px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .employee-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .delete-btn {
            background-color: #e74c3c;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            min-width: 55px; /* ç»Ÿä¸€æŒ‰é’®å®½åº¦ */
        }
        
        .delete-btn:hover {
            background-color: #c0392b;
        }
        
        .empty-state {
            text-align: center;
            padding: 30px;
            color: #7f8c8d;
        }
        
        .stats-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
        }
        
        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            text-align: center;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #3498db;
            margin: 10px 0;
        }
        
        .stat-label {
            font-size: 14px;
            color: #7f8c8d;
        }
        
        .work-history {
            margin-top: 20px;
        }
        
        .history-item {
            padding: 10px 15px;
            border-bottom: 1px solid #eee;
            font-size: 14px;
        }
        
        .history-date {
            font-weight: 600;
            color: #2c3e50;
        }
        
        .history-time {
            color: #7f8c8d;
            font-size: 12px;
        }
        
        .history-duration {
            float: right;
            font-weight: 600;
            color: #3498db;
        }
        
        .sync-status {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-online {
            background-color: #2ecc71;
        }
        
        .status-offline {
            background-color: #e74c3c;
        }

        .time-info {
            font-size: 12px;
            color: #7f8c8d;
            margin-top: 3px;
        }
        
        /* å¾®ä¿¡æ‰«ç è®°å½•æ ·å¼ */
        .wechat-scan-item {
            padding: 8px 12px;
            border-bottom: 1px solid #eee;
            font-size: 13px;
            background: #f8f9fa;
            margin-bottom: 5px;
            border-radius: 5px;
        }

        .wechat-scan-time {
            color: #7f8c8d;
            font-size: 11px;
        }

        .recent-activity {
            margin-top: 15px;
        }
        
        .work-time-details {
            display: flex;
            gap: 15px;
            margin-top: 5px;
        }
        
        .work-time-item {
            font-size: 13px;
            color: #2c3e50;
        }
        
        .work-time-label {
            font-weight: 600;
            color: #7f8c8d;
        }

        .realtime-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #2ecc71;
            margin-left: 5px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.4; }
            100% { opacity: 1; }
        }

        /* ------------------------------------- */
        /* æ–°å¢ï¼šå‘˜å·¥åˆ—è¡¨ä¼˜åŒ–å’Œæ¨¡æ€çª—å£ (Modal) æ ·å¼ */
        /* ------------------------------------- */
        
        /* æ¨¡æ€çª—å£ (Modal) æ ·å¼ */
        .modal {
            display: none; 
            position: fixed; 
            z-index: 1001; 
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4); 
            padding-top: 60px;
        }

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto; /* 5% from the top and centered */
            padding: 30px;
            border-radius: 10px;
            border: 1px solid #888;
            width: 80%; 
            max-width: 400px;
            position: relative;
            text-align: center;
        }

        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close-button:hover,
        .close-button:focus {
            color: #333;
            text-decoration: none;
            cursor: pointer;
        }
        
        .qr-container-modal {
            text-align: center;
            margin-top: 20px;
            padding: 15px;
            border: 1px dashed #ddd;
            border-radius: 5px;
            min-height: 200px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        
        /* ä¼˜åŒ–å‘˜å·¥åˆ—è¡¨æ ·å¼ */
        .employee-item[data-role="engineer"] {
            background-color: #f0f4ff; /* å·¥ç¨‹å¸ˆä½¿ç”¨æµ…è“è‰²èƒŒæ™¯ */
            border-left: 5px solid #3498db;
        }
        
        .employee-item[data-role="worker"] {
            background-color: #f7fff7;
            border-left: 5px solid #2ecc71;
        }
        
        .employee-item:not([data-role="engineer"]) {
             margin-bottom: 5px; /* å·¥äººå’Œå·¥ç¨‹å¸ˆä¹‹é—´æ‹‰å¼€è·ç¦» */
        }
        
        .employee-name::before {
             margin-right: 8px;
             font-size: 18px;
             /* ç¡®ä¿å­—ä½“æ”¯æŒ emoji æˆ–å…¶ä»–ç¬¦å· */
        }
        
        .employee-item[data-role="worker"] .employee-name::before {
             content: 'ğŸ‘·'; /* å·¥äººå›¾æ ‡ */
        }
        
        .employee-item[data-role="engineer"] .employee-name::before {
             content: 'ğŸ‘¨â€ğŸ’»'; /* å·¥ç¨‹å¸ˆå›¾æ ‡ */
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>å‘˜å·¥å·¥æ—¶ç®¡ç†ç³»ç»Ÿ <span id="syncStatusIndicator" class="sync-status status-offline"></span></h1>
            <p class="subtitle">å‘˜å·¥ä¿¡æ¯å½•å…¥ Â· å¾®ä¿¡æ‰«ç è€ƒå‹¤ Â· å·¥æ—¶è®°å½• Â· äº‘ç«¯åŒæ­¥ <span id="realtimeIndicator" class="realtime-indicator" style="display: none;" title="å®æ—¶åŒæ­¥å·²å¼€å¯"></span></p>
        </header>
        
        <div class="tab-container">
            <div class="tab active" data-tab="employee-tab">äººå‘˜å½•å…¥</div>
            <div class="tab" data-tab="admin-tab">åå°ç®¡ç†</div>
            <div class="tab" data-tab="data-tab">äº‘ç«¯ç®¡ç†</div>
        </div>
        
        <div id="employee-tab" class="tab-content active">
            <div class="card">
                <h2>äººå‘˜ä¿¡æ¯å½•å…¥</h2>
                
                <div class="form-group">
                    <label for="employeeRole">äººå‘˜è§’è‰²</label>
                    <select id="employeeRole">
                        <option value="worker">å·¥äºº (ç”Ÿæˆè€ƒå‹¤ç )</option>
                        <option value="engineer">å·¥ç¨‹å¸ˆ/æ‰«æè€… (ç”Ÿæˆèº«ä»½ç )</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="employeeName">å§“å</label>
                    <input type="text" id="employeeName" placeholder="è¯·è¾“å…¥å§“å(2-20ä¸ªå­—ç¬¦)">
                </div>
                <div class="form-group">
                    <label for="employeeId">å·¥å·</label>
                    <input type="text" id="employeeId" placeholder="è¯·è¾“å…¥å·¥å·(å­—æ¯å’Œæ•°å­—)">
                </div>
                <div class="action-buttons">
                    <button id="generateQR">ç”ŸæˆäºŒç»´ç </button>
                    <button id="clearForm" class="danger">æ¸…ç©ºè¡¨å•</button>
                </div>
                
                <div class="qr-container">
                    <p id="qrPlaceholder">ç”Ÿæˆçš„äºŒç»´ç å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ</p>
                    <canvas id="qrcode"></canvas>
                </div>
            </div>
        </div>
        
        <div id="admin-tab" class="tab-content">
            <div class="main-content">
                <div class="left-column">
                    <div class="card">
                        <h2>å‘˜å·¥åˆ—è¡¨</h2>
                        <div class="stats-container">
                            <div class="stat-card">
                                <div class="stat-label">äººå‘˜æ€»æ•°</div>
                                <div class="stat-value" id="totalEmployees">0</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">å·¥ä½œä¸­</div>
                                <div class="stat-value" id="workingEmployees">0</div>
                            </div>
                        </div>
                        <div class="employee-list" id="employeeList">
                            </div>
                    </div>
                    
                    <div class="card">
                        <h2>ä»Šæ—¥å·¥æ—¶æ’è¡Œ</h2>
                        <div class="work-history" id="workRanking">
                            </div>
                    </div>

                    <div class="card">
                        <h2>æœ€è¿‘å¾®ä¿¡æ‰«ç è®°å½•</h2>
                        <div class="recent-activity" id="wechatScansList">
                            </div>
                    </div>
                </div>
                
                <div class="right-column">
                    <div class="card">
                        <h2>å·¥æ—¶ç®¡ç†</h2>
                        <div class="form-group">
                            <label for="selectedEmployee">é€‰æ‹©å·¥äºº</label>
                            <select id="selectedEmployee" style="width: 100%; padding: 12px; border-radius: 5px; border: 1px solid #ddd; font-size: 16px;">
                                <option value="">-- è¯·é€‰æ‹©å·¥äºº --</option>
                            </select>
                        </div>
                        
                        <div class="action-buttons">
                            <button id="startWork" class="secondary">å¼€å§‹å·¥ä½œ</button>
                            <button id="pauseWork">æš‚åœå·¥ä½œ</button>
                            <button id="saveWork">ä¿å­˜å·¥æ—¶</button>
                        </div>
                        
                        <div class="total-hours">
                            ä»Šæ—¥æ€»å·¥æ—¶: <span id="totalHours">0</span> å°æ—¶
                        </div>
                        
                        <div class="work-history" id="workHistory">
                            </div>
                    </div>

                    <div class="card">
                        <h2>å·¥èµ„ç»Ÿè®¡ä¸æŠ¥è¡¨</h2>
                        <div class="form-group">
                            <label for="payrollMonth">é€‰æ‹©æœˆä»½</label>
                            <input type="month" id="payrollMonth" style="width: 100%; padding: 12px; border-radius: 5px; border: 1px solid #ddd; font-size: 16px;">
                        </div>
                        <div class="action-buttons">
                            <button id="calculatePayroll" class="secondary">è®¡ç®—æœˆå·¥æ—¶</button>
                        </div>
                        
                        <div style="margin-top: 20px;">
                            <h3 style="margin-bottom: 10px; color: #3498db;">è®¡ç®—ç»“æœ</h3>
                            <div id="payrollResults">
                                <div class="empty-state">è¯·é€‰æ‹©æœˆä»½å¹¶ç‚¹å‡»è®¡ç®—</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="data-tab" class="tab-content">
            <div class="main-content">
                <div class="left-column">
                    <div class="card">
                        <h2>äº‘ç«¯åŒæ­¥</h2>
                        <div class="action-buttons">
                            <button id="syncToCloud" class="secondary">åŒæ­¥åˆ°äº‘ç«¯</button>
                            <button id="syncFromCloud">ä»äº‘ç«¯åŒæ­¥</button>
                            <button id="checkUpdates" class="secondary">æ£€æŸ¥äº‘ç«¯æ›´æ–°</button>
                            <button id="toggleRealtime">å¼€å¯å®æ—¶åŒæ­¥</button>
                            <button onclick="window.open('location-report.html', '_blank')" class="secondary"> æŸ¥çœ‹ä»Šæ—¥ç”¨å·¥åœ°ç‚¹æŠ¥è¡¨</button>
                        </div>
                        <div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                            <p style="font-size: 14px; color: #7f8c8d;">äº‘ç«¯åŒæ­¥çŠ¶æ€: <span id="cloudStatusText">æœªè¿æ¥</span></p>
                            <p style="font-size: 12px; color: #7f8c8d; margin-top: 5px;">å®æ—¶åŒæ­¥: <span id="realtimeStatusText">æœªå¼€å¯</span></p>
                        </div>
                    </div>
                </div>
                
                <div class="right-column">
                    <div class="card">
                        <h2>ç³»ç»Ÿç»Ÿè®¡</h2>
                        <div class="stats-container">
                            <div class="stat-card">
                                <div class="stat-label">æ€»å·¥äºº/å·¥ç¨‹å¸ˆæ•°</div>
                                <div class="stat-value" id="statTotalEmployees">0</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">æ€»å·¥æ—¶</div>
                                <div class="stat-value" id="statTotalHours">0</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">ä»Šæ—¥å·¥æ—¶</div>
                                <div class="stat-value" id="statTodayHours">0</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">æ´»è·ƒå·¥äºº</div>
                                <div class="stat-value" id="statActiveEmployees">0</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h2>æ“ä½œæ—¥å¿—</h2>
                        <div class="logs-container" id="systemLogs">
                            </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="notification" id="notification"></div>
    
    <div id="qrModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal()">&times;</span>
            <h2 id="modalTitle"></h2>
            <div id="modalQrContainer" class="qr-container-modal">
                <p id="modalQrPlaceholder">æ­£åœ¨ç”ŸæˆäºŒç»´ç ...</p>
                <canvas id="modalQrcode"></canvas>
            </div>
            <p id="modalQrLink" style="font-size: 12px; margin-top: 10px; word-break: break-all; color: #7f8c8d;"></p>
        </div>
    </div>

    <script>
        // Supabaseäº‘åŒæ­¥ç±» - å¢å¼ºç‰ˆï¼ˆæ”¯æŒåŒå‘åŒæ­¥ï¼‰
        class CloudSync {
            constructor() {
                // ä½¿ç”¨ä½ æä¾›çš„Supabaseé…ç½®
                this.supabaseUrl = 'https://ynkmlbczkcporjdpawbr.supabase.co';
                this.supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inlua21sYmN6a2Nwb3JqZHBhd2JyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI4NDcwMjUsImV4cCI6MjA3ODQyMzAyNX0.6tkS9oBrg3_1tGzSXQZygZv_KpC-x97B_1r39lgBTGY';
                this.supabase = supabase.createClient(this.supabaseUrl, this.supabaseKey);
                this.isOnline = false;
                this.isRealtimeEnabled = false;
                this.realtimeSubscriptions = [];
            }

            // æ£€æŸ¥ç½‘ç»œçŠ¶æ€
            async checkConnection() {
                try {
                    const { error } = await this.supabase.from('employees').select('count').limit(1);
                    this.isOnline = !error;
                    this.updateStatusIndicator();
                    return this.isOnline;
                } catch (error) {
                    this.isOnline = false;
                    this.updateStatusIndicator();
                    console.warn('ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°æ¨¡å¼');
                    return false;
                }
            }

            // æ›´æ–°çŠ¶æ€æŒ‡ç¤ºå™¨
            updateStatusIndicator() {
                const indicator = document.getElementById('syncStatusIndicator');
                if (indicator) {
                    indicator.className = `sync-status ${this.isOnline ? 'status-online' : 'status-offline'}`;
                    indicator.title = this.isOnline ? 'äº‘ç«¯è¿æ¥æ­£å¸¸' : 'äº‘ç«¯è¿æ¥æ–­å¼€';
                }
                
                // æ›´æ–°äº‘ç«¯çŠ¶æ€æ–‡æœ¬
                const statusText = document.getElementById('cloudStatusText');
                if (statusText) {
                    statusText.textContent = this.isOnline ? 'å·²è¿æ¥' : 'æœªè¿æ¥';
                    statusText.style.color = this.isOnline ? '#27ae60' : '#e74c3c';
                }

                // æ›´æ–°å®æ—¶åŒæ­¥çŠ¶æ€
                const realtimeStatusText = document.getElementById('realtimeStatusText');
                const realtimeIndicator = document.getElementById('realtimeIndicator');
                if (realtimeStatusText && realtimeIndicator) {
                    if (this.isRealtimeEnabled && this.isOnline) {
                        realtimeStatusText.textContent = 'å·²å¼€å¯';
                        realtimeStatusText.style.color = '#27ae60';
                        realtimeIndicator.style.display = 'inline-block';
                    } else {
                        realtimeStatusText.textContent = this.isOnline ? 'æœªå¼€å¯' : 'è¿æ¥æ–­å¼€';
                        realtimeStatusText.style.color = this.isOnline ? '#f39c12' : '#e74c3c';
                        realtimeIndicator.style.display = 'none';
                    }
                }
            }

            // å¼€å¯å®æ—¶åŒæ­¥
            async enableRealtimeSync() {
                if (!this.isOnline) {
                    showNotification('è¯·å…ˆç¡®ä¿äº‘ç«¯è¿æ¥æ­£å¸¸', 'error');
                    return false;
                }

                try {
                    // è®¢é˜… work_records è¡¨çš„å˜åŒ–
                    const workRecordsSubscription = this.supabase
                        .channel('work-records-changes')
                        .on(
                            'postgres_changes',
                            {
                                event: '*', // INSERT, UPDATE, DELETE
                                schema: 'public',
                                table: 'work_records'
                            },
                            (payload) => {
                                console.log('work_records å‘ç”Ÿå˜åŒ–:', payload);
                                this.handleWorkRecordsChange(payload);
                            }
                        )
                        .subscribe((status) => {
                            if (status === 'SUBSCRIBED') {
                                console.log('å®æ—¶è®¢é˜… work_records å·²å¼€å¯');
                            }
                        });

                    // è®¢é˜… employees è¡¨çš„å˜åŒ–
                    const employeesSubscription = this.supabase
                        .channel('employees-changes')
                        .on(
                            'postgres_changes',
                            {
                                event: '*',
                                schema: 'public',
                                table: 'employees'
                            },
                            (payload) => {
                                console.log('employees å‘ç”Ÿå˜åŒ–:', payload);
                                this.handleEmployeesChange(payload);
                            }
                        )
                        .subscribe((status) => {
                            if (status === 'SUBSCRIBED') {
                                console.log('å®æ—¶è®¢é˜… employees å·²å¼€å¯');
                            }
                        });

                    // è®¢é˜… wechat_scans è¡¨çš„å˜åŒ–
                    const wechatScansSubscription = this.supabase
                        .channel('wechat-scans-changes')
                        .on(
                            'postgres_changes',
                            {
                                event: 'INSERT',
                                schema: 'public',
                                table: 'wechat_scans'
                            },
                            (payload) => {
                                console.log('wechat_scans æ–°å¢è®°å½•:', payload);
                                this.handleWechatScansChange(payload);
                            }
                        )
                        .subscribe((status) => {
                            if (status === 'SUBSCRIBED') {
                                console.log('å®æ—¶è®¢é˜… wechat_scans å·²å¼€å¯');
                            }
                        });

                    // ã€æ–°å¢ã€‘è®¢é˜… scanners è¡¨çš„å˜åŒ–
                    const scannersSubscription = this.supabase
                        .channel('scanners-changes')
                        .on(
                            'postgres_changes',
                            {
                                event: '*',
                                schema: 'public',
                                table: 'scanners'
                            },
                            (payload) => {
                                console.log('scanners å‘ç”Ÿå˜åŒ–:', payload);
                                this.handleScannersChange(payload); // æ–°å¢å¤„ç†å™¨
                            }
                        )
                        .subscribe((status) => {
                            if (status === 'SUBSCRIBED') {
                                console.log('å®æ—¶è®¢é˜… scanners å·²å¼€å¯');
                            }
                        });

                    this.realtimeSubscriptions = [
                        workRecordsSubscription,
                        employeesSubscription,
                        wechatScansSubscription,
                        scannersSubscription
                    ];

                    this.isRealtimeEnabled = true;
                    this.updateStatusIndicator();
                    showNotification('å®æ—¶åŒæ­¥å·²å¼€å¯', 'success');
                    return true;

                } catch (error) {
                    console.error('å¼€å¯å®æ—¶åŒæ­¥å¤±è´¥:', error);
                    showNotification('å¼€å¯å®æ—¶åŒæ­¥å¤±è´¥', 'error');
                    return false;
                }
            }

            // å…³é—­å®æ—¶åŒæ­¥
            disableRealtimeSync() {
                this.realtimeSubscriptions.forEach(subscription => {
                    if (subscription) {
                        this.supabase.removeChannel(subscription);
                    }
                });
                this.realtimeSubscriptions = [];
                this.isRealtimeEnabled = false;
                this.updateStatusIndicator();
                showNotification('å®æ—¶åŒæ­¥å·²å…³é—­', 'success');
            }

            // å¤„ç† work_records å˜åŒ–
            handleWorkRecordsChange(payload) {
                const { eventType, new: newRecord, old: oldRecord } = payload;
                
                // å¿½ç•¥æœ¬åœ°è§¦å‘çš„å˜æ›´ï¼ˆé€šè¿‡æ—¶é—´æˆ³åˆ¤æ–­ï¼‰
                const isLocalChange = newRecord && newRecord.last_updated && 
                                    (Date.now() - new Date(newRecord.last_updated).getTime()) < 5000;
                
                if (isLocalChange) {
                    console.log('å¿½ç•¥æœ¬åœ°è§¦å‘çš„å˜æ›´');
                    return;
                }

                switch (eventType) {
                    case 'INSERT':
                    case 'UPDATE':
                        if (newRecord) {
                            // æ›´æ–°æœ¬åœ° workRecords
                            const employeeId = newRecord.employee_id;
                            const existingRecord = workRecords[employeeId];
                            
                            // å†²çªè§£å†³ï¼šä½¿ç”¨æœ€æ–°çš„æ—¶é—´æˆ³
                            if (!existingRecord || 
                                !existingRecord.lastUpdated || 
                                new Date(newRecord.last_updated) > new Date(existingRecord.lastUpdated)) {
                                
                                workRecords[employeeId] = {
                                    totalHours: newRecord.total_hours || 0,
                                    todayHours: newRecord.today_hours || 0,
                                    isWorking: newRecord.is_working || false,
                                    startTime: newRecord.start_time ? new Date(newRecord.start_time).getTime() : null,
                                    history: newRecord.history || [],
                                    lastUpdated: newRecord.last_updated || new Date().toISOString()
                                };
                                
                                // ä¿å­˜åˆ° localStorage
                                localStorage.setItem('workRecords', JSON.stringify(workRecords));
                                
                                // æ›´æ–°UI
                                renderEmployeeList();
                                updateTotalHours();
                                updateStats();
                                
                                showNotification(`å‘˜å·¥ ${employeeId} çš„å·¥æ—¶è®°å½•å·²ä»äº‘ç«¯æ›´æ–°`, 'success');
                                addSystemLog(`äº‘ç«¯åŒæ­¥: å‘˜å·¥ ${employeeId} å·¥æ—¶è®°å½•æ›´æ–°`);
                            }
                        }
                        break;
                        
                    case 'DELETE':
                        if (oldRecord && workRecords[oldRecord.employee_id]) {
                            delete workRecords[oldRecord.employee_id];
                            localStorage.setItem('workRecords', JSON.stringify(workRecords));
                            renderEmployeeList();
                            updateTotalHours();
                            updateStats();
                            showNotification(`å‘˜å·¥ ${oldRecord.employee_id} çš„å·¥æ—¶è®°å½•å·²ä»äº‘ç«¯åˆ é™¤`, 'success');
                        }
                        break;
                }
            }

            // å¤„ç† employees å˜åŒ–
            handleEmployeesChange(payload) {
                const { eventType, new: newEmployee, old: oldEmployee } = payload;
                
                switch (eventType) {
                    case 'INSERT':
                    case 'UPDATE':
                        if (newEmployee) {
                            // æ›´æ–°æœ¬åœ° employees æ•°ç»„
                            const index = employees.findIndex(emp => emp.id === newEmployee.id);
                            if (index >= 0) {
                                employees[index] = { 
                                    name: newEmployee.name, 
                                    id: newEmployee.id 
                                };
                            } else {
                                employees.push({ 
                                    name: newEmployee.name, 
                                    id: newEmployee.id 
                                });
                            }
                            
                            localStorage.setItem('employees', JSON.stringify(employees));
                            renderEmployeeList();
                            updateEmployeeSelect();
                            updateStats();
                            
                            showNotification(`å‘˜å·¥ ${newEmployee.name} ä¿¡æ¯å·²ä»äº‘ç«¯æ›´æ–°`, 'success');
                            addSystemLog(`äº‘ç«¯åŒæ­¥: å‘˜å·¥ ${newEmployee.name} ä¿¡æ¯æ›´æ–°`);
                        }
                        break;
                        
                    case 'DELETE':
                        if (oldEmployee) {
                            employees = employees.filter(emp => emp.id !== oldEmployee.id);
                            localStorage.setItem('employees', JSON.stringify(employees));
                            renderEmployeeList();
                            updateEmployeeSelect();
                            updateStats();
                            showNotification(`å‘˜å·¥ ${oldEmployee.id} å·²ä»äº‘ç«¯åˆ é™¤`, 'success');
                        }
                        break;
                }
            }

            // å¤„ç† wechat_scans å˜åŒ–
            handleWechatScansChange(payload) {
                if (payload.eventType === 'INSERT' && payload.new) {
                    const scan = payload.new;
                    
                    // ä»äº‘ç«¯é‡æ–°åŒæ­¥å·¥ä½œè®°å½•ï¼Œç¡®ä¿æ•°æ®æœ€æ–°
                    this.syncWorkRecordsFromCloud().then(() => {
                        // æ›´æ–°ç•Œé¢
                        renderEmployeeList();
                        updateTotalHours();
                        updateStats();
                        loadWechatScans();
                        
                        // æ˜¾ç¤ºé€šçŸ¥
                        const employee = employees.find(emp => emp.id === scan.employee_id);
                        if (employee) {
                            showNotification(`å‘˜å·¥ ${employee.name} å¾®ä¿¡æ‰«ç è€ƒå‹¤å·²æ›´æ–°`, 'success');
                            addSystemLog(`å¾®ä¿¡æ‰«ç : å‘˜å·¥ ${employee.name} æ‰«ç è€ƒå‹¤`);
                        }
                    });
                }
            }
            
            // ã€æ–°å¢ã€‘å¤„ç† scanners å˜åŒ–
            handleScannersChange(payload) {
                const { eventType, new: newScanner, old: oldScanner } = payload;
                
                switch (eventType) {
                    case 'INSERT':
                    case 'UPDATE':
                        if (newScanner) {
                            const index = engineers.findIndex(eng => eng.id === newScanner.id);
                            if (index >= 0) {
                                engineers[index] = { name: newScanner.name, id: newScanner.id };
                            } else {
                                engineers.push({ name: newScanner.name, id: newScanner.id });
                            }
                            localStorage.setItem('engineers', JSON.stringify(engineers));
                            renderEmployeeList();
                            updateStats();
                            showNotification(`å·¥ç¨‹å¸ˆ ${newScanner.name} ä¿¡æ¯å·²ä»äº‘ç«¯æ›´æ–°`, 'success');
                            addSystemLog(`äº‘ç«¯åŒæ­¥: å·¥ç¨‹å¸ˆ ${newScanner.name} ä¿¡æ¯æ›´æ–°`);
                        }
                        break;
                        
                    case 'DELETE':
                        if (oldScanner) {
                            engineers = engineers.filter(eng => eng.id !== oldScanner.id);
                            localStorage.setItem('engineers', JSON.stringify(engineers));
                            renderEmployeeList();
                            updateStats();
                            showNotification(`å·¥ç¨‹å¸ˆ ${oldScanner.id} å·²ä»äº‘ç«¯åˆ é™¤`, 'success');
                        }
                        break;
                }
            }

            // åŒæ­¥æ‰€æœ‰æ•°æ®
            async syncAllData() {
                if (!(await this.checkConnection())) {
                    showNotification('äº‘ç«¯è¿æ¥å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°æ•°æ®', 'error');
                    return false;
                }

                try {
                    // ä»äº‘ç«¯ä¸‹è½½å‘˜å·¥æ•°æ® (å·¥äºº)
                    const { data: employees, error: empError } = await this.supabase
                        .from('employees')
                        .select('*');
                    
                    if (!empError && employees && employees.length >= 0) {
                        localStorage.setItem('employees', JSON.stringify(employees));
                    }
                    
                    // ã€æ–°å¢ã€‘ä»äº‘ç«¯ä¸‹è½½æ‰«æè€…æ•°æ® (å·¥ç¨‹å¸ˆ)
                    await this.syncScannersFromCloud(); 

                    // ä»äº‘ç«¯ä¸‹è½½å·¥æ—¶è®°å½•
                    await this.syncWorkRecordsFromCloud();
                    
                    // é‡æ–°åŠ è½½æœ¬åœ°æ•°æ®ï¼ˆè¦†ç›–å…¨å±€å˜é‡ï¼‰
                    window.employees = JSON.parse(localStorage.getItem('employees')) || [];
                    window.engineers = JSON.parse(localStorage.getItem('engineers')) || [];

                    showNotification('æ•°æ®åŒæ­¥å®Œæˆ', 'success');
                    addSystemLog('ä»äº‘ç«¯åŒæ­¥æ‰€æœ‰æ•°æ®');
                    return true;
                } catch (error) {
                    console.error('åŒæ­¥å¤±è´¥:', error);
                    showNotification('åŒæ­¥å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°æ•°æ®', 'error');
                    return false;
                }
            }

            // ä»äº‘ç«¯åŒæ­¥å·¥ä½œè®°å½•
            async syncWorkRecordsFromCloud() {
                try {
                    const { data: records, error } = await this.supabase
                        .from('work_records')
                        .select('*');

                    if (!error && records) {
                        // æ›´æ–°æœ¬åœ° workRecords
                        const newWorkRecords = {};
                        records.forEach(record => {
                            newWorkRecords[record.employee_id] = {
                                totalHours: record.total_hours || 0,
                                todayHours: record.today_hours || 0,
                                isWorking: record.is_working || false,
                                startTime: record.start_time ? new Date(record.start_time).getTime() : null,
                                history: record.history || [],
                                lastUpdated: record.last_updated || new Date().toISOString()
                            };
                        });
                        
                        workRecords = newWorkRecords;
                        localStorage.setItem('workRecords', JSON.stringify(newWorkRecords)); // ä¿®å¤ï¼šå­˜å‚¨ newWorkRecords
                        return true;
                    }
                } catch (error) {
                    console.error('ä»äº‘ç«¯åŒæ­¥å·¥ä½œè®°å½•å¤±è´¥:', error);
                    return false;
                }
            }
            
            // ã€æ–°å¢ã€‘ä»äº‘ç«¯åŒæ­¥æ‰«æè€…è®°å½•
            async syncScannersFromCloud() {
                try {
                    const { data: scanners, error } = await this.supabase
                        .from('scanners')
                        .select('*');

                    if (!error && scanners) {
                        window.engineers = scanners.map(scan => ({
                            name: scan.name,
                            id: scan.id
                        }));
                        localStorage.setItem('engineers', JSON.stringify(window.engineers));
                        return true;
                    }
                } catch (error) {
                    console.error('ä»äº‘ç«¯åŒæ­¥æ‰«æè€…è®°å½•å¤±è´¥:', error);
                    return false;
                }
            }

            // **å¼ºåŒ–ä¸Šä¼ æ–¹æ³• 1: ä¸Šä¼ å‘˜å·¥æ•°æ® (å·¥äºº)**
            async uploadEmployees() {
                if (!this.isOnline) return false;

                try {
                    const localEmployees = JSON.parse(localStorage.getItem('employees')) || [];
                    
                    // ç¡®ä¿ä¸Šä¼ çš„æ•°æ®ç»“æ„åªåŒ…å« 'id' and 'name'
                    const employeesToUpload = localEmployees.map(emp => ({
                        id: emp.id,
                        name: emp.name,
                    }));

                    if (employeesToUpload.length > 0) {
                        // ä½¿ç”¨ upsert ç¡®ä¿æ–°å‘˜å·¥è¢«æ’å…¥ï¼Œæ—§å‘˜å·¥è¢«æ›´æ–°
                        const { data, error } = await this.supabase
                            .from('employees')
                            .upsert(employeesToUpload, { onConflict: 'id' })
                            .select(); 
                        
                        if (error) {
                            console.error('ä¸Šä¼ å‘˜å·¥æ•°æ®å¤±è´¥è¯¦æƒ…:', error);
                            throw error;
                        }
                    }
                    return true;
                } catch (error) {
                    console.error('ä¸Šä¼ å‘˜å·¥æ•°æ®å¤±è´¥:', error);
                    showNotification(`ä¸Šä¼ å·¥äººæ•°æ®å¤±è´¥: ${error.message || 'æœªçŸ¥é”™è¯¯'}`, 'error');
                    return false;
                }
            }

            // ä¸Šä¼ å·¥æ—¶è®°å½•
            async uploadWorkRecords() {
                if (!this.isOnline) return false;

                try {
                    const workRecords = JSON.parse(localStorage.getItem('workRecords')) || {};
                    const records = [];

                    for (const [employeeId, record] of Object.entries(workRecords)) {
                        records.push({
                            employee_id: employeeId,
                            total_hours: parseFloat(record.totalHours || 0),
                            today_hours: parseFloat(record.todayHours || 0),
                            is_working: record.isWorking || false,
                            start_time: record.startTime ? new Date(record.startTime).toISOString() : null,
                            history: record.history || [],
                            last_updated: new Date().toISOString()
                        });
                    }

                    if (records.length > 0) {
                        const { error } = await this.supabase
                            .from('work_records')
                            .upsert(records, { onConflict: 'employee_id' });
                        
                        if (error) throw error;
                    }
                    return true;
                } catch (error) {
                    console.error('ä¸Šä¼ å·¥æ—¶è®°å½•å¤±è´¥:', error);
                    return false;
                }
            }
            
            // **å¼ºåŒ–ä¸Šä¼ æ–¹æ³• 2: ä¸Šä¼ æ‰«æè€…æ•°æ® (å·¥ç¨‹å¸ˆ)**
            async uploadScanners() {
                if (!this.isOnline) return false;

                try {
                    const localEngineers = JSON.parse(localStorage.getItem('engineers')) || [];
                    
                    // ç¡®ä¿ä¸Šä¼ çš„æ•°æ®ç»“æ„åªåŒ…å« 'id' å’Œ 'name'
                    const scannersToUpload = localEngineers.map(eng => ({
                        id: eng.id,
                        name: eng.name,
                        last_updated: new Date().toISOString()
                    }));

                    if (scannersToUpload.length > 0) {
                        const { data, error } = await this.supabase
                            .from('scanners')
                            .upsert(scannersToUpload, { onConflict: 'id' })
                            .select(); 
                        
                        if (error) {
                            console.error('ä¸Šä¼ å·¥ç¨‹å¸ˆæ•°æ®å¤±è´¥è¯¦æƒ…:', error);
                            throw error;
                        }
                    }
                    return true;
                } catch (error) {
                    console.error('ä¸Šä¼ æ‰«æè€…æ•°æ®å¤±è´¥:', error);
                    showNotification(`ä¸Šä¼ å·¥ç¨‹å¸ˆæ•°æ®å¤±è´¥: ${error.message || 'æœªçŸ¥é”™è¯¯'}`, 'error');
                    return false;
                }
            }

            // ä¸Šä¼ æ‰€æœ‰æ•°æ®
            async uploadAllData() {
                if (!(await this.checkConnection())) {
                    showNotification('äº‘ç«¯è¿æ¥å¤±è´¥ï¼Œæ•°æ®ä¿å­˜åœ¨æœ¬åœ°', 'error');
                    return false;
                }

                try {
                    // ç¡®ä¿å‘˜å·¥å’Œå·¥ç¨‹å¸ˆæ•°æ®ä¼˜å…ˆä¸Šä¼ å®Œæˆ
                    const empSuccess = await this.uploadEmployees();
                    const scanSuccess = await this.uploadScanners();
                    
                    if (!empSuccess || !scanSuccess) {
                        throw new Error('éƒ¨åˆ†äººå‘˜ä¿¡æ¯ä¸Šä¼ å¤±è´¥');
                    }
                    
                    // å†ä¸Šä¼ å·¥æ—¶è®°å½•
                    await this.uploadWorkRecords();
                    
                    console.log('æ‰€æœ‰æ•°æ®å·²ä¸Šä¼ åˆ°äº‘ç«¯');
                    showNotification('æ•°æ®å·²åŒæ­¥åˆ°äº‘ç«¯', 'success');
                    addSystemLog('ä¸Šä¼ æ‰€æœ‰æ•°æ®åˆ°äº‘ç«¯');
                    return true;
                } catch (error) {
                    console.error('ä¸Šä¼ æ•°æ®å¤±è´¥:', error);
                    showNotification('ä¸Šä¼ åˆ°äº‘ç«¯å¤±è´¥', 'error');
                    return false;
                }
            }

            // åˆ é™¤å·¥äººï¼ˆäº‘ç«¯ï¼‰
            async deleteWorker(employeeId) {
                if (!this.isOnline) return false;

                try {
                    // å…ˆåˆ é™¤å·¥æ—¶è®°å½•
                    const { error: recError } = await this.supabase
                        .from('work_records')
                        .delete()
                        .eq('employee_id', employeeId);
                    
                    if (recError) throw recError;

                    // å†åˆ é™¤å‘˜å·¥
                    const { error: empError } = await this.supabase
                        .from('employees')
                        .delete()
                        .eq('id', employeeId);
                    
                    if (empError) throw empError;

                    return true;
                } catch (error) {
                    console.error('åˆ é™¤å·¥äººå¤±è´¥:', error);
                    return false;
                }
            }

            // ã€æ–°å¢ã€‘åˆ é™¤æ‰«æè€…ï¼ˆäº‘ç«¯ï¼‰
            async deleteScanner(scannerId) {
                if (!this.isOnline) return false;

                try {
                    const { error: scanError } = await this.supabase
                        .from('scanners')
                        .delete()
                        .eq('id', scannerId);
                    
                    if (scanError) throw scanError;

                    return true;
                } catch (error) {
                    console.error('åˆ é™¤å·¥ç¨‹å¸ˆå¤±è´¥:', error);
                    return false;
                }
            }

            // æ£€æŸ¥äº‘ç«¯æ›´æ–°ï¼ˆæ‰‹åŠ¨ï¼‰
            async checkForUpdates() {
                if (!this.isOnline) {
                    showNotification('äº‘ç«¯è¿æ¥å¤±è´¥', 'error');
                    return;
                }

                showNotification('æ­£åœ¨æ£€æŸ¥äº‘ç«¯æ›´æ–°...', 'success');
                
                try {
                    // è·å–æœ¬åœ°æœ€ååŒæ­¥æ—¶é—´
                    const lastSyncTime = localStorage.getItem('lastCloudSyncTime') || 0;
                    
                    // æ£€æŸ¥æ›´æ–°çš„å·¥ä½œè®°å½•
                    const { data: updatedRecords, error } = await this.supabase
                        .from('work_records')
                        .select('*')
                        .gt('last_updated', new Date(parseInt(lastSyncTime)).toISOString());
                    
                    let updateCount = 0;
                    
                    if (!error && updatedRecords && updatedRecords.length > 0) {
                        updateCount += updatedRecords.length;
                        
                        // æ›´æ–°æœ¬åœ°æ•°æ®
                        updatedRecords.forEach(record => {
                            workRecords[record.employee_id] = {
                                totalHours: record.total_hours || 0,
                                todayHours: record.today_hours || 0,
                                isWorking: record.is_working || false,
                                startTime: record.start_time ? new Date(record.start_time).getTime() : null,
                                history: record.history || [],
                                lastUpdated: record.last_updated || new Date().toISOString()
                            };
                        });
                        
                        localStorage.setItem('workRecords', JSON.stringify(workRecords));
                    }
                    
                    // æ›´æ–°æœ€ååŒæ­¥æ—¶é—´
                    localStorage.setItem('lastCloudSyncTime', Date.now());
                    
                    if (updateCount > 0) {
                        // æ›´æ–°UI
                        renderEmployeeList();
                        updateTotalHours();
                        updateStats();
                        
                        showNotification(`å‘ç° ${updateCount} æ¡äº‘ç«¯æ›´æ–°`, 'success');
                        addSystemLog(`æ‰‹åŠ¨æ£€æŸ¥: å‘ç° ${updateCount} æ¡äº‘ç«¯æ›´æ–°`);
                    } else {
                        showNotification('æ²¡æœ‰å‘ç°æ–°çš„äº‘ç«¯æ›´æ–°', 'success');
                    }
                    
                } catch (error) {
                    console.error('æ£€æŸ¥æ›´æ–°å¤±è´¥:', error);
                    showNotification('æ£€æŸ¥æ›´æ–°å¤±è´¥', 'error');
                }
            }
        }

        // åˆ›å»ºå…¨å±€äº‘åŒæ­¥å®ä¾‹
        const cloudSync = new CloudSync();

        // å…¨å±€å˜é‡ (å·²ä¿®å¤ TypeError)
        let employees = JSON.parse(localStorage.getItem('employees')) || [];
        let engineers = JSON.parse(localStorage.getItem('engineers')) || [];
        
        // ä¿®å¤ä»£ç ï¼šç¡®ä¿åŠ è½½çš„æ•°æ®æ˜¯æ•°ç»„
        if (!Array.isArray(employees)) employees = [];
        if (!Array.isArray(engineers)) engineers = [];
        
        let workRecords = JSON.parse(localStorage.getItem('workRecords')) || {};
        let systemLogs = JSON.parse(localStorage.getItem('systemLogs')) || [];
        let currentEmployeeId = null;
        let lastWechatScanCheck = 0;
        
        // DOMå…ƒç´ 
        const employeeNameInput = document.getElementById('employeeName');
        const employeeIdInput = document.getElementById('employeeId');
        const employeeRoleSelect = document.getElementById('employeeRole');
        const generateQRBtn = document.getElementById('generateQR');
        const clearFormBtn = document.getElementById('clearForm');
        const qrCodeContainer = document.getElementById('qrcode');
        const qrPlaceholder = document.getElementById('qrPlaceholder');
        const employeeList = document.getElementById('employeeList');
        const selectedEmployeeSelect = document.getElementById('selectedEmployee');
        const startWorkBtn = document.getElementById('startWork');
        const pauseWorkBtn = document.getElementById('pauseWork');
        const saveWorkBtn = document.getElementById('saveWork');
        const totalHoursSpan = document.getElementById('totalHours');
        const notification = document.getElementById('notification');
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');
        const totalEmployeesSpan = document.getElementById('totalEmployees');
        const workingEmployeesSpan = document.getElementById('workingEmployees');
        const workRankingList = document.getElementById('workRanking');
        const workHistoryList = document.getElementById('workHistory');
        const systemLogsList = document.getElementById('systemLogs');
        const statTotalEmployees = document.getElementById('statTotalEmployees');
        const statTotalHours = document.getElementById('statTotalHours');
        const statTodayHours = document.getElementById('statTodayHours');
        const statActiveEmployees = document.getElementById('statActiveEmployees');
        const syncToCloudBtn = document.getElementById('syncToCloud');
        const syncFromCloudBtn = document.getElementById('syncFromCloud');
        const checkUpdatesBtn = document.getElementById('checkUpdates');
        const toggleRealtimeBtn = document.getElementById('toggleRealtime');
        const wechatScansList = document.getElementById('wechatScansList');
        
        // **æ–°å¢å·¥èµ„ç»Ÿè®¡ DOM å…ƒç´ **
        const payrollMonthInput = document.getElementById('payrollMonth');
        const calculatePayrollBtn = document.getElementById('calculatePayroll');
        const payrollResultsContainer = document.getElementById('payrollResults');

        // **æ–°å¢ï¼šæ ¹æ® ID è·å–äººå‘˜å§“å (å·¥äººæˆ–å·¥ç¨‹å¸ˆ)**
        function getPersonnelName(id) {
            if (!id) return 'N/A';
            // 1. æœç´¢å·¥äººåˆ—è¡¨
            const worker = employees.find(emp => emp.id === id);
            if (worker) return worker.name;
            // 2. æœç´¢å·¥ç¨‹å¸ˆåˆ—è¡¨
            const engineer = engineers.find(eng => eng.id === id);
            if (engineer) return engineer.name;
            return id; // æ‰¾ä¸åˆ°å§“åå°±è¿”å›å·¥å·
        }

        // æ—¶é—´æ ¼å¼åŒ–å‡½æ•°
        function formatDateTime(timestamp) {
            if (!timestamp) return 'æœªå¼€å§‹';
            const date = new Date(timestamp);
            return date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            });
        }

        function formatTime(timestamp) {
            if (!timestamp) return '';
            const date = new Date(timestamp);
            return date.toLocaleTimeString('zh-CN', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            });
        }

        function formatDate(timestamp) {
            if (!timestamp) return '';
            const date = new Date(timestamp);
            return date.toLocaleDateString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });
        }

        // è·å–ä»Šå¤©çš„æ—¥æœŸå­—ç¬¦ä¸²ï¼ˆç”¨äºåŒºåˆ†ä»Šæ—¥å·¥æ—¶å’Œæ€»å·¥æ—¶ï¼‰
        function getTodayDateString() {
            const today = new Date();
            return today.toISOString().split('T')[0]; // YYYY-MM-DDæ ¼å¼
        }

        // åˆ¤æ–­æ—¶é—´æˆ³æ˜¯å¦æ˜¯ä»Šå¤©
        function isToday(timestamp) {
            if (!timestamp) return false;
            const date = new Date(timestamp);
            const today = new Date();
            return date.toDateString() === today.toDateString();
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async function() {
            // åˆå§‹åŒ–äº‘åŒæ­¥
            await cloudSync.checkConnection();
            
            // å°è¯•ä»äº‘ç«¯åŠ è½½æ•°æ®
            await cloudSync.syncAllData();
            
            // é‡æ–°åŠ è½½æœ¬åœ°æ•°æ®ï¼ˆå¯èƒ½å·²è¢«äº‘ç«¯æ•°æ®æ›´æ–°ï¼‰
            employees = JSON.parse(localStorage.getItem('employees')) || [];
            engineers = JSON.parse(localStorage.getItem('engineers')) || []; 
            if (!Array.isArray(employees)) employees = []; 
            if (!Array.isArray(engineers)) engineers = [];
            workRecords = JSON.parse(localStorage.getItem('workRecords')) || [];
            
            renderEmployeeList();
            updateEmployeeSelect();
            updateTotalHours();
            updateStats();
            renderSystemLogs();
            loadWechatScans();
            
            // ç”ŸæˆäºŒç»´ç æŒ‰é’®äº‹ä»¶
            generateQRBtn.addEventListener('click', generateQRCode);
            
            // æ¸…ç©ºè¡¨å•æŒ‰é’®äº‹ä»¶
            clearFormBtn.addEventListener('click', clearForm);
            
            // å·¥æ—¶ç®¡ç†æŒ‰é’®äº‹ä»¶
            startWorkBtn.addEventListener('click', startWork);
            pauseWorkBtn.addEventListener('click', pauseWork);
            saveWorkBtn.addEventListener('click', saveWork);
            
            // **æ–°å¢ï¼šå·¥èµ„è®¡ç®—æŒ‰é’®äº‹ä»¶**
            if (calculatePayrollBtn) {
                calculatePayrollBtn.addEventListener('click', calculatePayroll);
            }

            // å‘˜å·¥é€‰æ‹©å˜åŒ–äº‹ä»¶
            selectedEmployeeSelect.addEventListener('change', function() {
                currentEmployeeId = this.value;
                if (currentEmployeeId) {
                    renderWorkHistory(currentEmployeeId);
                } else {
                    workHistoryList.innerHTML = '<div class="empty-state">è¯·é€‰æ‹©å‘˜å·¥æŸ¥çœ‹å·¥ä½œè®°å½•</div>';
                }
            });
            
            // äº‘ç«¯åŒæ­¥æŒ‰é’®äº‹ä»¶
            syncToCloudBtn.addEventListener('click', () => cloudSync.uploadAllData());
            syncFromCloudBtn.addEventListener('click', async () => {
                await cloudSync.syncAllData();
                // é‡æ–°åŠ è½½æ•°æ®å¹¶æ›´æ–°UI
                employees = JSON.parse(localStorage.getItem('employees')) || [];
                engineers = JSON.parse(localStorage.getItem('engineers')) || []; 
                if (!Array.isArray(employees)) employees = []; 
                if (!Array.isArray(engineers)) engineers = [];
                workRecords = JSON.parse(localStorage.getItem('workRecords')) || [];
                renderEmployeeList();
                updateEmployeeSelect();
                updateTotalHours();
                updateStats();
                loadWechatScans();
            });

            // æ£€æŸ¥æ›´æ–°æŒ‰é’®äº‹ä»¶
            checkUpdatesBtn.addEventListener('click', () => cloudSync.checkForUpdates());

            // å®æ—¶åŒæ­¥åˆ‡æ¢æŒ‰é’®äº‹ä»¶
            toggleRealtimeBtn.addEventListener('click', async () => {
                if (cloudSync.isRealtimeEnabled) {
                    cloudSync.disableRealtimeSync();
                    toggleRealtimeBtn.textContent = 'å¼€å¯å®æ—¶åŒæ­¥';
                } else {
                    const success = await cloudSync.enableRealtimeSync();
                    if (success) {
                        toggleRealtimeBtn.textContent = 'å…³é—­å®æ—¶åŒæ­¥';
                    }
                }
            });
            
            // æ ‡ç­¾é¡µåˆ‡æ¢äº‹ä»¶
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabId = tab.getAttribute('data-tab');
                    
                    // æ›´æ–°æ ‡ç­¾é¡µçŠ¶æ€
                    tabs.forEach(t => t.classList.remove('active'));
                    tabContents.forEach(tc => tc.classList.remove('active'));
                    
                    tab.classList.add('active');
                    document.getElementById(tabId).classList.add('active');
                    
                    // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
                    if (tabId === 'data-tab') {
                        updateStats();
                    }

                    // å¦‚æœåˆ‡æ¢åˆ°åå°ç®¡ç†ï¼ŒåŠ è½½å¾®ä¿¡æ‰«ç è®°å½•
                    if (tabId === 'admin-tab') {
                        loadWechatScans();
                    }
                });
            });
            
            // å®šæ—¶æ›´æ–°å·¥ä½œæ—¶é—´
            setInterval(() => {
                renderEmployeeList();
                updateTotalHours();
            }, 2000);
            
            // å®šæ—¶åŒæ­¥åˆ°äº‘ç«¯ï¼ˆæ¯2åˆ†é’Ÿï¼‰
            setInterval(async () => {
                await cloudSync.uploadAllData();
            }, 120000);
            
            // æ·»åŠ ç³»ç»Ÿæ—¥å¿—
            addSystemLog('ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ');
        });

        // **æ–°å¢ï¼šè®¡ç®—æœˆå·¥æ—¶å¹¶æ¸²æŸ“æŠ¥è¡¨**
        async function calculatePayroll() {
            const monthInput = payrollMonthInput.value;
            const resultsContainer = payrollResultsContainer;

            if (!monthInput) {
                showNotification('è¯·é€‰æ‹©è¦è®¡ç®—çš„æœˆä»½', 'error');
                return;
            }
            
            // 1. å¼ºåˆ¶ä»äº‘ç«¯åŒæ­¥æœ€æ–°çš„å·¥ä½œè®°å½•ï¼Œç¡®ä¿æ•°æ®å®Œæ•´
            showNotification('æ­£åœ¨åŒæ­¥æœ€æ–°å·¥æ—¶æ•°æ®...', 'success');
            // æ³¨æ„ï¼šè¿™é‡Œè°ƒç”¨çš„æ˜¯ class å†…éƒ¨çš„åŒæ­¥æ–¹æ³•
            await cloudSync.syncWorkRecordsFromCloud();
            
            showNotification('å¼€å§‹è®¡ç®—æœˆå·¥æ—¶...', 'success');

            const [year, month] = monthInput.split('-').map(Number);
            
            // åˆå§‹åŒ–å·¥èµ„ç»Ÿè®¡å¯¹è±¡
            const payrollTotals = {};
            
            for (const employeeId in workRecords) {
                const record = workRecords[employeeId];
                let monthlyHours = 0;
                
                // ç¡®ä¿ history å­—æ®µå­˜åœ¨ä¸”æ˜¯æ•°ç»„
                if (Array.isArray(record.history)) {
                    record.history.forEach(item => {
                        const timestamp = new Date(item.timestamp);
                        
                        // æ£€æŸ¥å†å²è®°å½•æ˜¯å¦å±äºé€‰å®šçš„æœˆä»½å’Œå¹´ä»½
                        if (timestamp.getFullYear() === year && timestamp.getMonth() + 1 === month) {
                            
                            // æ­£åˆ™è¡¨è¾¾å¼åŒ¹é… 'å·¥ä½œæ—¶é•¿: X.XXå°æ—¶' ä¸­çš„æ•°å­—
                            // åªæœ‰åœ¨ä¸‹å·¥/æš‚åœè®°å½•ä¸­æ‰æœ‰å·¥ä½œæ—¶é•¿
                            const match = item.action.match(/å·¥ä½œæ—¶é•¿: (\d+\.?\d*)å°æ—¶/);
                            
                            if (match && match[1]) {
                                const duration = parseFloat(match[1]);
                                monthlyHours += duration;
                            }
                        }
                    });
                }
                
                if (monthlyHours > 0) {
                    payrollTotals[employeeId] = monthlyHours;
                }
            }
            
            renderPayrollTable(payrollTotals, monthInput);
            showNotification('æœˆå·¥æ—¶è®¡ç®—å®Œæˆ', 'success');
        }

        // **æ–°å¢ï¼šæ¸²æŸ“å·¥èµ„ç»Ÿè®¡è¡¨æ ¼**
        function renderPayrollTable(payrollTotals, monthInput) {
            const resultsContainer = payrollResultsContainer;
            const monthName = monthInput.replace('-', 'å¹´') + 'æœˆ';
            
            const employeeIds = Object.keys(payrollTotals).sort((a, b) => payrollTotals[b] - payrollTotals[a]);

            if (employeeIds.length === 0) {
                resultsContainer.innerHTML = `<div class="empty-state">åœ¨ ${monthName} æ²¡æœ‰æ‰¾åˆ°å·¥æ—¶è®°å½•ã€‚</div>`;
                return;
            }
            
            let tableHTML = `
                <h4 style="margin-bottom: 15px;">${monthName} å·¥æ—¶ç»Ÿè®¡è¡¨</h4>
                <table style="width: 100%; border-collapse: collapse; text-align: left;">
                    <thead>
                        <tr style="background: #f0f0f0;">
                            <th style="padding: 10px; border: 1px solid #ddd;">å§“å/å·¥å·</th>
                            <th style="padding: 10px; border: 1px solid #ddd; width: 150px; text-align: right;">æ€»å·¥æ—¶ (å°æ—¶)</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            employeeIds.forEach(employeeId => {
                const name = getPersonnelName(employeeId);
                const hours = payrollTotals[employeeId].toFixed(2);
                
                tableHTML += `
                    <tr>
                        <td style="padding: 10px; border: 1px solid #ddd;">${name} (${employeeId})</td>
                        <td style="padding: 10px; border: 1px solid #ddd; text-align: right; font-weight: bold; color: #3498db;">${hours}</td>
                    </tr>
                `;
            });
            
            tableHTML += `
                    </tbody>
                </table>
            `;

            resultsContainer.innerHTML = tableHTML;
        }

        
        // ç”ŸæˆäºŒç»´ç 
        function generateQRCode() {
            const name = employeeNameInput.value.trim();
            const id = employeeIdInput.value.trim();
            const role = employeeRoleSelect.value; 
            
            // è¾“å…¥éªŒè¯
            const validationError = validateEmployeeInput(name, id);
            if (validationError) {
                showNotification(validationError, 'error');
                return;
            }
            
            // --- è§’è‰²ç‰¹å®šçš„é€»è¾‘å’ŒéªŒè¯ ---
            
            let qrDataUrl = '';
            let successMessage = '';
            
            // æ£€æŸ¥ ID æ˜¯å¦ä¸å¦ä¸€ä¸ªè§’è‰²å†²çª 
            if (role === 'worker' && engineers.some(eng => eng.id === id)) {
                showNotification('è¯¥å·¥å·å·²å­˜åœ¨äºå·¥ç¨‹å¸ˆåˆ—è¡¨ä¸­ï¼Œè¯·å‹¿é‡å¤ä½¿ç”¨', 'error');
                return;
            }
            if (role === 'engineer' && employees.some(emp => emp.id === id)) {
                showNotification('è¯¥å·¥å·å·²å­˜åœ¨äºå·¥äººåˆ—è¡¨ä¸­ï¼Œè¯·å‹¿é‡å¤ä½¿ç”¨', 'error');
                return;
            }

            if (role === 'worker') {
                // 1. å·¥äºº (Worker) é€»è¾‘ï¼šç”Ÿæˆè€ƒå‹¤ç 
                if (employees.some(emp => emp.id === id)) {
                    showNotification('è¯¥å·¥å·å·²å­˜åœ¨äºå·¥äººåˆ—è¡¨ä¸­', 'error');
                    return;
                }

                // æ·»åŠ å·¥äººåˆ°åˆ—è¡¨
                employees.push({ name, id });
                localStorage.setItem('employees', JSON.stringify(employees));

                // URL æŒ‡å‘ scan-success.html (è€ƒå‹¤é¡µé¢)
                const path = `https://irene329zx-ai.github.io/work`;
                qrDataUrl = `${path}/scan-success.html?id=${encodeURIComponent(id)}&name=${encodeURIComponent(name)}`;
                successMessage = 'å·¥äººè€ƒå‹¤äºŒç»´ç å·²ç”Ÿæˆï¼';
                addSystemLog(`æ·»åŠ å·¥äºº: ${name} (${id}) - ç”Ÿæˆè€ƒå‹¤ç `);
                
            } else if (role === 'engineer') {
                // 2. å·¥ç¨‹å¸ˆ (Engineer/Scanner) é€»è¾‘ï¼šç”Ÿæˆèº«ä»½ç 
                if (engineers.some(eng => eng.id === id)) {
                    showNotification('è¯¥å·¥å·å·²å­˜åœ¨äºå·¥ç¨‹å¸ˆåˆ—è¡¨ä¸­', 'error');
                    return;
                }
                
                // æ·»åŠ å·¥ç¨‹å¸ˆåˆ°åˆ—è¡¨
                engineers.push({ name, id });
                localStorage.setItem('engineers', JSON.stringify(engineers));

                // URL **å…³é”®ï¼š** æŒ‡å‘ scanner-session.html (èº«ä»½ç¡®è®¤é¡µé¢)
                const path = `https://irene329zx-ai.github.io/work`;
                qrDataUrl = `${path}/scanner-session.html?id=${encodeURIComponent(id)}`;
                successMessage = 'å·¥ç¨‹å¸ˆèº«ä»½äºŒç»´ç å·²ç”Ÿæˆï¼';
                addSystemLog(`æ·»åŠ å·¥ç¨‹å¸ˆ: ${name} (${id}) - ç”Ÿæˆèº«ä»½ç `);
            }

            // --- å…±åŒçš„ QR Code ç”Ÿæˆå’Œé€šçŸ¥é€»è¾‘ ---
            
            // ç”ŸæˆäºŒç»´ç 
            qrCodeContainer.innerHTML = ''; // æ¸…é™¤æ—§çš„äºŒç»´ç 
            qrPlaceholder.style.display = 'none';
            
            QRCode.toCanvas(document.getElementById('qrcode'), qrDataUrl, {
                width: 200,
                margin: 1,
                color: {
                    dark: '#000000',
                    light: '#FFFFFF'
                }
            }, function(error) {
                if (error) {
                    console.error(error);
                    showNotification('ç”ŸæˆäºŒç»´ç å¤±è´¥', 'error');
                } else {
                    showNotification(successMessage, 'success');
                    
                    // æ— è®ºæ–°å¢å·¥äººè¿˜æ˜¯å·¥ç¨‹å¸ˆï¼Œéƒ½éœ€è¦æ›´æ–°åˆ—è¡¨
                    renderEmployeeList();
                    updateEmployeeSelect();
                    updateStats();
                    
                    // ã€å…³é”®ä¿®å¤ã€‘ç¡®ä¿ç«‹å³ä¸Šä¼ ï¼Œä»¥ä¾¿åç»­è€ƒå‹¤èƒ½æ‰¾åˆ°å‘˜å·¥ID
                    cloudSync.uploadAllData(); 
                }
            });
        }
        
        // è¾“å…¥éªŒè¯
        function validateEmployeeInput(name, id) {
            if (!name || !id) {
                return 'è¯·è¾“å…¥å§“åå’Œå·¥å·';
            }
            
            if (name.length < 2 || name.length > 20) {
                return 'å§“åé•¿åº¦åº”åœ¨2-20å­—ç¬¦ä¹‹é—´';
            }
            
            if (!/^[A-Za-z0-9]{3,10}$/.test(id)) {
                return 'å·¥å·åªèƒ½åŒ…å«å­—æ¯å’Œæ•°å­—ï¼Œé•¿åº¦3-10ä½';
            }
            
            return null;
        }
        
        // æ¸…ç©ºè¡¨å•
        function clearForm() {
            employeeNameInput.value = '';
            employeeIdInput.value = '';
            employeeRoleSelect.value = 'worker';
            qrCodeContainer.innerHTML = '';
            qrPlaceholder.style.display = 'block';
            showNotification('è¡¨å•å·²æ¸…ç©º', 'success');
        }
        
        // ç»‘å®šåˆ é™¤æŒ‰é’®å’Œæ–°å¢çš„æ˜¾ç¤ºäºŒç»´ç æŒ‰é’®çš„äº‹ä»¶
        function bindListEvents() {
            // **æ·»åŠ å·¥äººåˆ é™¤æŒ‰é’®äº‹ä»¶**
            document.querySelectorAll('.delete-worker-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const employeeId = this.getAttribute('data-id');
                    deleteEmployee(employeeId);
                });
            });
            
            // **æ·»åŠ å·¥ç¨‹å¸ˆåˆ é™¤æŒ‰é’®äº‹ä»¶ (æ–°å¢)**
            document.querySelectorAll('.delete-engineer-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const engineerId = this.getAttribute('data-id');
                    deleteEngineer(engineerId); // è°ƒç”¨æ–°çš„åˆ é™¤å‡½æ•°
                });
            });
            
            // **æ–°å¢ï¼šæ˜¾ç¤ºäºŒç»´ç æŒ‰é’®äº‹ä»¶**
            document.querySelectorAll('.show-qr-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = this.getAttribute('data-id');
                    const role = this.getAttribute('data-role');
                    showQRCodeModal(id, role);
                });
            });
        }
        
        // æ¸²æŸ“å‘˜å·¥åˆ—è¡¨ (å·²å¢å¼ºï¼ŒåŒ…å«å·¥ç¨‹å¸ˆåˆ—è¡¨å’ŒäºŒç»´ç æŒ‰é’®)
        function renderEmployeeList() {
            employeeList.innerHTML = '';
            
            // ç»„åˆå·¥äººåˆ—è¡¨
            const workerListHtml = employees.map(employee => {
                const isWorking = workRecords[employee.id] && workRecords[employee.id].isWorking;
                const statusClass = isWorking ? 'status-working' : 'status-idle';
                const statusText = isWorking ? 'å·¥ä½œä¸­' : 'æœªå·¥ä½œ';
                const startTime = workRecords[employee.id] ? workRecords[employee.id].startTime : null;
                
                // è®¡ç®—ä»Šæ—¥å·¥æ—¶å’Œæ€»å·¥æ—¶
                const todayHours = calculateTodayWorkTime(employee.id);
                const totalHours = calculateTotalWorkTime(employee.id);
                
                return `
                    <div class="employee-item" data-role="worker" data-id="${employee.id}">
                        <div class="employee-info">
                            <div class="employee-name">${employee.name} (å·¥äºº)</div>
                            <div class="employee-id">å·¥å·: ${employee.id}</div>
                            <div class="work-time-details">
                                <div class="work-time-item"><span class="work-time-label">ä»Šæ—¥:</span> ${todayHours} å°æ—¶</div>
                                <div class="work-time-item"><span class="work-time-label">æ€»è®¡:</span> ${totalHours} å°æ—¶</div>
                            </div>
                            ${startTime ? `<div class="time-info">å¼€å§‹æ—¶é—´: ${formatDateTime(startTime)}</div>` : ''}
                        </div>
                        <div class="employee-actions">
                            <div class="employee-status ${statusClass}">${statusText}</div>
                            <button class="delete-btn show-qr-btn" data-id="${employee.id}" data-role="worker" style="background-color: #f39c12; min-width: 55px;">äºŒç»´ç </button>
                            <button class="delete-btn delete-worker-btn" data-id="${employee.id}">åˆ é™¤</button>
                        </div>
                    </div>
                `;
            }).join('');

            // ç»„åˆå·¥ç¨‹å¸ˆåˆ—è¡¨
            const engineerListHtml = engineers.map(engineer => {
                return `
                    <div class="employee-item" data-role="engineer" data-id="${engineer.id}">
                        <div class="employee-info">
                            <div class="employee-name">${engineer.name} (å·¥ç¨‹å¸ˆ/æ‰«æè€…)</div>
                            <div class="employee-id">å·¥å·: ${engineer.id}</div>
                        </div>
                        <div class="employee-actions">
                            <button class="delete-btn show-qr-btn" data-id="${engineer.id}" data-role="engineer" style="background-color: #f39c12; min-width: 55px;">äºŒç»´ç </button>
                            <button class="delete-btn delete-engineer-btn" data-id="${engineer.id}">åˆ é™¤</button>
                        </div>
                    </div>
                `;
            }).join('');

            // ç»„åˆåˆ—è¡¨
            if (employees.length === 0 && engineers.length === 0) {
                employeeList.innerHTML = '<div class="empty-state">æš‚æ— äººå‘˜ä¿¡æ¯</div>';
            } else {
                 // é‡æ–°æ¸²æŸ“æ•´ä¸ªåˆ—è¡¨
                 employeeList.innerHTML = workerListHtml + (engineers.length > 0 ? 
                    `<h3 style="margin-top: 20px; padding-bottom: 10px; border-bottom: 1px solid #ddd; color: #2c3e50;">å·¥ç¨‹å¸ˆ/æ‰«æè€…</h3>` + engineerListHtml : '');
            }
            
            // æ›´æ–°ç»Ÿè®¡
            totalEmployeesSpan.textContent = employees.length + engineers.length;
            const workingCount = employees.filter(emp => 
                workRecords[emp.id] && workRecords[emp.id].isWorking
            ).length;
            workingEmployeesSpan.textContent = workingCount;
            
            // æ›´æ–°å·¥æ—¶æ’è¡Œ
            updateWorkRanking();
            
            // ç»‘å®šäº‹ä»¶
            bindListEvents();
        }
        
        // è®¡ç®—å‘˜å·¥ä»Šæ—¥å·¥æ—¶
        function calculateTodayWorkTime(employeeId) {
            if (!workRecords[employeeId]) return 0;
            
            const record = workRecords[employeeId];
            let todayHours = parseFloat(record.todayHours || 0);
            
            // å¦‚æœæ­£åœ¨å·¥ä½œï¼ŒåŠ ä¸Šå½“å‰å·¥ä½œæ—¶é—´
            if (record.isWorking && record.startTime && isToday(record.startTime)) {
                const currentWorkTime = (Date.now() - record.startTime) / (1000 * 60 * 60);
                todayHours += currentWorkTime;
            }
            
            // ä¿ç•™2ä½å°æ•°
            return todayHours.toFixed(2);
        }
        
        // è®¡ç®—å‘˜å·¥æ€»å·¥æ—¶
        function calculateTotalWorkTime(employeeId) {
            if (!workRecords[employeeId]) return 0;
            
            const record = workRecords[employeeId];
            let totalHours = parseFloat(record.totalHours || 0);
            
            // å¦‚æœæ­£åœ¨å·¥ä½œï¼ŒåŠ ä¸Šå½“å‰å·¥ä½œæ—¶é—´
            if (record.isWorking && record.startTime) {
                const currentWorkTime = (Date.now() - record.startTime) / (1000 * 60 * 60);
                totalHours += currentWorkTime;
            }
            
            // ä¿ç•™2ä½å°æ•°
            return totalHours.toFixed(2);
        }
        
        // æ›´æ–°å·¥æ—¶æ’è¡Œ
        function updateWorkRanking() {
            workRankingList.innerHTML = '';
            
            // åªå¯¹å·¥äººè¿›è¡Œå·¥æ—¶æ’è¡Œ
            if (employees.length === 0) {
                workRankingList.innerHTML = '<div class="empty-state">æš‚æ— å·¥äººæ•°æ®</div>';
                return;
            }
            
            // è®¡ç®—æ¯ä¸ªå‘˜å·¥çš„ä»Šæ—¥å·¥æ—¶å¹¶æ’åº
            const rankedEmployees = employees.map(emp => {
                return {
                    ...emp,
                    workTime: parseFloat(calculateTodayWorkTime(emp.id))
                };
            }).sort((a, b) => b.workTime - a.workTime);
            
            rankedEmployees.forEach((emp, index) => {
                const rankItem = document.createElement('div');
                rankItem.className = 'history-item';
                
                rankItem.innerHTML = `
                    <div class="history-date">${index + 1}. ${emp.name}</div>
                    <div class="history-duration">${emp.workTime.toFixed(2)} å°æ—¶</div>
                `;
                
                workRankingList.appendChild(rankItem);
            });
        }
        
        // åˆ é™¤å‘˜å·¥ (å·¥äºº)
        function deleteEmployee(employeeId) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¯¥å·¥äººå—ï¼Ÿæ­¤æ“ä½œå°†åŒæ—¶åˆ é™¤å·¥æ—¶è®°å½•ï¼Œä¸å¯æ¢å¤ã€‚')) {
                const employee = employees.find(emp => emp.id === employeeId);
                
                // ä»å‘˜å·¥åˆ—è¡¨ä¸­ç§»é™¤ (æœ¬åœ°)
                employees = employees.filter(emp => emp.id !== employeeId);
                localStorage.setItem('employees', JSON.stringify(employees));
                
                // ä»å·¥æ—¶è®°å½•ä¸­ç§»é™¤ (æœ¬åœ°)
                if (workRecords[employeeId]) {
                    delete workRecords[employeeId];
                    localStorage.setItem('workRecords', JSON.stringify(workRecords));
                }
                
                // å¦‚æœå½“å‰é€‰æ‹©çš„å‘˜å·¥è¢«åˆ é™¤ï¼Œæ¸…ç©ºé€‰æ‹©
                if (currentEmployeeId === employeeId) {
                    currentEmployeeId = null;
                    selectedEmployeeSelect.value = '';
                }
                
                // æ›´æ–°UI
                renderEmployeeList();
                updateEmployeeSelect();
                updateTotalHours();
                updateStats();
                
                showNotification('å·¥äººå·²åˆ é™¤', 'success');
                addSystemLog(`åˆ é™¤å·¥äºº: ${employee.name} (${employeeId})`);
                
                // ä»äº‘ç«¯åˆ é™¤ (è°ƒç”¨æ–°çš„æ–¹æ³•)
                cloudSync.deleteWorker(employeeId);
            }
        }
        
        // **æ–°å¢ï¼šåˆ é™¤å·¥ç¨‹å¸ˆ**
        function deleteEngineer(engineerId) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¯¥å·¥ç¨‹å¸ˆ/æ‰«æè€…å—ï¼Ÿ')) {
                const engineer = engineers.find(eng => eng.id === engineerId);
                
                // ä»å·¥ç¨‹å¸ˆåˆ—è¡¨ä¸­ç§»é™¤ (æœ¬åœ°)
                engineers = engineers.filter(eng => eng.id !== engineerId);
                localStorage.setItem('engineers', JSON.stringify(engineers));
                
                // æ›´æ–°UI
                renderEmployeeList();
                updateStats(); // æ›´æ–°æ€»äººå‘˜ç»Ÿè®¡æ•°å­—
                
                showNotification('å·¥ç¨‹å¸ˆå·²åˆ é™¤', 'success');
                addSystemLog(`åˆ é™¤å·¥ç¨‹å¸ˆ: ${engineer.name} (${engineerId})`);
                
                // ä»äº‘ç«¯åˆ é™¤ (è°ƒç”¨æ–°çš„æ–¹æ³•)
                cloudSync.deleteScanner(engineerId);
            }
        }

        // æ›´æ–°å‘˜å·¥é€‰æ‹©ä¸‹æ‹‰æ¡†
        function updateEmployeeSelect() {
            selectedEmployeeSelect.innerHTML = '<option value="">-- è¯·é€‰æ‹©å·¥äºº --</option>';
            
            // åªæœ‰å·¥äººå¯ä»¥è¿›è¡Œå·¥æ—¶ç®¡ç†
            employees.forEach(employee => {
                const option = document.createElement('option');
                option.value = employee.id;
                option.textContent = `${employee.name} (${employee.id})`;
                selectedEmployeeSelect.appendChild(option);
            });
        }
        
        // å¼€å§‹å·¥ä½œ
        function startWork() {
            const employeeId = selectedEmployeeSelect.value;
            
            if (!employeeId) {
                showNotification('è¯·å…ˆé€‰æ‹©å·¥äºº', 'error');
                return;
            }
            
            // åˆå§‹åŒ–å‘˜å·¥è®°å½•
            if (!workRecords[employeeId]) {
                workRecords[employeeId] = {
                    totalHours: 0,
                    todayHours: 0,
                    isWorking: false,
                    startTime: null,
                    history: []
                };
            }
            
            const record = workRecords[employeeId];
            
            if (record.isWorking) {
                showNotification('è¯¥å·¥äººå·²åœ¨å·¥ä½œä¸­', 'error');
                return;
            }
            
            // å¼€å§‹è®¡æ—¶
            record.isWorking = true;
            record.startTime = Date.now();
            
            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            localStorage.setItem('workRecords', JSON.stringify(workRecords));
            
            // æ›´æ–°UI
            renderEmployeeList();
            showNotification('å·¥ä½œè®¡æ—¶å·²å¼€å§‹', 'success');
            
            // æ·»åŠ å·¥ä½œå†å²è®°å½•
            const employee = employees.find(emp => emp.id === employeeId);
            addWorkHistory(employeeId, `æ‰‹åŠ¨å¼€å§‹å·¥ä½œ - ${formatDateTime(Date.now())}`);
            
            // æ·»åŠ ç³»ç»Ÿæ—¥å¿—
            addSystemLog(`å·¥äºº ${employee.name} æ‰‹åŠ¨å¼€å§‹å·¥ä½œ`);
            
            // æ›´æ–°å·¥ä½œå†å²æ˜¾ç¤º
            renderWorkHistory(employeeId);
            
            // åŒæ­¥åˆ°äº‘ç«¯
            cloudSync.uploadAllData();
        }
        
        // æš‚åœå·¥ä½œ
        function pauseWork() {
            const employeeId = selectedEmployeeSelect.value;
            
            if (!employeeId) {
                showNotification('è¯·å…ˆé€‰æ‹©å·¥äºº', 'error');
                return;
            }
            
            if (!workRecords[employeeId]) {
                showNotification('è¯¥å·¥äººæ²¡æœ‰å·¥ä½œè®°å½•', 'error');
                return;
            }
            
            const record = workRecords[employeeId];
            
            if (!record.isWorking) {
                showNotification('è¯¥å·¥äººæœªåœ¨å·¥ä½œ', 'error');
                return;
            }
            
            // è®¡ç®—å·¥ä½œæ—¶é—´å¹¶æš‚åœ
            const workTimeHours = (Date.now() - record.startTime) / (1000 * 60 * 60);
            
            // æ›´æ–°å·¥æ—¶è®°å½•
            record.totalHours = parseFloat(record.totalHours || 0) + workTimeHours;
            
            // å¦‚æœæ˜¯ä»Šå¤©çš„å·¥ä½œï¼Œæ›´æ–°ä»Šæ—¥å·¥æ—¶
            if (isToday(record.startTime)) {
                record.todayHours = parseFloat(record.todayHours || 0) + workTimeHours;
            }
            
            record.isWorking = false;
            record.startTime = null;
            
            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            localStorage.setItem('workRecords', JSON.stringify(workRecords));
            
            // æ›´æ–°UI
            renderEmployeeList();
            updateTotalHours();
            showNotification('å·¥ä½œå·²æš‚åœ', 'success');
            
            // æ·»åŠ å·¥ä½œå†å²è®°å½•
            const employee = employees.find(emp => emp.id === employeeId);
            addWorkHistory(employeeId, `æ‰‹åŠ¨æš‚åœå·¥ä½œ - æœ¬æ¬¡å·¥ä½œæ—¶é•¿: ${workTimeHours.toFixed(2)}å°æ—¶`);
            
            // æ·»åŠ ç³»ç»Ÿæ—¥å¿—
            addSystemLog(`å·¥äºº ${employee.name} æ‰‹åŠ¨æš‚åœå·¥ä½œ`);
            
            // æ›´æ–°å·¥ä½œå†å²æ˜¾ç¤º
            renderWorkHistory(employeeId);
            
            // åŒæ­¥åˆ°äº‘ç«¯
            cloudSync.uploadAllData();
        }
        
        // ä¿å­˜å·¥æ—¶
        function saveWork() {
            const employeeId = selectedEmployeeSelect.value;
            
            if (!employeeId) {
                showNotification('è¯·å…ˆé€‰æ‹©å·¥äºº', 'error');
                return;
            }
            
            if (!workRecords[employeeId]) {
                showNotification('è¯¥å·¥äººæ²¡æœ‰å¯ä¿å­˜çš„å·¥æ—¶è®°å½•', 'error');
                return;
            }
            
            // ç¡®ä¿å…ˆæš‚åœè®¡æ—¶
            if (workRecords[employeeId].isWorking) {
                pauseWork();
            }
            
            // ä¿å­˜åˆ°localStorage
            localStorage.setItem('workRecords', JSON.stringify(workRecords));
            
            // æ›´æ–°UI
            updateTotalHours();
            showNotification('å·¥æ—¶è®°å½•å·²ä¿å­˜', 'success');
            
            // æ·»åŠ ç³»ç»Ÿæ—¥å¿—
            const employee = employees.find(emp => emp.id === employeeId);
            addSystemLog(`ä¿å­˜å·¥äºº ${employee.name} çš„å·¥æ—¶è®°å½•`);
            
            // åŒæ­¥åˆ°äº‘ç«¯
            cloudSync.uploadAllData();
        }
        
        // æ·»åŠ å·¥ä½œå†å²è®°å½•
        function addWorkHistory(employeeId, action) {
            if (!workRecords[employeeId].history) {
                workRecords[employeeId].history = [];
            }
            
            workRecords[employeeId].history.push({
                action,
                timestamp: new Date().toISOString()
            });
            
            // æ›´æ–°å·¥ä½œå†å²æ˜¾ç¤º
            renderWorkHistory(employeeId);
        }
        
        // æ¸²æŸ“å·¥ä½œå†å²
        function renderWorkHistory(employeeId) {
            workHistoryList.innerHTML = '';
            
            if (!workRecords[employeeId] || !workRecords[employeeId].history || workRecords[employeeId].history.length === 0) {
                workHistoryList.innerHTML = '<div class="empty-state">æš‚æ— å·¥ä½œè®°å½•</div>';
                return;
            }
            
            const history = workRecords[employeeId].history.slice(-5); // åªæ˜¾ç¤ºæœ€è¿‘5æ¡è®°å½•
            
            history.forEach(item => {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                
                const date = new Date(item.timestamp);
                const timeString = formatDateTime(date.getTime());
                
                historyItem.innerHTML = `
                    <div class="history-date">${item.action}</div>
                    <div class="history-time">${timeString}</div>
                `;
                
                workHistoryList.appendChild(historyItem);
            });
        }
        
        // æ›´æ–°æ€»å·¥æ—¶æ˜¾ç¤º
        function updateTotalHours() {
            let total = 0;
            
            for (const employeeId in workRecords) {
                total += parseFloat(calculateTodayWorkTime(employeeId));
            }
            
            totalHoursSpan.textContent = total.toFixed(2);
        }
        
        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStats() {
            // å‘˜å·¥ç»Ÿè®¡
            statTotalEmployees.textContent = employees.length + engineers.length; // ç»Ÿè®¡å·¥äºº+å·¥ç¨‹å¸ˆæ€»æ•°
            
            // å·¥æ—¶ç»Ÿè®¡
            let totalHours = 0;
            let todayHours = 0;
            let activeEmployees = 0;
            
            for (const employeeId in workRecords) {
                totalHours += parseFloat(calculateTotalWorkTime(employeeId));
                todayHours += parseFloat(calculateTodayWorkTime(employeeId));
                
                if (workRecords[employeeId].isWorking) {
                    activeEmployees++;
                }
            }
            
            statTotalHours.textContent = totalHours.toFixed(2);
            statTodayHours.textContent = todayHours.toFixed(2);
            statActiveEmployees.textContent = activeEmployees;
        }
        
        // æ·»åŠ ç³»ç»Ÿæ—¥å¿—
        function addSystemLog(message) {
            const log = {
                message,
                timestamp: new Date().toISOString()
            };
            
            systemLogs.unshift(log);
            
            // é™åˆ¶æ—¥å¿—æ•°é‡
            if (systemLogs.length > 50) {
                systemLogs.pop();
            }
            
            // ä¿å­˜åˆ°localStorage
            localStorage.setItem('systemLogs', JSON.stringify(systemLogs));
            
            // æ›´æ–°UI
            renderSystemLogs();
        }
        
        // æ¸²æŸ“ç³»ç»Ÿæ—¥å¿—
        function renderSystemLogs() {
            systemLogsList.innerHTML = '';
            
            if (systemLogs.length === 0) {
                systemLogsList.innerHTML = '<div class="empty-state">æš‚æ— ç³»ç»Ÿæ—¥å¿—</div>';
                return;
            }
            
            systemLogs.forEach(log => {
                const logItem = document.createElement('div');
                logItem.className = 'log-item';
                
                const date = new Date(log.timestamp);
                const timeString = formatDateTime(date.getTime());
                
                logItem.innerHTML = `
                    <div>${log.message}</div>
                    <div class="log-time">${timeString}</div>
                `;
                
                systemLogsList.appendChild(logItem);
            });
        }
        
        // æ˜¾ç¤ºé€šçŸ¥
        function showNotification(message, type) {
            notification.textContent = message;
            notification.className = `notification ${type} show`;
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // ==================== äºŒç»´ç æ¨¡æ€çª—å£åŠŸèƒ½ ====================

        // **æ–°å¢ï¼šæ˜¾ç¤ºäºŒç»´ç æ¨¡æ€çª—å£**
        function showQRCodeModal(id, role) {
            const modal = document.getElementById('qrModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalQrContainer = document.getElementById('modalQrcode');
            const modalQrPlaceholder = document.getElementById('modalQrPlaceholder');
            const modalQrLink = document.getElementById('modalQrLink');
            
            const employee = employees.find(e => e.id === id);
            const engineer = engineers.find(e => e.id === id);
            const name = (employee || engineer)?.name || 'N/A';
            
            let qrDataUrl = '';
            const path = `https://irene329zx-ai.github.io/work`;

            if (role === 'worker') {
                modalTitle.textContent = `å·¥äººè€ƒå‹¤ç : ${name} (${id})`;
                qrDataUrl = `${path}/scan-success.html?id=${encodeURIComponent(id)}&name=${encodeURIComponent(name)}`;
            } else if (role === 'engineer') {
                modalTitle.textContent = `å·¥ç¨‹å¸ˆèº«ä»½ç : ${name} (${id})`;
                qrDataUrl = `${path}/scanner-session.html?id=${encodeURIComponent(id)}`;
            }
            
            modalQrContainer.innerHTML = '';
            modalQrPlaceholder.style.display = 'none';
            modalQrLink.textContent = `é“¾æ¥: ${qrDataUrl}`;
            
            // æ£€æŸ¥ canvas å…ƒç´ æ˜¯å¦å­˜åœ¨å¹¶æ˜¯ Canvas
            if (modalQrContainer.getContext) {
                 // ä½¿ç”¨åŸç”Ÿçš„ canvas å…ƒç´ 
                 QRCode.toCanvas(modalQrContainer, qrDataUrl, {
                    width: 200,
                    margin: 1,
                    color: {
                        dark: '#000000',
                        light: '#FFFFFF'
                    }
                }, function(error) {
                    if (error) {
                        console.error(error);
                        modalQrPlaceholder.style.display = 'block';
                        modalQrPlaceholder.textContent = 'ç”ŸæˆäºŒç»´ç å¤±è´¥';
                    } else {
                        modal.style.display = 'block';
                    }
                });
            } else {
                 // å¦‚æœä¸æ˜¯ Canvas å…ƒç´ ï¼Œå¯èƒ½è¢«ä¹‹å‰çš„æ¸²æŸ“è¦†ç›–äº†ï¼Œé‡æ–°åˆ›å»º
                 const canvas = document.createElement('canvas');
                 canvas.id = 'modalQrcode';
                 document.getElementById('modalQrContainer').innerHTML = '';
                 document.getElementById('modalQrContainer').appendChild(canvas);
                 showQRCodeModal(id, role); // é‡æ–°è°ƒç”¨
                 return;
            }
        }
        
        // **æ–°å¢ï¼šå…³é—­æ¨¡æ€çª—å£**
        function closeModal() {
            document.getElementById('qrModal').style.display = 'none';
        }

        // ç‚¹å‡»æ¨¡æ€çª—å£å¤–éƒ¨å…³é—­
        window.onclick = function(event) {
            const modal = document.getElementById('qrModal');
            if (event.target === modal) {
                closeModal();
            }
        }

        // ==================== å¾®ä¿¡æ‰«ç ç›¸å…³åŠŸèƒ½ ====================

        // åŠ è½½å¾®ä¿¡æ‰«ç è®°å½•
        async function loadWechatScans() {
            try {
                // å› ä¸ºæˆ‘ä»¬åªæƒ³æ˜¾ç¤ºæœ€è¿‘çš„è®°å½•ï¼Œä»ç„¶é™åˆ¶æ•°é‡
                const { data: scans, error } = await cloudSync.supabase
                    .from('wechat_scans')
                    .select('*')
                    .order('scan_time', { ascending: false })
                    .limit(5); 

                if (error) {
                    console.error('åŠ è½½å¾®ä¿¡æ‰«ç è®°å½•å¤±è´¥:', error);
                    return;
                }
                
                renderWechatScans(scans || []);
            } catch (error) {
                console.error('åŠ è½½å¾®ä¿¡æ‰«ç è®°å½•å¼‚å¸¸:', error);
            }
        }

        // æ¸²æŸ“å¾®ä¿¡æ‰«ç è®°å½• (å·²æ›´æ–°ï¼šæ˜¾ç¤ºå·¥ç¨‹å¸ˆå§“å)
        function renderWechatScans(scans) {
            wechatScansList.innerHTML = '';

            if (scans.length === 0) {
                wechatScansList.innerHTML = '<div class="empty-state">æš‚æ— å¾®ä¿¡æ‰«ç è®°å½•</div>';
                return;
            }

            scans.forEach(scan => {
                const scanItem = document.createElement('div');
                scanItem.className = 'wechat-scan-item';
                
                // ä½¿ç”¨æ–°å‡½æ•°è·å–å·¥äººå’Œå·¥ç¨‹å¸ˆçš„å§“å
                const workerName = getPersonnelName(scan.employee_id); 
                const scannerName = getPersonnelName(scan.scanner_id); 
                const scanTime = new Date(scan.scan_time).toLocaleString('zh-CN');
                
                // æ˜¾ç¤ºæ‰«æè€…ä¿¡æ¯
                const scannerInfo = scan.scanner_id ? ` (æ‰«æè€…: ${scannerName})` : '';
                const locationInfo = scan.work_location || 'N/A';
                const workTypeInfo = scan.work_type || 'N/A';

                scanItem.innerHTML = `
                    <div><strong>${workerName}</strong> (${scan.employee_id}) ${scannerInfo}</div>
                    <div style="font-size: 13px; color: #2c3e50;">åœ°ç‚¹: ${locationInfo} | å·¥ç§: ${workTypeInfo}</div>
                    <div class="wechat-scan-time">${scanTime}</div>
                `;
                wechatScansList.appendChild(scanItem);
            });
        }
    </script>
</body>
</html>
