<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‘˜å·¥å·¥æ—¶ç®¡ç†ç³»ç»Ÿ</title>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.0/build/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #3498db, #2c3e50);
            color: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        
        .tab-container {
            display: flex;
            margin-bottom: 20px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            background: #f8f9fa;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .tab.active {
            background: #3498db;
            color: white;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }
        
        @media (max-width: 900px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }
        
        .card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        
        .card h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        input[type="text"], select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            transition: border 0.3s;
        }
        
        input[type="text"]:focus, select:focus {
            border-color: #3498db;
            outline: none;
        }
        
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: background-color 0.3s;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        button:hover {
            background-color: #2980b9;
        }
        
        button.secondary {
            background-color: #2ecc71;
        }
        
        button.secondary:hover {
            background-color: #27ae60;
        }
        
        button.danger {
            background-color: #e74c3c;
        }
        
        button.danger:hover {
            background-color: #c0392b;
        }
        
        .qr-container {
            text-align: center;
            margin-top: 20px;
            padding: 15px;
            border: 1px dashed #ddd;
            border-radius: 5px;
            min-height: 200px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        
        #qrcode {
            margin-top: 15px;
        }
        
        .camera-container {
            position: relative;
            margin-top: 20px;
            overflow: hidden;
            border-radius: 5px;
        }
        
        #video {
            width: 100%;
            background-color: #000;
        }
        
        #canvas {
            display: none;
        }
        
        .employee-list {
            margin-top: 20px;
        }
        
        .employee-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .employee-item:last-child {
            border-bottom: none;
        }
        
        .employee-info {
            flex-grow: 1;
        }
        
        .employee-name {
            font-weight: 600;
            font-size: 18px;
        }
        
        .employee-id {
            color: #7f8c8d;
            font-size: 14px;
        }
        
        .employee-status {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .status-working {
            background-color: #e8f6f3;
            color: #27ae60;
        }
        
        .status-idle {
            background-color: #fef9e7;
            color: #f39c12;
        }
        
        .work-time {
            font-size: 14px;
            color: #2c3e50;
            margin-top: 5px;
        }
        
        .logs-container {
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .log-item {
            padding: 10px 15px;
            border-bottom: 1px solid #eee;
            font-size: 14px;
        }
        
        .log-time {
            color: #7f8c8d;
            font-size: 12px;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 5px;
            color: white;
            font-weight: 600;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .notification.success {
            background-color: #2ecc71;
        }
        
        .notification.error {
            background-color: #e74c3c;
        }
        
        .notification.show {
            opacity: 1;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .total-hours {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
            text-align: center;
            font-size: 18px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .employee-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .delete-btn {
            background-color: #e74c3c;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .delete-btn:hover {
            background-color: #c0392b;
        }
        
        .empty-state {
            text-align: center;
            padding: 30px;
            color: #7f8c8d;
        }
        
        .scan-result {
            margin-top: 15px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
            text-align: center;
        }
        
        .scan-result h3 {
            margin-bottom: 10px;
            color: #2c3e50;
        }
        
        .data-management {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }
        
        .data-management h3 {
            margin-bottom: 15px;
            color: #2c3e50;
        }
        
        .stats-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
        }
        
        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            text-align: center;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #3498db;
            margin: 10px 0;
        }
        
        .stat-label {
            font-size: 14px;
            color: #7f8c8d;
        }
        
        .work-history {
            margin-top: 20px;
        }
        
        .history-item {
            padding: 10px 15px;
            border-bottom: 1px solid #eee;
            font-size: 14px;
        }
        
        .history-date {
            font-weight: 600;
            color: #2c3e50;
        }
        
        .history-time {
            color: #7f8c8d;
            font-size: 12px;
        }
        
        .history-duration {
            float: right;
            font-weight: 600;
            color: #3498db;
        }
        
        textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            resize: vertical;
            min-height: 100px;
            margin-bottom: 10px;
        }

        .sync-status {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-online {
            background-color: #2ecc71;
        }
        
        .status-offline {
            background-color: #e74c3c;
        }

        .time-info {
            font-size: 12px;
            color: #7f8c8d;
            margin-top: 3px;
        }
        
        .permission-steps {
            margin: 15px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
        }

        .permission-steps h3 {
            color: #2c3e50;
            margin: 10px 0 5px 0;
        }

        .permission-steps p {
            margin: 2px 0;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>å‘˜å·¥å·¥æ—¶ç®¡ç†ç³»ç»Ÿ <span id="syncStatusIndicator" class="sync-status status-offline"></span></h1>
            <p class="subtitle">å‘˜å·¥ä¿¡æ¯å½•å…¥ Â· äºŒç»´ç è€ƒå‹¤ Â· å·¥æ—¶è®°å½• Â· äº‘ç«¯åŒæ­¥</p>
        </header>
        
        <div class="tab-container">
            <div class="tab active" data-tab="employee-tab">å‘˜å·¥å½•å…¥</div>
            <div class="tab" data-tab="admin-tab">åå°ç®¡ç†</div>
            <div class="tab" data-tab="data-tab">æ•°æ®ç®¡ç†</div>
        </div>
        
        <!-- å‘˜å·¥å½•å…¥é¡µé¢ -->
        <div id="employee-tab" class="tab-content active">
            <div class="card">
                <h2>å‘˜å·¥ä¿¡æ¯å½•å…¥</h2>
                <div class="form-group">
                    <label for="employeeName">å‘˜å·¥å§“å</label>
                    <input type="text" id="employeeName" placeholder="è¯·è¾“å…¥å‘˜å·¥å§“å(2-20ä¸ªå­—ç¬¦)">
                </div>
                <div class="form-group">
                    <label for="employeeId">å‘˜å·¥å·¥å·</label>
                    <input type="text" id="employeeId" placeholder="è¯·è¾“å…¥å‘˜å·¥å·¥å·(å­—æ¯å’Œæ•°å­—)">
                </div>
                <div class="action-buttons">
                    <button id="generateQR">ç”ŸæˆäºŒç»´ç </button>
                    <button id="clearForm" class="danger">æ¸…ç©ºè¡¨å•</button>
                </div>
                
                <div class="qr-container">
                    <p id="qrPlaceholder">ç”Ÿæˆçš„äºŒç»´ç å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ</p>
                    <canvas id="qrcode"></canvas>
                </div>
            </div>
        </div>
        
        <!-- åå°ç®¡ç†é¡µé¢ -->
        <div id="admin-tab" class="tab-content">
            <div class="main-content">
                <div class="left-column">
                    <div class="card">
                        <h2>å‘˜å·¥åˆ—è¡¨</h2>
                        <div class="stats-container">
                            <div class="stat-card">
                                <div class="stat-label">å‘˜å·¥æ€»æ•°</div>
                                <div class="stat-value" id="totalEmployees">0</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">å·¥ä½œä¸­</div>
                                <div class="stat-value" id="workingEmployees">0</div>
                            </div>
                        </div>
                        <div class="employee-list" id="employeeList">
                            <!-- å‘˜å·¥åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                        </div>
                    </div>
                    
                    <div class="card">
                        <h2>ä»Šæ—¥å·¥æ—¶æ’è¡Œ</h2>
                        <div class="work-history" id="workRanking">
                            <!-- å·¥æ—¶æ’è¡Œå°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                        </div>
                    </div>
                </div>
                
                <div class="right-column">
                    <div class="card" id="permissionGuide" style="display: none;">
                        <h2>æ‘„åƒå¤´æƒé™è®¾ç½®æŒ‡å—</h2>
                        <div class="permission-steps">
                            <h3>iOS Safari:</h3>
                            <p>1. ç‚¹å‡»åœ°å€æ å·¦è¾¹çš„"ğŸ”’"å›¾æ ‡</p>
                            <p>2. é€‰æ‹©"ç½‘ç«™è®¾ç½®"</p>
                            <p>3. å…è®¸"æ‘„åƒå¤´"æƒé™</p>
                            
                            <h3>Android Chrome:</h3>
                            <p>1. ç‚¹å‡»å³ä¸Šè§’"..."èœå•</p>
                            <p>2. é€‰æ‹©"ç½‘ç«™è®¾ç½®"</p>
                            <p>3. å…è®¸"æ‘„åƒå¤´"æƒé™</p>
                            
                            <h3>é€šç”¨æ–¹æ³•:</h3>
                            <p>1. åˆ·æ–°é¡µé¢</p>
                            <p>2. å½“å‡ºç°æƒé™å¼¹çª—æ—¶é€‰æ‹©"å…è®¸"</p>
                        </div>
                        <button onclick="hidePermissionGuide()">æˆ‘çŸ¥é“äº†</button>
                    </div>
                    
                    <div class="card">
                        <h2>æ‰«ç è€ƒå‹¤</h2>
                        <div class="action-buttons">
                            <button id="startCamera">å¼€å¯æ‘„åƒå¤´</button>
                            <button id="stopCamera" class="danger">å…³é—­æ‘„åƒå¤´</button>
                        </div>
                        
                        <div class="camera-container">
                            <video id="video" autoplay playsinline></video>
                            <canvas id="canvas"></canvas>
                        </div>
                        
                        <div class="scan-result" id="scanResult">
                            <h3>æ‰«æç»“æœ</h3>
                            <p id="scanResultText">ç­‰å¾…æ‰«æ...</p>
                        </div>
                        
                        <div class="logs-container" id="scanLogs">
                            <!-- æ‰«ææ—¥å¿—å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                        </div>
                    </div>
                    
                    <div class="card">
                        <h2>å·¥æ—¶ç®¡ç†</h2>
                        <div class="form-group">
                            <label for="selectedEmployee">é€‰æ‹©å‘˜å·¥</label>
                            <select id="selectedEmployee" style="width: 100%; padding: 12px; border-radius: 5px; border: 1px solid #ddd; font-size: 16px;">
                                <option value="">-- è¯·é€‰æ‹©å‘˜å·¥ --</option>
                            </select>
                        </div>
                        
                        <div class="action-buttons">
                            <button id="startWork" class="secondary">å¼€å§‹å·¥ä½œ</button>
                            <button id="pauseWork">æš‚åœå·¥ä½œ</button>
                            <button id="saveWork">ä¿å­˜å·¥æ—¶</button>
                        </div>
                        
                        <div class="total-hours">
                            ä»Šæ—¥æ€»å·¥æ—¶: <span id="totalHours">0</span> å°æ—¶
                        </div>
                        
                        <div class="work-history" id="workHistory">
                            <!-- å·¥ä½œå†å²è®°å½•å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- æ•°æ®ç®¡ç†é¡µé¢ -->
        <div id="data-tab" class="tab-content">
            <div class="main-content">
                <div class="left-column">
                    <div class="card">
                        <h2>æ•°æ®å¤‡ä»½</h2>
                        <div class="data-management">
                            <p>å°†ç³»ç»Ÿæ•°æ®å¯¼å‡ºä¸ºJSONæ–‡ä»¶ï¼Œå¯ç”¨äºå¤‡ä»½æˆ–è¿ç§»æ•°æ®ã€‚</p>
                            <div class="action-buttons">
                                <button id="exportData" class="secondary">å¯¼å‡ºæ•°æ®</button>
                                <button id="syncToCloud" class="secondary">åŒæ­¥åˆ°äº‘ç«¯</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h2>æ•°æ®æ¢å¤</h2>
                        <div class="data-management">
                            <p>ä»JSONæ–‡ä»¶å¯¼å…¥æ•°æ®ï¼Œæ¢å¤ç³»ç»ŸçŠ¶æ€ã€‚</p>
                            <div class="form-group">
                                <label for="importData">å¯¼å…¥æ•°æ® (JSONæ ¼å¼)</label>
                                <textarea id="importData" placeholder="è¯·ç²˜è´´JSONæ•°æ®..."></textarea>
                            </div>
                            <div class="action-buttons">
                                <button id="importDataBtn">å¯¼å…¥æ•°æ®</button>
                                <button id="syncFromCloud">ä»äº‘ç«¯åŒæ­¥</button>
                                <button id="clearAllData" class="danger">æ¸…ç©ºæ‰€æœ‰æ•°æ®</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="right-column">
                    <div class="card">
                        <h2>ç³»ç»Ÿç»Ÿè®¡</h2>
                        <div class="stats-container">
                            <div class="stat-card">
                                <div class="stat-label">æ€»å‘˜å·¥æ•°</div>
                                <div class="stat-value" id="statTotalEmployees">0</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">æ€»å·¥æ—¶</div>
                                <div class="stat-value" id="statTotalHours">0</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">ä»Šæ—¥å·¥æ—¶</div>
                                <div class="stat-value" id="statTodayHours">0</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">æ´»è·ƒå‘˜å·¥</div>
                                <div class="stat-value" id="statActiveEmployees">0</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h2>æ“ä½œæ—¥å¿—</h2>
                        <div class="logs-container" id="systemLogs">
                            <!-- ç³»ç»Ÿæ—¥å¿—å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="notification" id="notification"></div>

    <script>
        // Supabaseäº‘åŒæ­¥ç±»
        class CloudSync {
            constructor() {
                // ä½¿ç”¨ä½ æä¾›çš„Supabaseé…ç½®
                this.supabaseUrl = 'https://ynkmlbczkcporjdpawbr.supabase.co';
                this.supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inlua21sYmN6a2Nwb3JqZHBhd2JyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI4NDcwMjUsImV4cCI6MjA3ODQyMzAyNX0.6tkS9oBrg3_1tGzSXQZygZv_KpC-x97B_1r39lgBTGY';
                this.supabase = supabase.createClient(this.supabaseUrl, this.supabaseKey);
                this.isOnline = false;
            }

            // æ£€æŸ¥ç½‘ç»œçŠ¶æ€
            async checkConnection() {
                try {
                    const { error } = await this.supabase.from('employees').select('count').limit(1);
                    this.isOnline = !error;
                    this.updateStatusIndicator();
                    return this.isOnline;
                } catch (error) {
                    this.isOnline = false;
                    this.updateStatusIndicator();
                    console.warn('ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°æ¨¡å¼');
                    return false;
                }
            }

            // æ›´æ–°çŠ¶æ€æŒ‡ç¤ºå™¨
            updateStatusIndicator() {
                const indicator = document.getElementById('syncStatusIndicator');
                if (indicator) {
                    indicator.className = `sync-status ${this.isOnline ? 'status-online' : 'status-offline'}`;
                    indicator.title = this.isOnline ? 'äº‘ç«¯è¿æ¥æ­£å¸¸' : 'äº‘ç«¯è¿æ¥æ–­å¼€';
                }
            }

            // åŒæ­¥æ‰€æœ‰æ•°æ®
            async syncAllData() {
                if (!(await this.checkConnection())) {
                    showNotification('äº‘ç«¯è¿æ¥å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°æ•°æ®', 'error');
                    return false;
                }

                try {
                    // ä»äº‘ç«¯ä¸‹è½½å‘˜å·¥æ•°æ®
                    const { data: employees, error: empError } = await this.supabase
                        .from('employees')
                        .select('*');
                    
                    if (!empError && employees && employees.length > 0) {
                        localStorage.setItem('employees', JSON.stringify(employees));
                    }

                    // ä»äº‘ç«¯ä¸‹è½½å·¥æ—¶è®°å½•
                    const { data: records, error: recError } = await this.supabase
                        .from('work_records')
                        .select('*');
                    
                    if (!recError && records && records.length > 0) {
                        const workRecords = {};
                        records.forEach(record => {
                            workRecords[record.employee_id] = {
                                totalHours: record.total_hours || 0,
                                isWorking: record.is_working || false,
                                startTime: record.start_time ? new Date(record.start_time).getTime() : null,
                                history: record.history || []
                            };
                        });
                        localStorage.setItem('workRecords', JSON.stringify(workRecords));
                    }

                    showNotification('æ•°æ®åŒæ­¥å®Œæˆ', 'success');
                    return true;
                } catch (error) {
                    console.error('åŒæ­¥å¤±è´¥:', error);
                    showNotification('åŒæ­¥å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°æ•°æ®', 'error');
                    return false;
                }
            }

            // ä¸Šä¼ å‘˜å·¥æ•°æ®
            async uploadEmployees() {
                if (!this.isOnline) return false;

                try {
                    const employees = JSON.parse(localStorage.getItem('employees')) || [];
                    
                    if (employees.length > 0) {
                        const { error } = await this.supabase
                            .from('employees')
                            .upsert(employees, { onConflict: 'id' });
                        
                        if (error) throw error;
                    }
                    return true;
                } catch (error) {
                    console.error('ä¸Šä¼ å‘˜å·¥æ•°æ®å¤±è´¥:', error);
                    return false;
                }
            }

            // ä¸Šä¼ å·¥æ—¶è®°å½•
            async uploadWorkRecords() {
                if (!this.isOnline) return false;

                try {
                    const workRecords = JSON.parse(localStorage.getItem('workRecords')) || {};
                    const records = [];

                    for (const [employeeId, record] of Object.entries(workRecords)) {
                        records.push({
                            employee_id: employeeId,
                            total_hours: parseFloat(record.totalHours || 0),
                            is_working: record.isWorking || false,
                            start_time: record.startTime ? new Date(record.startTime).toISOString() : null,
                            history: record.history || [],
                            last_updated: new Date().toISOString()
                        });
                    }

                    if (records.length > 0) {
                        const { error } = await this.supabase
                            .from('work_records')
                            .upsert(records, { onConflict: 'employee_id' });
                        
                        if (error) throw error;
                    }
                    return true;
                } catch (error) {
                    console.error('ä¸Šä¼ å·¥æ—¶è®°å½•å¤±è´¥:', error);
                    return false;
                }
            }

            // ä¸Šä¼ æ‰€æœ‰æ•°æ®
            async uploadAllData() {
                if (!(await this.checkConnection())) {
                    showNotification('äº‘ç«¯è¿æ¥å¤±è´¥ï¼Œæ•°æ®ä¿å­˜åœ¨æœ¬åœ°', 'error');
                    return false;
                }

                try {
                    await this.uploadEmployees();
                    await this.uploadWorkRecords();
                    console.log('æ‰€æœ‰æ•°æ®å·²ä¸Šä¼ åˆ°äº‘ç«¯');
                    showNotification('æ•°æ®å·²åŒæ­¥åˆ°äº‘ç«¯', 'success');
                    return true;
                } catch (error) {
                    console.error('ä¸Šä¼ æ•°æ®å¤±è´¥:', error);
                    showNotification('ä¸Šä¼ åˆ°äº‘ç«¯å¤±è´¥', 'error');
                    return false;
                }
            }

            // åˆ é™¤å‘˜å·¥ï¼ˆäº‘ç«¯ï¼‰
            async deleteEmployee(employeeId) {
                if (!this.isOnline) return false;

                try {
                    // å…ˆåˆ é™¤å·¥æ—¶è®°å½•
                    const { error: recError } = await this.supabase
                        .from('work_records')
                        .delete()
                        .eq('employee_id', employeeId);
                    
                    if (recError) throw recError;

                    // å†åˆ é™¤å‘˜å·¥
                    const { error: empError } = await this.supabase
                        .from('employees')
                        .delete()
                        .eq('id', employeeId);
                    
                    if (empError) throw empError;

                    return true;
                } catch (error) {
                    console.error('åˆ é™¤å‘˜å·¥å¤±è´¥:', error);
                    return false;
                }
            }
        }

        // åˆ›å»ºå…¨å±€äº‘åŒæ­¥å®ä¾‹
        const cloudSync = new CloudSync();

        // å…¨å±€å˜é‡
        let employees = JSON.parse(localStorage.getItem('employees')) || [];
        let workRecords = JSON.parse(localStorage.getItem('workRecords')) || {};
        let systemLogs = JSON.parse(localStorage.getItem('systemLogs')) || [];
        let videoStream = null;
        let currentEmployeeId = null;
        let isScanning = false;
        
        // DOMå…ƒç´ 
        const employeeNameInput = document.getElementById('employeeName');
        const employeeIdInput = document.getElementById('employeeId');
        const generateQRBtn = document.getElementById('generateQR');
        const clearFormBtn = document.getElementById('clearForm');
        const qrCodeContainer = document.getElementById('qrcode');
        const qrPlaceholder = document.getElementById('qrPlaceholder');
        const employeeList = document.getElementById('employeeList');
        const startCameraBtn = document.getElementById('startCamera');
        const stopCameraBtn = document.getElementById('stopCamera');
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const scanLogs = document.getElementById('scanLogs');
        const selectedEmployeeSelect = document.getElementById('selectedEmployee');
        const startWorkBtn = document.getElementById('startWork');
        const pauseWorkBtn = document.getElementById('pauseWork');
        const saveWorkBtn = document.getElementById('saveWork');
        const totalHoursSpan = document.getElementById('totalHours');
        const notification = document.getElementById('notification');
        const scanResultText = document.getElementById('scanResultText');
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');
        const exportDataBtn = document.getElementById('exportData');
        const importDataBtn = document.getElementById('importDataBtn');
        const importDataTextarea = document.getElementById('importData');
        const clearAllDataBtn = document.getElementById('clearAllData');
        const totalEmployeesSpan = document.getElementById('totalEmployees');
        const workingEmployeesSpan = document.getElementById('workingEmployees');
        const workRankingList = document.getElementById('workRanking');
        const workHistoryList = document.getElementById('workHistory');
        const systemLogsList = document.getElementById('systemLogs');
        const statTotalEmployees = document.getElementById('statTotalEmployees');
        const statTotalHours = document.getElementById('statTotalHours');
        const statTodayHours = document.getElementById('statTodayHours');
        const statActiveEmployees = document.getElementById('statActiveEmployees');
        const syncToCloudBtn = document.getElementById('syncToCloud');
        const syncFromCloudBtn = document.getElementById('syncFromCloud');
        
        // æ—¶é—´æ ¼å¼åŒ–å‡½æ•°
        function formatDateTime(timestamp) {
            if (!timestamp) return 'æœªå¼€å§‹';
            const date = new Date(timestamp);
            return date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            });
        }

        function formatTime(timestamp) {
            if (!timestamp) return '';
            const date = new Date(timestamp);
            return date.toLocaleTimeString('zh-CN', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            });
        }

        function formatDate(timestamp) {
            if (!timestamp) return '';
            const date = new Date(timestamp);
            return date.toLocaleDateString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });
        }

        // æƒé™å¼•å¯¼å‡½æ•°
        function showPermissionGuide() {
            document.getElementById('permissionGuide').style.display = 'block';
        }

        function hidePermissionGuide() {
            document.getElementById('permissionGuide').style.display = 'none';
        }

        // æ‘„åƒå¤´æŒ‰é’®é‡ç½®
        function resetCameraButton() {
            startCameraBtn.disabled = false;
            startCameraBtn.textContent = 'å¼€å¯æ‘„åƒå¤´';
        }

        // å¼€å¯æ‘„åƒå¤´ï¼ˆä¼˜åŒ–ç‰ˆï¼‰
        function startCamera() {
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                startCameraBtn.disabled = true;
                startCameraBtn.textContent = 'å¼€å¯ä¸­...';
                
                // å¤šç§æ‘„åƒå¤´é…ç½®å°è¯•
                const constraintsList = [
                    {
                        video: {
                            facingMode: { exact: "environment" }, // å¼ºåˆ¶åç½®
                            width: { ideal: 1280 },
                            height: { ideal: 720 }
                        }
                    },
                    {
                        video: {
                            facingMode: "environment", // ä¼˜å…ˆåç½®
                            width: { ideal: 1280 },
                            height: { ideal: 720 }
                        }
                    },
                    {
                        video: {
                            facingMode: "user", // å‰ç½®æ‘„åƒå¤´
                            width: { ideal: 1280 },
                            height: { ideal: 720 }
                        }
                    },
                    {
                        video: true // é»˜è®¤é…ç½®
                    }
                ];
                
                const tryConstraints = async (index) => {
                    if (index >= constraintsList.length) {
                        showNotification('æ— æ³•è®¿é—®ä»»ä½•æ‘„åƒå¤´', 'error');
                        resetCameraButton();
                        return;
                    }
                    
                    try {
                        const stream = await navigator.mediaDevices.getUserMedia(constraintsList[index]);
                        onCameraSuccess(stream);
                    } catch (error) {
                        console.log(`æ‘„åƒå¤´é…ç½® ${index} å¤±è´¥:`, error);
                        if (index === constraintsList.length - 1) {
                            onCameraError(error);
                        } else {
                            tryConstraints(index + 1);
                        }
                    }
                };
                
                tryConstraints(0);
                
            } else {
                showNotification('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒæ‘„åƒå¤´åŠŸèƒ½', 'error');
                resetCameraButton();
            }
        }

        function onCameraSuccess(stream) {
            videoStream = stream;
            video.srcObject = stream;
            
            video.onloadedmetadata = function() {
                video.play();
                isScanning = true;
                scanQRCode();
                showNotification('æ‘„åƒå¤´å·²å¼€å¯', 'success');
                addSystemLog('å¼€å¯æ‘„åƒå¤´æ‰«æ');
                resetCameraButton();
            };
            
            video.onerror = function() {
                showNotification('è§†é¢‘æ’­æ”¾é”™è¯¯', 'error');
                resetCameraButton();
            };
        }

        function onCameraError(error) {
            console.error('æ‘„åƒå¤´è®¿é—®é”™è¯¯:', error);
            
            let errorMessage = 'æ— æ³•è®¿é—®æ‘„åƒå¤´';
            switch(error.name) {
                case 'NotAllowedError':
                    errorMessage = 'æ‘„åƒå¤´æƒé™è¢«æ‹’ç»';
                    showPermissionGuide();
                    break;
                case 'NotFoundError':
                    errorMessage = 'æœªæ‰¾åˆ°æ‘„åƒå¤´è®¾å¤‡';
                    break;
                case 'NotSupportedError':
                    errorMessage = 'æµè§ˆå™¨ä¸æ”¯æŒæ‘„åƒå¤´åŠŸèƒ½';
                    break;
                case 'NotReadableError':
                    errorMessage = 'æ‘„åƒå¤´è¢«å…¶ä»–åº”ç”¨å ç”¨';
                    break;
                default:
                    errorMessage = `æ‘„åƒå¤´é”™è¯¯: ${error.message}`;
            }
            
            showNotification(errorMessage, 'error');
            resetCameraButton();
        }
        
        // å…³é—­æ‘„åƒå¤´
        function stopCamera() {
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
                videoStream = null;
                video.srcObject = null;
                isScanning = false;
                
                showNotification('æ‘„åƒå¤´å·²å…³é—­', 'success');
                addSystemLog('å…³é—­æ‘„åƒå¤´');
            }
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async function() {
            // åˆå§‹åŒ–äº‘åŒæ­¥
            await cloudSync.checkConnection();
            
            // å°è¯•ä»äº‘ç«¯åŠ è½½æ•°æ®
            await cloudSync.syncAllData();
            
            // é‡æ–°åŠ è½½æœ¬åœ°æ•°æ®ï¼ˆå¯èƒ½å·²è¢«äº‘ç«¯æ•°æ®æ›´æ–°ï¼‰
            employees = JSON.parse(localStorage.getItem('employees')) || [];
            workRecords = JSON.parse(localStorage.getItem('workRecords')) || {};
            
            renderEmployeeList();
            updateEmployeeSelect();
            updateTotalHours();
            updateStats();
            renderSystemLogs();
            
            // ç”ŸæˆäºŒç»´ç æŒ‰é’®äº‹ä»¶
            generateQRBtn.addEventListener('click', generateQRCode);
            
            // æ¸…ç©ºè¡¨å•æŒ‰é’®äº‹ä»¶
            clearFormBtn.addEventListener('click', clearForm);
            
            // æ‘„åƒå¤´æ§åˆ¶æŒ‰é’®äº‹ä»¶
            startCameraBtn.addEventListener('click', startCamera);
            stopCameraBtn.addEventListener('click', stopCamera);
            
            // å·¥æ—¶ç®¡ç†æŒ‰é’®äº‹ä»¶
            startWorkBtn.addEventListener('click', startWork);
            pauseWorkBtn.addEventListener('click', pauseWork);
            saveWorkBtn.addEventListener('click', saveWork);
            
            // å‘˜å·¥é€‰æ‹©å˜åŒ–äº‹ä»¶
            selectedEmployeeSelect.addEventListener('change', function() {
                currentEmployeeId = this.value;
                if (currentEmployeeId) {
                    renderWorkHistory(currentEmployeeId);
                } else {
                    workHistoryList.innerHTML = '<div class="empty-state">è¯·é€‰æ‹©å‘˜å·¥æŸ¥çœ‹å·¥ä½œè®°å½•</div>';
                }
            });
            
            // æ•°æ®ç®¡ç†æŒ‰é’®äº‹ä»¶
            exportDataBtn.addEventListener('click', exportData);
            importDataBtn.addEventListener('click', importData);
            clearAllDataBtn.addEventListener('click', clearAllData);
            syncToCloudBtn.addEventListener('click', () => cloudSync.uploadAllData());
            syncFromCloudBtn.addEventListener('click', async () => {
                await cloudSync.syncAllData();
                // é‡æ–°åŠ è½½æ•°æ®å¹¶æ›´æ–°UI
                employees = JSON.parse(localStorage.getItem('employees')) || [];
                workRecords = JSON.parse(localStorage.getItem('workRecords')) || {};
                renderEmployeeList();
                updateEmployeeSelect();
                updateTotalHours();
                updateStats();
            });
            
            // æ ‡ç­¾é¡µåˆ‡æ¢äº‹ä»¶
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabId = tab.getAttribute('data-tab');
                    
                    // æ›´æ–°æ ‡ç­¾é¡µçŠ¶æ€
                    tabs.forEach(t => t.classList.remove('active'));
                    tabContents.forEach(tc => tc.classList.remove('active'));
                    
                    tab.classList.add('active');
                    document.getElementById(tabId).classList.add('active');
                    
                    // å¦‚æœåˆ‡æ¢åˆ°å‘˜å·¥å½•å…¥é¡µé¢ï¼Œåœæ­¢æ‘„åƒå¤´
                    if (tabId === 'employee-tab' && videoStream) {
                        stopCamera();
                    }
                    
                    // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
                    if (tabId === 'data-tab') {
                        updateStats();
                    }
                });
            });
            
            // å®šæ—¶æ›´æ–°å·¥ä½œæ—¶é—´
            setInterval(() => {
                renderEmployeeList();
                updateTotalHours();
            }, 1000);
            
            // å®šæ—¶åŒæ­¥åˆ°äº‘ç«¯ï¼ˆæ¯2åˆ†é’Ÿï¼‰
            setInterval(async () => {
                await cloudSync.uploadAllData();
            }, 120000);
            
            // æ·»åŠ ç³»ç»Ÿæ—¥å¿—
            addSystemLog('ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ');
        });
        
        // ç”ŸæˆäºŒç»´ç 
        function generateQRCode() {
    const name = employeeNameInput.value.trim();
    const id = employeeIdInput.value.trim();
    
    // è¾“å…¥éªŒè¯
    const validationError = validateEmployeeInput(name, id);
    if (validationError) {
        showNotification(validationError, 'error');
        return;
    }
    
    // æ£€æŸ¥å‘˜å·¥æ˜¯å¦å·²å­˜åœ¨
    if (employees.some(emp => emp.id === id)) {
        showNotification('è¯¥å·¥å·å·²å­˜åœ¨', 'error');
        return;
    }
    
    // æ·»åŠ å‘˜å·¥åˆ°åˆ—è¡¨
    employees.push({ name, id });
    localStorage.setItem('employees', JSON.stringify(employees));
    
    // ç”Ÿæˆå¾®ä¿¡å¯æ‰«æçš„äºŒç»´ç URL
    const successPageUrl = `https://irene329zx-ai.github.io/work/scan-success.html?id=${encodeURIComponent(id)}&name=${encodeURIComponent(name)}`;
    
    // ç”ŸæˆäºŒç»´ç 
    qrPlaceholder.style.display = 'none';
    
    QRCode.toCanvas(document.getElementById('qrcode'), successPageUrl, {
        width: 200,
        margin: 1,
        color: {
            dark: '#000000',
            light: '#FFFFFF'
        }
    }, function(error) {
        if (error) {
            console.error(error);
            showNotification('ç”ŸæˆäºŒç»´ç å¤±è´¥', 'error');
        } else {
            showNotification('å¾®ä¿¡å¯æ‰«æçš„äºŒç»´ç å·²ç”Ÿæˆï¼å‘˜å·¥æ‰«ç åä¼šè‡ªåŠ¨è®°å½•è€ƒå‹¤', 'success');
            renderEmployeeList();
            updateEmployeeSelect();
            updateStats();
            addSystemLog(`æ·»åŠ å‘˜å·¥: ${name} (${id}) - ç”Ÿæˆå¾®ä¿¡äºŒç»´ç `);
            
            // åŒæ­¥åˆ°äº‘ç«¯
            cloudSync.uploadAllData();
        }
    });
}
        
        // è¾“å…¥éªŒè¯
        function validateEmployeeInput(name, id) {
            if (!name || !id) {
                return 'è¯·è¾“å…¥å‘˜å·¥å§“åå’Œå·¥å·';
            }
            
            if (name.length < 2 || name.length > 20) {
                return 'å§“åé•¿åº¦åº”åœ¨2-20å­—ç¬¦ä¹‹é—´';
            }
            
            if (!/^[A-Za-z0-9]{3,10}$/.test(id)) {
                return 'å·¥å·åªèƒ½åŒ…å«å­—æ¯å’Œæ•°å­—ï¼Œé•¿åº¦3-10ä½';
            }
            
            return null;
        }
        
        // æ¸…ç©ºè¡¨å•
        function clearForm() {
            employeeNameInput.value = '';
            employeeIdInput.value = '';
            qrCodeContainer.innerHTML = '';
            qrPlaceholder.style.display = 'block';
            showNotification('è¡¨å•å·²æ¸…ç©º', 'success');
        }
        
        // æ¸²æŸ“å‘˜å·¥åˆ—è¡¨
        function renderEmployeeList() {
            employeeList.innerHTML = '';
            
            if (employees.length === 0) {
                employeeList.innerHTML = '<div class="empty-state">æš‚æ— å‘˜å·¥ä¿¡æ¯</div>';
                totalEmployeesSpan.textContent = '0';
                workingEmployeesSpan.textContent = '0';
                return;
            }
            
            // æ›´æ–°ç»Ÿè®¡
            totalEmployeesSpan.textContent = employees.length;
            const workingCount = employees.filter(emp => 
                workRecords[emp.id] && workRecords[emp.id].isWorking
            ).length;
            workingEmployeesSpan.textContent = workingCount;
            
            employees.forEach(employee => {
                const employeeItem = document.createElement('div');
                employeeItem.className = 'employee-item';
                
                const isWorking = workRecords[employee.id] && workRecords[employee.id].isWorking;
                const statusClass = isWorking ? 'status-working' : 'status-idle';
                const statusText = isWorking ? 'å·¥ä½œä¸­' : 'æœªå·¥ä½œ';
                const startTime = workRecords[employee.id] ? workRecords[employee.id].startTime : null;
                
                employeeItem.innerHTML = `
                    <div class="employee-info">
                        <div class="employee-name">${employee.name}</div>
                        <div class="employee-id">å·¥å·: ${employee.id}</div>
                        <div class="work-time">ä»Šæ—¥å·¥æ—¶: ${calculateWorkTime(employee.id)} å°æ—¶</div>
                        ${startTime ? `<div class="time-info">å¼€å§‹æ—¶é—´: ${formatDateTime(startTime)}</div>` : ''}
                    </div>
                    <div class="employee-actions">
                        <div class="employee-status ${statusClass}">${statusText}</div>
                        <button class="delete-btn" data-id="${employee.id}">åˆ é™¤</button>
                    </div>
                `;
                
                employeeList.appendChild(employeeItem);
            });
            
            // æ›´æ–°å·¥æ—¶æ’è¡Œ
            updateWorkRanking();
            
            // æ·»åŠ åˆ é™¤æŒ‰é’®äº‹ä»¶
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const employeeId = this.getAttribute('data-id');
                    deleteEmployee(employeeId);
                });
            });
        }
        
        // æ›´æ–°å·¥æ—¶æ’è¡Œ
        function updateWorkRanking() {
            workRankingList.innerHTML = '';
            
            if (employees.length === 0) {
                workRankingList.innerHTML = '<div class="empty-state">æš‚æ— æ•°æ®</div>';
                return;
            }
            
            // è®¡ç®—æ¯ä¸ªå‘˜å·¥çš„å·¥æ—¶å¹¶æ’åº
            const rankedEmployees = employees.map(emp => {
                return {
                    ...emp,
                    workTime: parseFloat(calculateWorkTime(emp.id))
                };
            }).sort((a, b) => b.workTime - a.workTime);
            
            rankedEmployees.forEach((emp, index) => {
                const rankItem = document.createElement('div');
                rankItem.className = 'history-item';
                
                rankItem.innerHTML = `
                    <div class="history-date">${index + 1}. ${emp.name}</div>
                    <div class="history-duration">${emp.workTime.toFixed(2)} å°æ—¶</div>
                `;
                
                workRankingList.appendChild(rankItem);
            });
        }
        
        // åˆ é™¤å‘˜å·¥
        function deleteEmployee(employeeId) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¯¥å‘˜å·¥å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
                const employee = employees.find(emp => emp.id === employeeId);
                
                // ä»å‘˜å·¥åˆ—è¡¨ä¸­ç§»é™¤
                employees = employees.filter(emp => emp.id !== employeeId);
                localStorage.setItem('employees', JSON.stringify(employees));
                
                // ä»å·¥æ—¶è®°å½•ä¸­ç§»é™¤
                if (workRecords[employeeId]) {
                    delete workRecords[employeeId];
                    localStorage.setItem('workRecords', JSON.stringify(workRecords));
                }
                
                // å¦‚æœå½“å‰é€‰æ‹©çš„å‘˜å·¥è¢«åˆ é™¤ï¼Œæ¸…ç©ºé€‰æ‹©
                if (currentEmployeeId === employeeId) {
                    currentEmployeeId = null;
                    selectedEmployeeSelect.value = '';
                }
                
                // æ›´æ–°UI
                renderEmployeeList();
                updateEmployeeSelect();
                updateTotalHours();
                updateStats();
                
                showNotification('å‘˜å·¥å·²åˆ é™¤', 'success');
                addSystemLog(`åˆ é™¤å‘˜å·¥: ${employee.name} (${employeeId})`);
                
                // ä»äº‘ç«¯åˆ é™¤
                cloudSync.deleteEmployee(employeeId);
            }
        }
        
        // è®¡ç®—å‘˜å·¥å·¥æ—¶
        function calculateWorkTime(employeeId) {
            if (!workRecords[employeeId]) return 0;
            
            const record = workRecords[employeeId];
            let totalHours = parseFloat(record.totalHours || 0);
            
            // å¦‚æœæ­£åœ¨å·¥ä½œï¼ŒåŠ ä¸Šå½“å‰å·¥ä½œæ—¶é—´
            if (record.isWorking && record.startTime) {
                const currentWorkTime = (Date.now() - record.startTime) / (1000 * 60 * 60);
                totalHours += currentWorkTime;
            }
            
            // ä¿ç•™2ä½å°æ•°
            return totalHours.toFixed(2);
        }
        
        // æ›´æ–°å‘˜å·¥é€‰æ‹©ä¸‹æ‹‰æ¡†
        function updateEmployeeSelect() {
            selectedEmployeeSelect.innerHTML = '<option value="">-- è¯·é€‰æ‹©å‘˜å·¥ --</option>';
            
            employees.forEach(employee => {
                const option = document.createElement('option');
                option.value = employee.id;
                option.textContent = `${employee.name} (${employee.id})`;
                selectedEmployeeSelect.appendChild(option);
            });
        }
        
        // æ‰«æäºŒç»´ç 
        function scanQRCode() {
            if (!isScanning) return;
            
            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                const canvasContext = canvas.getContext('2d');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                canvasContext.drawImage(video, 0, 0, canvas.width, canvas.height);
                
                const imageData = canvasContext.getImageData(0, 0, canvas.width, canvas.height);
                const code = jsQR(imageData.data, imageData.width, imageData.height);
                
                if (code) {
                    const employeeId = code.data;
                    const employee = employees.find(emp => emp.id === employeeId);
                    
                    if (employee) {
                        // æ›´æ–°æ‰«æç»“æœ
                        scanResultText.textContent = `å·²è¯†åˆ«: ${employee.name} (${employeeId})`;
                        scanResultText.style.color = '#27ae60';
                        
                        // è®°å½•æ‰«ææ—¥å¿—
                        const now = new Date();
                        const timeString = now.toLocaleTimeString();
                        
                        const logItem = document.createElement('div');
                        logItem.className = 'log-item';
                        logItem.innerHTML = `
                            <div>${employee.name} (${employeeId})</div>
                            <div class="log-time">${timeString}</div>
                        `;
                        
                        scanLogs.insertBefore(logItem, scanLogs.firstChild);
                        
                        // é™åˆ¶æ—¥å¿—æ•°é‡
                        if (scanLogs.children.length > 10) {
                            scanLogs.removeChild(scanLogs.lastChild);
                        }
                        
                        // è‡ªåŠ¨é€‰æ‹©è¯¥å‘˜å·¥
                        selectedEmployeeSelect.value = employeeId;
                        currentEmployeeId = employeeId;
                        
                        // æ™ºèƒ½åˆ‡æ¢å·¥ä½œçŠ¶æ€ï¼šå¦‚æœæ­£åœ¨å·¥ä½œå°±æš‚åœï¼Œå¦‚æœæœªå·¥ä½œå°±å¼€å§‹
                        toggleWorkStatus(employeeId);
                        
                        // æ·»åŠ ç³»ç»Ÿæ—¥å¿—
                        addSystemLog(`æ‰«ç è¯†åˆ«å‘˜å·¥: ${employee.name} (${employeeId})`);
                        
                        // æš‚åœæ‰«æ2ç§’ï¼Œé¿å…é‡å¤æ‰«æ
                        isScanning = false;
                        setTimeout(() => {
                            isScanning = true;
                            scanQRCode();
                        }, 2000);
                        
                        return; // é€€å‡ºå½“å‰æ‰«æå¾ªç¯
                    } else {
                        scanResultText.textContent = 'æœªæ‰¾åˆ°åŒ¹é…çš„å‘˜å·¥ä¿¡æ¯';
                        scanResultText.style.color = '#e74c3c';
                    }
                } else {
                    scanResultText.textContent = 'ç­‰å¾…æ‰«æ...';
                    scanResultText.style.color = '#7f8c8d';
                }
            }
            
            // ç»§ç»­æ‰«æ
            if (isScanning) {
                requestAnimationFrame(scanQRCode);
            }
        }
        
        // æ™ºèƒ½åˆ‡æ¢å·¥ä½œçŠ¶æ€
        function toggleWorkStatus(employeeId) {
            // åˆå§‹åŒ–å‘˜å·¥è®°å½•
            if (!workRecords[employeeId]) {
                workRecords[employeeId] = {
                    totalHours: 0,
                    isWorking: false,
                    startTime: null,
                    history: []
                };
            }
            
            const record = workRecords[employeeId];
            const employee = employees.find(emp => emp.id === employeeId);
            
            if (record.isWorking) {
                // å¦‚æœæ­£åœ¨å·¥ä½œï¼Œåˆ™æš‚åœå·¥ä½œ
                const workTimeHours = (Date.now() - record.startTime) / (1000 * 60 * 60);
                record.totalHours = parseFloat(record.totalHours || 0) + workTimeHours;
                record.isWorking = false;
                record.startTime = null;
                
                showNotification(`${employee.name} å·¥ä½œå·²æš‚åœ`, 'success');
                addWorkHistory(employeeId, `æ‰«ç æš‚åœå·¥ä½œ - æœ¬æ¬¡å·¥ä½œæ—¶é•¿: ${workTimeHours.toFixed(2)}å°æ—¶`);
                addSystemLog(`å‘˜å·¥ ${employee.name} é€šè¿‡æ‰«ç æš‚åœå·¥ä½œ`);
            } else {
                // å¦‚æœæœªå·¥ä½œï¼Œåˆ™å¼€å§‹å·¥ä½œ
                record.isWorking = true;
                record.startTime = Date.now();
                
                showNotification(`${employee.name} å·¥ä½œè®¡æ—¶å·²å¼€å§‹`, 'success');
                addWorkHistory(employeeId, `æ‰«ç å¼€å§‹å·¥ä½œ - ${formatDateTime(Date.now())}`);
                addSystemLog(`å‘˜å·¥ ${employee.name} é€šè¿‡æ‰«ç å¼€å§‹å·¥ä½œ`);
            }
            
            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            localStorage.setItem('workRecords', JSON.stringify(workRecords));
            
            // æ›´æ–°UI
            renderEmployeeList();
            updateTotalHours();
            renderWorkHistory(employeeId);
            
            // åŒæ­¥åˆ°äº‘ç«¯
            cloudSync.uploadAllData();
        }
        
        // å¼€å§‹å·¥ä½œ
        function startWork() {
            const employeeId = selectedEmployeeSelect.value;
            
            if (!employeeId) {
                showNotification('è¯·å…ˆé€‰æ‹©å‘˜å·¥', 'error');
                return;
            }
            
            // åˆå§‹åŒ–å‘˜å·¥è®°å½•
            if (!workRecords[employeeId]) {
                workRecords[employeeId] = {
                    totalHours: 0,
                    isWorking: false,
                    startTime: null,
                    history: []
                };
            }
            
            const record = workRecords[employeeId];
            
            if (record.isWorking) {
                showNotification('è¯¥å‘˜å·¥å·²åœ¨å·¥ä½œä¸­', 'error');
                return;
            }
            
            // å¼€å§‹è®¡æ—¶
            record.isWorking = true;
            record.startTime = Date.now();
            
            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            localStorage.setItem('workRecords', JSON.stringify(workRecords));
            
            // æ›´æ–°UI
            renderEmployeeList();
            showNotification('å·¥ä½œè®¡æ—¶å·²å¼€å§‹', 'success');
            
            // æ·»åŠ å·¥ä½œå†å²è®°å½•
            const employee = employees.find(emp => emp.id === employeeId);
            addWorkHistory(employeeId, `æ‰‹åŠ¨å¼€å§‹å·¥ä½œ - ${formatDateTime(Date.now())}`);
            
            // æ·»åŠ ç³»ç»Ÿæ—¥å¿—
            addSystemLog(`å‘˜å·¥ ${employee.name} æ‰‹åŠ¨å¼€å§‹å·¥ä½œ`);
            
            // æ›´æ–°å·¥ä½œå†å²æ˜¾ç¤º
            renderWorkHistory(employeeId);
            
            // åŒæ­¥åˆ°äº‘ç«¯
            cloudSync.uploadAllData();
        }
        
        // æš‚åœå·¥ä½œ
        function pauseWork() {
            const employeeId = selectedEmployeeSelect.value;
            
            if (!employeeId) {
                showNotification('è¯·å…ˆé€‰æ‹©å‘˜å·¥', 'error');
                return;
            }
            
            if (!workRecords[employeeId]) {
                showNotification('è¯¥å‘˜å·¥æ²¡æœ‰å·¥ä½œè®°å½•', 'error');
                return;
            }
            
            const record = workRecords[employeeId];
            
            if (!record.isWorking) {
                showNotification('è¯¥å‘˜å·¥æœªåœ¨å·¥ä½œ', 'error');
                return;
            }
            
            // è®¡ç®—å·¥ä½œæ—¶é—´å¹¶æš‚åœ
            const workTimeHours = (Date.now() - record.startTime) / (1000 * 60 * 60);
            record.totalHours = parseFloat(record.totalHours || 0) + workTimeHours;
            record.isWorking = false;
            record.startTime = null;
            
            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            localStorage.setItem('workRecords', JSON.stringify(workRecords));
            
            // æ›´æ–°UI
            renderEmployeeList();
            updateTotalHours();
            showNotification('å·¥ä½œå·²æš‚åœ', 'success');
            
            // æ·»åŠ å·¥ä½œå†å²è®°å½•
            const employee = employees.find(emp => emp.id === employeeId);
            addWorkHistory(employeeId, `æ‰‹åŠ¨æš‚åœå·¥ä½œ - æœ¬æ¬¡å·¥ä½œæ—¶é•¿: ${workTimeHours.toFixed(2)}å°æ—¶`);
            
            // æ·»åŠ ç³»ç»Ÿæ—¥å¿—
            addSystemLog(`å‘˜å·¥ ${employee.name} æ‰‹åŠ¨æš‚åœå·¥ä½œ`);
            
            // æ›´æ–°å·¥ä½œå†å²æ˜¾ç¤º
            renderWorkHistory(employeeId);
            
            // åŒæ­¥åˆ°äº‘ç«¯
            cloudSync.uploadAllData();
        }
        
        // ä¿å­˜å·¥æ—¶
        function saveWork() {
            const employeeId = selectedEmployeeSelect.value;
            
            if (!employeeId) {
                showNotification('è¯·å…ˆé€‰æ‹©å‘˜å·¥', 'error');
                return;
            }
            
            if (!workRecords[employeeId]) {
                showNotification('è¯¥å‘˜å·¥æ²¡æœ‰å¯ä¿å­˜çš„å·¥æ—¶è®°å½•', 'error');
                return;
            }
            
            // ç¡®ä¿å…ˆæš‚åœè®¡æ—¶
            if (workRecords[employeeId].isWorking) {
                pauseWork();
            }
            
            // ä¿å­˜åˆ°localStorage
            localStorage.setItem('workRecords', JSON.stringify(workRecords));
            
            // æ›´æ–°UI
            updateTotalHours();
            showNotification('å·¥æ—¶è®°å½•å·²ä¿å­˜', 'success');
            
            // æ·»åŠ ç³»ç»Ÿæ—¥å¿—
            const employee = employees.find(emp => emp.id === employeeId);
            addSystemLog(`ä¿å­˜å‘˜å·¥ ${employee.name} çš„å·¥æ—¶è®°å½•`);
            
            // åŒæ­¥åˆ°äº‘ç«¯
            cloudSync.uploadAllData();
        }
        
        // æ·»åŠ å·¥ä½œå†å²è®°å½•
        function addWorkHistory(employeeId, action) {
            if (!workRecords[employeeId].history) {
                workRecords[employeeId].history = [];
            }
            
            workRecords[employeeId].history.push({
                action,
                timestamp: new Date().toISOString()
            });
            
            // æ›´æ–°å·¥ä½œå†å²æ˜¾ç¤º
            renderWorkHistory(employeeId);
        }
        
        // æ¸²æŸ“å·¥ä½œå†å²
        function renderWorkHistory(employeeId) {
            workHistoryList.innerHTML = '';
            
            if (!workRecords[employeeId] || !workRecords[employeeId].history || workRecords[employeeId].history.length === 0) {
                workHistoryList.innerHTML = '<div class="empty-state">æš‚æ— å·¥ä½œè®°å½•</div>';
                return;
            }
            
            const history = workRecords[employeeId].history.slice(-5); // åªæ˜¾ç¤ºæœ€è¿‘5æ¡è®°å½•
            
            history.forEach(item => {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                
                const date = new Date(item.timestamp);
                const timeString = formatDateTime(date.getTime());
                
                historyItem.innerHTML = `
                    <div class="history-date">${item.action}</div>
                    <div class="history-time">${timeString}</div>
                `;
                
                workHistoryList.appendChild(historyItem);
            });
        }
        
        // æ›´æ–°æ€»å·¥æ—¶æ˜¾ç¤º
        function updateTotalHours() {
            let total = 0;
            
            for (const employeeId in workRecords) {
                total += parseFloat(calculateWorkTime(employeeId));
            }
            
            totalHoursSpan.textContent = total.toFixed(2);
        }
        
        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStats() {
            // å‘˜å·¥ç»Ÿè®¡
            statTotalEmployees.textContent = employees.length;
            
            // å·¥æ—¶ç»Ÿè®¡
            let totalHours = 0;
            let todayHours = 0;
            let activeEmployees = 0;
            
            const today = new Date().toDateString();
            
            for (const employeeId in workRecords) {
                totalHours += parseFloat(calculateWorkTime(employeeId));
                
                if (workRecords[employeeId].isWorking) {
                    activeEmployees++;
                }
            }
            
            statTotalHours.textContent = totalHours.toFixed(2);
            statTodayHours.textContent = totalHours.toFixed(2); // ç®€åŒ–å¤„ç†ï¼Œå®é™…åº”æŒ‰æ—¥æœŸç»Ÿè®¡
            statActiveEmployees.textContent = activeEmployees;
        }
        
        // å¯¼å‡ºæ•°æ®
        function exportData() {
            const data = {
                employees: employees,
                workRecords: workRecords,
                exportDate: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `employee_work_data_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            showNotification('æ•°æ®å¯¼å‡ºæˆåŠŸ', 'success');
            addSystemLog('å¯¼å‡ºç³»ç»Ÿæ•°æ®');
        }
        
        // å¯¼å…¥æ•°æ®
        function importData() {
            const dataStr = importDataTextarea.value.trim();
            
            if (!dataStr) {
                showNotification('è¯·è¾“å…¥è¦å¯¼å…¥çš„æ•°æ®', 'error');
                return;
            }
            
            try {
                const data = JSON.parse(dataStr);
                
                if (!data.employees || !data.workRecords) {
                    showNotification('æ•°æ®æ ¼å¼ä¸æ­£ç¡®', 'error');
                    return;
                }
                
                // ç¡®è®¤æ“ä½œ
                if (!confirm('å¯¼å…¥æ•°æ®å°†è¦†ç›–å½“å‰æ‰€æœ‰æ•°æ®ï¼Œç¡®å®šè¦ç»§ç»­å—ï¼Ÿ')) {
                    return;
                }
                
                // æ›´æ–°æ•°æ®
                employees = data.employees;
                workRecords = data.workRecords;
                
                // ä¿å­˜åˆ°localStorage
                localStorage.setItem('employees', JSON.stringify(employees));
                localStorage.setItem('workRecords', JSON.stringify(workRecords));
                
                // æ›´æ–°UI
                renderEmployeeList();
                updateEmployeeSelect();
                updateTotalHours();
                updateStats();
                
                showNotification('æ•°æ®å¯¼å…¥æˆåŠŸ', 'success');
                addSystemLog('å¯¼å…¥ç³»ç»Ÿæ•°æ®');
                
                // åŒæ­¥åˆ°äº‘ç«¯
                cloudSync.uploadAllData();
                
                // æ¸…ç©ºè¾“å…¥æ¡†
                importDataTextarea.value = '';
            } catch (error) {
                console.error('å¯¼å…¥æ•°æ®é”™è¯¯:', error);
                showNotification('æ•°æ®æ ¼å¼ä¸æ­£ç¡®ï¼Œå¯¼å…¥å¤±è´¥', 'error');
            }
        }
        
        // æ¸…ç©ºæ‰€æœ‰æ•°æ®
        function clearAllData() {
            if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                return;
            }
            
            // æ¸…ç©ºæ‰€æœ‰æ•°æ®
            employees = [];
            workRecords = {};
            systemLogs = [];
            
            // æ¸…ç©ºlocalStorage
            localStorage.removeItem('employees');
            localStorage.removeItem('workRecords');
            localStorage.removeItem('systemLogs');
            
            // æ›´æ–°UI
            renderEmployeeList();
            updateEmployeeSelect();
            updateTotalHours();
            updateStats();
            renderSystemLogs();
            
            showNotification('æ‰€æœ‰æ•°æ®å·²æ¸…ç©º', 'success');
            addSystemLog('æ¸…ç©ºæ‰€æœ‰ç³»ç»Ÿæ•°æ®');
            
            // ä»äº‘ç«¯åˆ é™¤æ‰€æœ‰æ•°æ®
            cloudSync.uploadAllData(); // è¿™ä¼šç”¨ç©ºæ•°æ®è¦†ç›–äº‘ç«¯
        }
        
        // æ·»åŠ ç³»ç»Ÿæ—¥å¿—
        function addSystemLog(message) {
            const log = {
                message,
                timestamp: new Date().toISOString()
            };
            
            systemLogs.unshift(log);
            
            // é™åˆ¶æ—¥å¿—æ•°é‡
            if (systemLogs.length > 50) {
                systemLogs.pop();
            }
            
            // ä¿å­˜åˆ°localStorage
            localStorage.setItem('systemLogs', JSON.stringify(systemLogs));
            
            // æ›´æ–°UI
            renderSystemLogs();
        }
        
        // æ¸²æŸ“ç³»ç»Ÿæ—¥å¿—
        function renderSystemLogs() {
            systemLogsList.innerHTML = '';
            
            if (systemLogs.length === 0) {
                systemLogsList.innerHTML = '<div class="empty-state">æš‚æ— ç³»ç»Ÿæ—¥å¿—</div>';
                return;
            }
            
            systemLogs.forEach(log => {
                const logItem = document.createElement('div');
                logItem.className = 'log-item';
                
                const date = new Date(log.timestamp);
                const timeString = formatDateTime(date.getTime());
                
                logItem.innerHTML = `
                    <div>${log.message}</div>
                    <div class="log-time">${timeString}</div>
                `;
                
                systemLogsList.appendChild(logItem);
            });
        }
        
        // æ˜¾ç¤ºé€šçŸ¥
        function showNotification(message, type) {
            notification.textContent = message;
            notification.className = `notification ${type} show`;
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
    </script>
</body>
</html>
