<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>员工工时管理系统</title>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.0/build/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #3498db, #2c3e50);
            color: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        
        .tab-container {
            display: flex;
            margin-bottom: 20px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            background: #f8f9fa;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .tab.active {
            background: #3498db;
            color: white;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }
        
        @media (max-width: 900px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }
        
        .card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        
        .card h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        input[type="text"], select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            transition: border 0.3s;
        }
        
        input[type="text"]:focus, select:focus {
            border-color: #3498db;
            outline: none;
        }
        
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: background-color 0.3s;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        button:hover {
            background-color: #2980b9;
        }
        
        button.secondary {
            background-color: #2ecc71;
        }
        
        button.secondary:hover {
            background-color: #27ae60;
        }
        
        button.danger {
            background-color: #e74c3c;
        }
        
        button.danger:hover {
            background-color: #c0392b;
        }
        
        .qr-container {
            text-align: center;
            margin-top: 20px;
            padding: 15px;
            border: 1px dashed #ddd;
            border-radius: 5px;
            min-height: 200px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        
        #qrcode {
            margin-top: 15px;
        }
        
        .employee-list {
            margin-top: 20px;
        }
        
        .employee-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .employee-item:last-child {
            border-bottom: none;
        }
        
        .employee-info {
            flex-grow: 1;
        }
        
        .employee-name {
            font-weight: 600;
            font-size: 18px;
        }
        
        .employee-id {
            color: #7f8c8d;
            font-size: 14px;
        }
        
        .employee-status {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .status-working {
            background-color: #e8f6f3;
            color: #27ae60;
        }
        
        .status-idle {
            background-color: #fef9e7;
            color: #f39c12;
        }
        
        .work-time {
            font-size: 14px;
            color: #2c3e50;
            margin-top: 5px;
        }
        
        .logs-container {
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .log-item {
            padding: 10px 15px;
            border-bottom: 1px solid #eee;
            font-size: 14px;
        }
        
        .log-time {
            color: #7f8c8d;
            font-size: 12px;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 5px;
            color: white;
            font-weight: 600;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .notification.success {
            background-color: #2ecc71;
        }
        
        .notification.error {
            background-color: #e74c3c;
        }
        
        .notification.show {
            opacity: 1;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .total-hours {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
            text-align: center;
            font-size: 18px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .employee-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .delete-btn {
            background-color: #e74c3c;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .delete-btn:hover {
            background-color: #c0392b;
        }
        
        .empty-state {
            text-align: center;
            padding: 30px;
            color: #7f8c8d;
        }
        
        .stats-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
        }
        
        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            text-align: center;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #3498db;
            margin: 10px 0;
        }
        
        .stat-label {
            font-size: 14px;
            color: #7f8c8d;
        }
        
        .work-history {
            margin-top: 20px;
        }
        
        .history-item {
            padding: 10px 15px;
            border-bottom: 1px solid #eee;
            font-size: 14px;
        }
        
        .history-date {
            font-weight: 600;
            color: #2c3e50;
        }
        
        .history-time {
            color: #7f8c8d;
            font-size: 12px;
        }
        
        .history-duration {
            float: right;
            font-weight: 600;
            color: #3498db;
        }
        
        .sync-status {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-online {
            background-color: #2ecc71;
        }
        
        .status-offline {
            background-color: #e74c3c;
        }

        .time-info {
            font-size: 12px;
            color: #7f8c8d;
            margin-top: 3px;
        }
        
        /* 微信扫码记录样式 */
        .wechat-scan-item {
            padding: 8px 12px;
            border-bottom: 1px solid #eee;
            font-size: 13px;
            background: #f8f9fa;
            margin-bottom: 5px;
            border-radius: 5px;
        }

        .wechat-scan-time {
            color: #7f8c8d;
            font-size: 11px;
        }

        .recent-activity {
            margin-top: 15px;
        }
        
        .work-time-details {
            display: flex;
            gap: 15px;
            margin-top: 5px;
        }
        
        .work-time-item {
            font-size: 13px;
            color: #2c3e50;
        }
        
        .work-time-label {
            font-weight: 600;
            color: #7f8c8d;
        }

        .realtime-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #2ecc71;
            margin-left: 5px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.4; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>员工工时管理系统 <span id="syncStatusIndicator" class="sync-status status-offline"></span></h1>
            <p class="subtitle">员工信息录入 · 微信扫码考勤 · 工时记录 · 云端同步 <span id="realtimeIndicator" class="realtime-indicator" style="display: none;" title="实时同步已开启"></span></p>
        </header>
        
        <div class="tab-container">
            <div class="tab active" data-tab="employee-tab">人员录入</div>
            <div class="tab" data-tab="admin-tab">后台管理</div>
            <div class="tab" data-tab="data-tab">云端管理</div>
        </div>
        
        <div id="employee-tab" class="tab-content active">
            <div class="card">
                <h2>人员信息录入</h2>
                
                <div class="form-group">
                    <label for="employeeRole">人员角色</label>
                    <select id="employeeRole">
                        <option value="worker">工人 (生成考勤码)</option>
                        <option value="engineer">工程师/扫描者 (生成身份码)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="employeeName">姓名</label>
                    <input type="text" id="employeeName" placeholder="请输入姓名(2-20个字符)">
                </div>
                <div class="form-group">
                    <label for="employeeId">工号</label>
                    <input type="text" id="employeeId" placeholder="请输入工号(字母和数字)">
                </div>
                <div class="action-buttons">
                    <button id="generateQR">生成二维码</button>
                    <button id="clearForm" class="danger">清空表单</button>
                </div>
                
                <div class="qr-container">
                    <p id="qrPlaceholder">生成的二维码将显示在这里</p>
                    <canvas id="qrcode"></canvas>
                </div>
            </div>
        </div>
        
        <div id="admin-tab" class="tab-content">
            <div class="main-content">
                <div class="left-column">
                    <div class="card">
                        <h2>员工列表</h2>
                        <div class="stats-container">
                            <div class="stat-card">
                                <div class="stat-label">员工总数</div>
                                <div class="stat-value" id="totalEmployees">0</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">工作中</div>
                                <div class="stat-value" id="workingEmployees">0</div>
                            </div>
                        </div>
                        <div class="employee-list" id="employeeList">
                            </div>
                    </div>
                    
                    <div class="card">
                        <h2>今日工时排行</h2>
                        <div class="work-history" id="workRanking">
                            </div>
                    </div>

                    <div class="card">
                        <h2>最近微信扫码记录</h2>
                        <div class="recent-activity" id="wechatScansList">
                            </div>
                    </div>
                </div>
                
                <div class="right-column">
                    <div class="card">
                        <h2>工时管理</h2>
                        <div class="form-group">
                            <label for="selectedEmployee">选择工人</label>
                            <select id="selectedEmployee" style="width: 100%; padding: 12px; border-radius: 5px; border: 1px solid #ddd; font-size: 16px;">
                                <option value="">-- 请选择工人 --</option>
                            </select>
                        </div>
                        
                        <div class="action-buttons">
                            <button id="startWork" class="secondary">开始工作</button>
                            <button id="pauseWork">暂停工作</button>
                            <button id="saveWork">保存工时</button>
                        </div>
                        
                        <div class="total-hours">
                            今日总工时: <span id="totalHours">0</span> 小时
                        </div>
                        
                        <div class="work-history" id="workHistory">
                            </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="data-tab" class="tab-content">
            <div class="main-content">
                <div class="left-column">
                    <div class="card">
                        <h2>云端同步</h2>
                        <div class="action-buttons">
                            <button id="syncToCloud" class="secondary">同步到云端</button>
                            <button id="syncFromCloud">从云端同步</button>
                            <button id="checkUpdates" class="secondary">检查云端更新</button>
                            <button id="toggleRealtime">开启实时同步</button>
                        </div>
                        <div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                            <p style="font-size: 14px; color: #7f8c8d;">云端同步状态: <span id="cloudStatusText">未连接</span></p>
                            <p style="font-size: 12px; color: #7f8c8d; margin-top: 5px;">实时同步: <span id="realtimeStatusText">未开启</span></p>
                        </div>
                    </div>
                </div>
                
                <div class="right-column">
                    <div class="card">
                        <h2>系统统计</h2>
                        <div class="stats-container">
                            <div class="stat-card">
                                <div class="stat-label">总工人/工程师数</div>
                                <div class="stat-value" id="statTotalEmployees">0</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">总工时</div>
                                <div class="stat-value" id="statTotalHours">0</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">今日工时</div>
                                <div class="stat-value" id="statTodayHours">0</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">活跃工人</div>
                                <div class="stat-value" id="statActiveEmployees">0</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h2>操作日志</h2>
                        <div class="logs-container" id="systemLogs">
                            </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="notification" id="notification"></div>

    <script>
        // Supabase云同步类 - 增强版（支持双向同步）
        class CloudSync {
            constructor() {
                // 使用你提供的Supabase配置
                this.supabaseUrl = 'https://ynkmlbczkcporjdpawbr.supabase.co';
                this.supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inlua21sYmN6a2Nwb3JqZHBhd2JyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI4NDcwMjUsImV4cCI6MjA3ODQyMzAyNX0.6tkS9oBrg3_1tGzSXQZygZv_KpC-x97B_1r39lgBTGY';
                this.supabase = supabase.createClient(this.supabaseUrl, this.supabaseKey);
                this.isOnline = false;
                this.isRealtimeEnabled = false;
                this.realtimeSubscriptions = [];
            }

            // 检查网络状态
            async checkConnection() {
                try {
                    const { error } = await this.supabase.from('employees').select('count').limit(1);
                    this.isOnline = !error;
                    this.updateStatusIndicator();
                    return this.isOnline;
                } catch (error) {
                    this.isOnline = false;
                    this.updateStatusIndicator();
                    console.warn('网络连接失败，使用本地模式');
                    return false;
                }
            }

            // 更新状态指示器
            updateStatusIndicator() {
                const indicator = document.getElementById('syncStatusIndicator');
                if (indicator) {
                    indicator.className = `sync-status ${this.isOnline ? 'status-online' : 'status-offline'}`;
                    indicator.title = this.isOnline ? '云端连接正常' : '云端连接断开';
                }
                
                // 更新云端状态文本
                const statusText = document.getElementById('cloudStatusText');
                if (statusText) {
                    statusText.textContent = this.isOnline ? '已连接' : '未连接';
                    statusText.style.color = this.isOnline ? '#27ae60' : '#e74c3c';
                }

                // 更新实时同步状态
                const realtimeStatusText = document.getElementById('realtimeStatusText');
                const realtimeIndicator = document.getElementById('realtimeIndicator');
                if (realtimeStatusText && realtimeIndicator) {
                    if (this.isRealtimeEnabled && this.isOnline) {
                        realtimeStatusText.textContent = '已开启';
                        realtimeStatusText.style.color = '#27ae60';
                        realtimeIndicator.style.display = 'inline-block';
                    } else {
                        realtimeStatusText.textContent = this.isOnline ? '未开启' : '连接断开';
                        realtimeStatusText.style.color = this.isOnline ? '#f39c12' : '#e74c3c';
                        realtimeIndicator.style.display = 'none';
                    }
                }
            }

            // 开启实时同步
            async enableRealtimeSync() {
                if (!this.isOnline) {
                    showNotification('请先确保云端连接正常', 'error');
                    return false;
                }

                try {
                    // 订阅 work_records 表的变化
                    const workRecordsSubscription = this.supabase
                        .channel('work-records-changes')
                        .on(
                            'postgres_changes',
                            {
                                event: '*', // INSERT, UPDATE, DELETE
                                schema: 'public',
                                table: 'work_records'
                            },
                            (payload) => {
                                console.log('work_records 发生变化:', payload);
                                this.handleWorkRecordsChange(payload);
                            }
                        )
                        .subscribe((status) => {
                            if (status === 'SUBSCRIBED') {
                                console.log('实时订阅 work_records 已开启');
                            }
                        });

                    // 订阅 employees 表的变化
                    const employeesSubscription = this.supabase
                        .channel('employees-changes')
                        .on(
                            'postgres_changes',
                            {
                                event: '*',
                                schema: 'public',
                                table: 'employees'
                            },
                            (payload) => {
                                console.log('employees 发生变化:', payload);
                                this.handleEmployeesChange(payload);
                            }
                        )
                        .subscribe((status) => {
                            if (status === 'SUBSCRIBED') {
                                console.log('实时订阅 employees 已开启');
                            }
                        });

                    // 订阅 wechat_scans 表的变化
                    const wechatScansSubscription = this.supabase
                        .channel('wechat-scans-changes')
                        .on(
                            'postgres_changes',
                            {
                                event: 'INSERT',
                                schema: 'public',
                                table: 'wechat_scans'
                            },
                            (payload) => {
                                console.log('wechat_scans 新增记录:', payload);
                                this.handleWechatScansChange(payload);
                            }
                        )
                        .subscribe((status) => {
                            if (status === 'SUBSCRIBED') {
                                console.log('实时订阅 wechat_scans 已开启');
                            }
                        });

                    this.realtimeSubscriptions = [
                        workRecordsSubscription,
                        employeesSubscription,
                        wechatScansSubscription
                    ];

                    this.isRealtimeEnabled = true;
                    this.updateStatusIndicator();
                    showNotification('实时同步已开启', 'success');
                    return true;

                } catch (error) {
                    console.error('开启实时同步失败:', error);
                    showNotification('开启实时同步失败', 'error');
                    return false;
                }
            }

            // 关闭实时同步
            disableRealtimeSync() {
                this.realtimeSubscriptions.forEach(subscription => {
                    if (subscription) {
                        this.supabase.removeChannel(subscription);
                    }
                });
                this.realtimeSubscriptions = [];
                this.isRealtimeEnabled = false;
                this.updateStatusIndicator();
                showNotification('实时同步已关闭', 'success');
            }

            // 处理 work_records 变化
            handleWorkRecordsChange(payload) {
                const { eventType, new: newRecord, old: oldRecord } = payload;
                
                // 忽略本地触发的变更（通过时间戳判断）
                const isLocalChange = newRecord && newRecord.last_updated && 
                                    (Date.now() - new Date(newRecord.last_updated).getTime()) < 5000;
                
                if (isLocalChange) {
                    console.log('忽略本地触发的变更');
                    return;
                }

                switch (eventType) {
                    case 'INSERT':
                    case 'UPDATE':
                        if (newRecord) {
                            // 更新本地 workRecords
                            const employeeId = newRecord.employee_id;
                            const existingRecord = workRecords[employeeId];
                            
                            // 冲突解决：使用最新的时间戳
                            if (!existingRecord || 
                                !existingRecord.lastUpdated || 
                                new Date(newRecord.last_updated) > new Date(existingRecord.lastUpdated)) {
                                
                                workRecords[employeeId] = {
                                    totalHours: newRecord.total_hours || 0,
                                    todayHours: newRecord.today_hours || 0,
                                    isWorking: newRecord.is_working || false,
                                    startTime: newRecord.start_time ? new Date(newRecord.start_time).getTime() : null,
                                    history: newRecord.history || [],
                                    lastUpdated: newRecord.last_updated || new Date().toISOString()
                                };
                                
                                // 保存到 localStorage
                                localStorage.setItem('workRecords', JSON.stringify(workRecords));
                                
                                // 更新UI
                                renderEmployeeList();
                                updateTotalHours();
                                updateStats();
                                
                                showNotification(`员工 ${employeeId} 的工时记录已从云端更新`, 'success');
                                addSystemLog(`云端同步: 员工 ${employeeId} 工时记录更新`);
                            }
                        }
                        break;
                        
                    case 'DELETE':
                        if (oldRecord && workRecords[oldRecord.employee_id]) {
                            delete workRecords[oldRecord.employee_id];
                            localStorage.setItem('workRecords', JSON.stringify(workRecords));
                            renderEmployeeList();
                            updateTotalHours();
                            updateStats();
                            showNotification(`员工 ${oldRecord.employee_id} 的工时记录已从云端删除`, 'success');
                        }
                        break;
                }
            }

            // 处理 employees 变化
            handleEmployeesChange(payload) {
                const { eventType, new: newEmployee, old: oldEmployee } = payload;
                
                switch (eventType) {
                    case 'INSERT':
                    case 'UPDATE':
                        if (newEmployee) {
                            // 更新本地 employees 数组
                            const index = employees.findIndex(emp => emp.id === newEmployee.id);
                            if (index >= 0) {
                                employees[index] = { 
                                    name: newEmployee.name, 
                                    id: newEmployee.id 
                                };
                            } else {
                                employees.push({ 
                                    name: newEmployee.name, 
                                    id: newEmployee.id 
                                });
                            }
                            
                            localStorage.setItem('employees', JSON.stringify(employees));
                            renderEmployeeList();
                            updateEmployeeSelect();
                            updateStats();
                            
                            showNotification(`员工 ${newEmployee.name} 信息已从云端更新`, 'success');
                            addSystemLog(`云端同步: 员工 ${newEmployee.name} 信息更新`);
                        }
                        break;
                        
                    case 'DELETE':
                        if (oldEmployee) {
                            employees = employees.filter(emp => emp.id !== oldEmployee.id);
                            localStorage.setItem('employees', JSON.stringify(employees));
                            renderEmployeeList();
                            updateEmployeeSelect();
                            updateStats();
                            showNotification(`员工 ${oldEmployee.id} 已从云端删除`, 'success');
                        }
                        break;
                }
            }

            // 处理 wechat_scans 变化
            handleWechatScansChange(payload) {
                if (payload.eventType === 'INSERT' && payload.new) {
                    const scan = payload.new;
                    
                    // 从云端重新同步工作记录，确保数据最新
                    this.syncWorkRecordsFromCloud().then(() => {
                        // 更新界面
                        renderEmployeeList();
                        updateTotalHours();
                        updateStats();
                        loadWechatScans();
                        
                        // 显示通知
                        const employee = employees.find(emp => emp.id === scan.employee_id);
                        if (employee) {
                            showNotification(`员工 ${employee.name} 微信扫码考勤已更新`, 'success');
                            addSystemLog(`微信扫码: 员工 ${employee.name} 扫码考勤`);
                        }
                    });
                }
            }

            // 同步所有数据
            async syncAllData() {
                if (!(await this.checkConnection())) {
                    showNotification('云端连接失败，使用本地数据', 'error');
                    return false;
                }

                try {
                    // 从云端下载员工数据
                    const { data: employees, error: empError } = await this.supabase
                        .from('employees')
                        .select('*');
                    
                    if (!empError && employees && employees.length > 0) {
                        localStorage.setItem('employees', JSON.stringify(employees));
                    }

                    // 从云端下载工时记录
                    await this.syncWorkRecordsFromCloud();

                    showNotification('数据同步完成', 'success');
                    addSystemLog('从云端同步所有数据');
                    return true;
                } catch (error) {
                    console.error('同步失败:', error);
                    showNotification('同步失败，使用本地数据', 'error');
                    return false;
                }
            }

            // 从云端同步工作记录
            async syncWorkRecordsFromCloud() {
                try {
                    const { data: records, error } = await this.supabase
                        .from('work_records')
                        .select('*');

                    if (!error && records) {
                        // 更新本地 workRecords
                        const newWorkRecords = {};
                        records.forEach(record => {
                            newWorkRecords[record.employee_id] = {
                                totalHours: record.total_hours || 0,
                                todayHours: record.today_hours || 0,
                                isWorking: record.is_working || false,
                                startTime: record.start_time ? new Date(record.start_time).getTime() : null,
                                history: record.history || [],
                                lastUpdated: record.last_updated || new Date().toISOString()
                            };
                        });
                        
                        workRecords = newWorkRecords;
                        localStorage.setItem('workRecords', JSON.stringify(workRecords));
                        return true;
                    }
                } catch (error) {
                    console.error('从云端同步工作记录失败:', error);
                    return false;
                }
            }

            // 上传员工数据
            async uploadEmployees() {
                if (!this.isOnline) return false;

                try {
                    const employees = JSON.parse(localStorage.getItem('employees')) || [];
                    
                    if (employees.length > 0) {
                        const { error } = await this.supabase
                            .from('employees')
                            .upsert(employees, { onConflict: 'id' });
                        
                        if (error) throw error;
                    }
                    return true;
                } catch (error) {
                    console.error('上传员工数据失败:', error);
                    return false;
                }
            }

            // 上传工时记录
            async uploadWorkRecords() {
                if (!this.isOnline) return false;

                try {
                    const workRecords = JSON.parse(localStorage.getItem('workRecords')) || {};
                    const records = [];

                    for (const [employeeId, record] of Object.entries(workRecords)) {
                        records.push({
                            employee_id: employeeId,
                            total_hours: parseFloat(record.totalHours || 0),
                            today_hours: parseFloat(record.todayHours || 0),
                            is_working: record.isWorking || false,
                            start_time: record.startTime ? new Date(record.startTime).toISOString() : null,
                            history: record.history || [],
                            last_updated: new Date().toISOString()
                        });
                    }

                    if (records.length > 0) {
                        const { error } = await this.supabase
                            .from('work_records')
                            .upsert(records, { onConflict: 'employee_id' });
                        
                        if (error) throw error;
                    }
                    return true;
                } catch (error) {
                    console.error('上传工时记录失败:', error);
                    return false;
                }
            }

            // 上传所有数据
            async uploadAllData() {
                if (!(await this.checkConnection())) {
                    showNotification('云端连接失败，数据保存在本地', 'error');
                    return false;
                }

                try {
                    await this.uploadEmployees();
                    await this.uploadWorkRecords();
                    console.log('所有数据已上传到云端');
                    showNotification('数据已同步到云端', 'success');
                    addSystemLog('上传所有数据到云端');
                    return true;
                } catch (error) {
                    console.error('上传数据失败:', error);
                    showNotification('上传到云端失败', 'error');
                    return false;
                }
            }

            // 删除员工（云端）
            async deleteEmployee(employeeId) {
                if (!this.isOnline) return false;

                try {
                    // 先删除工时记录
                    const { error: recError } = await this.supabase
                        .from('work_records')
                        .delete()
                        .eq('employee_id', employeeId);
                    
                    if (recError) throw recError;

                    // 再删除员工
                    const { error: empError } = await this.supabase
                        .from('employees')
                        .delete()
                        .eq('id', employeeId);
                    
                    if (empError) throw empError;

                    return true;
                } catch (error) {
                    console.error('删除员工失败:', error);
                    return false;
                }
            }

            // 检查云端更新（手动）
            async checkForUpdates() {
                if (!this.isOnline) {
                    showNotification('云端连接失败', 'error');
                    return;
                }

                showNotification('正在检查云端更新...', 'success');
                
                try {
                    // 获取本地最后同步时间
                    const lastSyncTime = localStorage.getItem('lastCloudSyncTime') || 0;
                    
                    // 检查更新的工作记录
                    const { data: updatedRecords, error } = await this.supabase
                        .from('work_records')
                        .select('*')
                        .gt('last_updated', new Date(parseInt(lastSyncTime)).toISOString());
                    
                    let updateCount = 0;
                    
                    if (!error && updatedRecords && updatedRecords.length > 0) {
                        updateCount += updatedRecords.length;
                        
                        // 更新本地数据
                        updatedRecords.forEach(record => {
                            workRecords[record.employee_id] = {
                                totalHours: record.total_hours || 0,
                                todayHours: record.today_hours || 0,
                                isWorking: record.is_working || false,
                                startTime: record.start_time ? new Date(record.start_time).getTime() : null,
                                history: record.history || [],
                                lastUpdated: record.last_updated || new Date().toISOString()
                            };
                        });
                        
                        localStorage.setItem('workRecords', JSON.stringify(workRecords));
                    }
                    
                    // 更新最后同步时间
                    localStorage.setItem('lastCloudSyncTime', Date.now());
                    
                    if (updateCount > 0) {
                        // 更新UI
                        renderEmployeeList();
                        updateTotalHours();
                        updateStats();
                        
                        showNotification(`发现 ${updateCount} 条云端更新`, 'success');
                        addSystemLog(`手动检查: 发现 ${updateCount} 条云端更新`);
                    } else {
                        showNotification('没有发现新的云端更新', 'success');
                    }
                    
                } catch (error) {
                    console.error('检查更新失败:', error);
                    showNotification('检查更新失败', 'error');
                }
            }
        }

        // 创建全局云同步实例
        const cloudSync = new CloudSync();

        // 全局变量 (已修复 TypeError: engineers.some is not a function)
        let employees = JSON.parse(localStorage.getItem('employees')) || [];
        let engineers = JSON.parse(localStorage.getItem('engineers')) || [];
        
        // **修复代码：确保加载的数据是数组**
        if (!Array.isArray(employees)) employees = [];
        if (!Array.isArray(engineers)) engineers = [];
        
        let workRecords = JSON.parse(localStorage.getItem('workRecords')) || {};
        let systemLogs = JSON.parse(localStorage.getItem('systemLogs')) || [];
        let currentEmployeeId = null;
        let lastWechatScanCheck = 0;
        
        // DOM元素
        const employeeNameInput = document.getElementById('employeeName');
        const employeeIdInput = document.getElementById('employeeId');
        const employeeRoleSelect = document.getElementById('employeeRole');
        const generateQRBtn = document.getElementById('generateQR');
        const clearFormBtn = document.getElementById('clearForm');
        const qrCodeContainer = document.getElementById('qrcode');
        const qrPlaceholder = document.getElementById('qrPlaceholder');
        const employeeList = document.getElementById('employeeList');
        const selectedEmployeeSelect = document.getElementById('selectedEmployee');
        const startWorkBtn = document.getElementById('startWork');
        const pauseWorkBtn = document.getElementById('pauseWork');
        const saveWorkBtn = document.getElementById('saveWork');
        const totalHoursSpan = document.getElementById('totalHours');
        const notification = document.getElementById('notification');
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');
        const totalEmployeesSpan = document.getElementById('totalEmployees');
        const workingEmployeesSpan = document.getElementById('workingEmployees');
        const workRankingList = document.getElementById('workRanking');
        const workHistoryList = document.getElementById('workHistory');
        const systemLogsList = document.getElementById('systemLogs');
        const statTotalEmployees = document.getElementById('statTotalEmployees');
        const statTotalHours = document.getElementById('statTotalHours');
        const statTodayHours = document.getElementById('statTodayHours');
        const statActiveEmployees = document.getElementById('statActiveEmployees');
        const syncToCloudBtn = document.getElementById('syncToCloud');
        const syncFromCloudBtn = document.getElementById('syncFromCloud');
        const checkUpdatesBtn = document.getElementById('checkUpdates');
        const toggleRealtimeBtn = document.getElementById('toggleRealtime');
        const wechatScansList = document.getElementById('wechatScansList');
        
        // 时间格式化函数
        function formatDateTime(timestamp) {
            if (!timestamp) return '未开始';
            const date = new Date(timestamp);
            return date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            });
        }

        function formatTime(timestamp) {
            if (!timestamp) return '';
            const date = new Date(timestamp);
            return date.toLocaleTimeString('zh-CN', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            });
        }

        function formatDate(timestamp) {
            if (!timestamp) return '';
            const date = new Date(timestamp);
            return date.toLocaleDateString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });
        }

        // 获取今天的日期字符串（用于区分今日工时和总工时）
        function getTodayDateString() {
            const today = new Date();
            return today.toISOString().split('T')[0]; // YYYY-MM-DD格式
        }

        // 判断时间戳是否是今天
        function isToday(timestamp) {
            if (!timestamp) return false;
            const date = new Date(timestamp);
            const today = new Date();
            return date.toDateString() === today.toDateString();
        }

        // 初始化
        document.addEventListener('DOMContentLoaded', async function() {
            // 初始化云同步
            await cloudSync.checkConnection();
            
            // 尝试从云端加载数据
            await cloudSync.syncAllData();
            
            // 重新加载本地数据（可能已被云端数据更新）
            employees = JSON.parse(localStorage.getItem('employees')) || [];
            engineers = JSON.parse(localStorage.getItem('engineers')) || []; 
            if (!Array.isArray(employees)) employees = []; // 修复后再次检查，防止同步覆盖错误
            if (!Array.isArray(engineers)) engineers = [];
            workRecords = JSON.parse(localStorage.getItem('workRecords')) || [];
            
            renderEmployeeList();
            updateEmployeeSelect();
            updateTotalHours();
            updateStats();
            renderSystemLogs();
            loadWechatScans();
            
            // 生成二维码按钮事件
            generateQRBtn.addEventListener('click', generateQRCode);
            
            // 清空表单按钮事件
            clearFormBtn.addEventListener('click', clearForm);
            
            // 工时管理按钮事件
            startWorkBtn.addEventListener('click', startWork);
            pauseWorkBtn.addEventListener('click', pauseWork);
            saveWorkBtn.addEventListener('click', saveWork);
            
            // 员工选择变化事件
            selectedEmployeeSelect.addEventListener('change', function() {
                currentEmployeeId = this.value;
                if (currentEmployeeId) {
                    renderWorkHistory(currentEmployeeId);
                } else {
                    workHistoryList.innerHTML = '<div class="empty-state">请选择员工查看工作记录</div>';
                }
            });
            
            // 云端同步按钮事件
            syncToCloudBtn.addEventListener('click', () => cloudSync.uploadAllData());
            syncFromCloudBtn.addEventListener('click', async () => {
                await cloudSync.syncAllData();
                // 重新加载数据并更新UI
                employees = JSON.parse(localStorage.getItem('employees')) || [];
                engineers = JSON.parse(localStorage.getItem('engineers')) || []; 
                if (!Array.isArray(employees)) employees = []; 
                if (!Array.isArray(engineers)) engineers = [];
                workRecords = JSON.parse(localStorage.getItem('workRecords')) || [];
                renderEmployeeList();
                updateEmployeeSelect();
                updateTotalHours();
                updateStats();
                loadWechatScans();
            });

            // 检查更新按钮事件
            checkUpdatesBtn.addEventListener('click', () => cloudSync.checkForUpdates());

            // 实时同步切换按钮事件
            toggleRealtimeBtn.addEventListener('click', async () => {
                if (cloudSync.isRealtimeEnabled) {
                    cloudSync.disableRealtimeSync();
                    toggleRealtimeBtn.textContent = '开启实时同步';
                } else {
                    const success = await cloudSync.enableRealtimeSync();
                    if (success) {
                        toggleRealtimeBtn.textContent = '关闭实时同步';
                    }
                }
            });
            
            // 标签页切换事件
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabId = tab.getAttribute('data-tab');
                    
                    // 更新标签页状态
                    tabs.forEach(t => t.classList.remove('active'));
                    tabContents.forEach(tc => tc.classList.remove('active'));
                    
                    tab.classList.add('active');
                    document.getElementById(tabId).classList.add('active');
                    
                    // 更新统计信息
                    if (tabId === 'data-tab') {
                        updateStats();
                    }

                    // 如果切换到后台管理，加载微信扫码记录
                    if (tabId === 'admin-tab') {
                        loadWechatScans();
                    }
                });
            });
            
            // 定时更新工作时间
            setInterval(() => {
                renderEmployeeList();
                updateTotalHours();
            }, 2000);
            
            // 定时同步到云端（每2分钟）
            setInterval(async () => {
                await cloudSync.uploadAllData();
            }, 120000);
            
            // 添加系统日志
            addSystemLog('系统初始化完成');
        });
        
        // 生成二维码
        function generateQRCode() {
            const name = employeeNameInput.value.trim();
            const id = employeeIdInput.value.trim();
            const role = employeeRoleSelect.value; 
            
            // 输入验证
            const validationError = validateEmployeeInput(name, id);
            if (validationError) {
                showNotification(validationError, 'error');
                return;
            }
            
            // --- 角色特定的逻辑和验证 ---
            
            let qrDataUrl = '';
            let successMessage = '';
            
            // 检查 ID 是否与另一个角色冲突 (这里是报错的源头，已确保 engineers 和 employees 是数组)
            if (role === 'worker' && engineers.some(eng => eng.id === id)) {
                showNotification('该工号已存在于工程师列表中，请勿重复使用', 'error');
                return;
            }
            if (role === 'engineer' && employees.some(emp => emp.id === id)) {
                showNotification('该工号已存在于工人列表中，请勿重复使用', 'error');
                return;
            }

            if (role === 'worker') {
                // 1. 工人 (Worker) 逻辑：生成考勤码
                if (employees.some(emp => emp.id === id)) {
                    showNotification('该工号已存在于工人列表中', 'error');
                    return;
                }

                // 添加工人到列表
                employees.push({ name, id });
                localStorage.setItem('employees', JSON.stringify(employees));

                // URL 指向 scan-success.html (考勤页面)
                const path = `https://irene329zx-ai.github.io/work`;
                qrDataUrl = `${path}/scan-success.html?id=${encodeURIComponent(id)}&name=${encodeURIComponent(name)}`;
                successMessage = '工人考勤二维码已生成！';
                addSystemLog(`添加工人: ${name} (${id}) - 生成考勤码`);
                
            } else if (role === 'engineer') {
                // 2. 工程师 (Engineer/Scanner) 逻辑：生成身份码
                if (engineers.some(eng => eng.id === id)) {
                    showNotification('该工号已存在于工程师列表中', 'error');
                    return;
                }
                
                // 添加工程师到列表
                engineers.push({ name, id });
                localStorage.setItem('engineers', JSON.stringify(engineers));

                // URL **关键：** 指向 scanner-session.html (身份确认页面)
                const path = `https://irene329zx-ai.github.io/work`;
                qrDataUrl = `${path}/scanner-session.html?id=${encodeURIComponent(id)}`;
                successMessage = '工程师身份二维码已生成！';
                addSystemLog(`添加工程师: ${name} (${id}) - 生成身份码`);
            }

            // --- 共同的 QR Code 生成和通知逻辑 ---
            
            // 生成二维码
            qrCodeContainer.innerHTML = ''; // 清除旧的二维码
            qrPlaceholder.style.display = 'none';
            
            QRCode.toCanvas(document.getElementById('qrcode'), qrDataUrl, {
                width: 200,
                margin: 1,
                color: {
                    dark: '#000000',
                    light: '#FFFFFF'
                }
            }, function(error) {
                if (error) {
                    console.error(error);
                    showNotification('生成二维码失败', 'error');
                } else {
                    showNotification(successMessage, 'success');
                    
                    // 仅在新增工人时才需要更新这些 UI/同步
                    if (role === 'worker') {
                        renderEmployeeList();
                        updateEmployeeSelect();
                        updateStats();
                        // 同步到云端
                        cloudSync.uploadAllData();
                    }
                }
            });
        }
        
        // 输入验证
        function validateEmployeeInput(name, id) {
            if (!name || !id) {
                return '请输入姓名和工号';
            }
            
            if (name.length < 2 || name.length > 20) {
                return '姓名长度应在2-20字符之间';
            }
            
            if (!/^[A-Za-z0-9]{3,10}$/.test(id)) {
                return '工号只能包含字母和数字，长度3-10位';
            }
            
            return null;
        }
        
        // 清空表单
        function clearForm() {
            employeeNameInput.value = '';
            employeeIdInput.value = '';
            employeeRoleSelect.value = 'worker';
            qrCodeContainer.innerHTML = '';
            qrPlaceholder.style.display = 'block';
            showNotification('表单已清空', 'success');
        }
        
        // 渲染员工列表
        function renderEmployeeList() {
            employeeList.innerHTML = '';
            
            if (employees.length === 0) {
                employeeList.innerHTML = '<div class="empty-state">暂无员工信息</div>';
                totalEmployeesSpan.textContent = '0';
                workingEmployeesSpan.textContent = '0';
                return;
            }
            
            // 更新统计
            totalEmployeesSpan.textContent = employees.length + engineers.length;
            const workingCount = employees.filter(emp => 
                workRecords[emp.id] && workRecords[emp.id].isWorking
            ).length;
            workingEmployeesSpan.textContent = workingCount;
            
            employees.forEach(employee => {
                const employeeItem = document.createElement('div');
                employeeItem.className = 'employee-item';
                
                const isWorking = workRecords[employee.id] && workRecords[employee.id].isWorking;
                const statusClass = isWorking ? 'status-working' : 'status-idle';
                const statusText = isWorking ? '工作中' : '未工作';
                const startTime = workRecords[employee.id] ? workRecords[employee.id].startTime : null;
                
                // 计算今日工时和总工时
                const todayHours = calculateTodayWorkTime(employee.id);
                const totalHours = calculateTotalWorkTime(employee.id);
                
                employeeItem.innerHTML = `
                    <div class="employee-info">
                        <div class="employee-name">${employee.name}</div>
                        <div class="employee-id">工号: ${employee.id}</div>
                        <div class="work-time-details">
                            <div class="work-time-item"><span class="work-time-label">今日:</span> ${todayHours} 小时</div>
                            <div class="work-time-item"><span class="work-time-label">总计:</span> ${totalHours} 小时</div>
                        </div>
                        ${startTime ? `<div class="time-info">开始时间: ${formatDateTime(startTime)}</div>` : ''}
                    </div>
                    <div class="employee-actions">
                        <div class="employee-status ${statusClass}">${statusText}</div>
                        <button class="delete-btn" data-id="${employee.id}">删除</button>
                    </div>
                `;
                
                employeeList.appendChild(employeeItem);
            });
            
            // 更新工时排行
            updateWorkRanking();
            
            // 添加删除按钮事件
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const employeeId = this.getAttribute('data-id');
                    deleteEmployee(employeeId);
                });
            });
        }
        
        // 计算员工今日工时
        function calculateTodayWorkTime(employeeId) {
            if (!workRecords[employeeId]) return 0;
            
            const record = workRecords[employeeId];
            let todayHours = parseFloat(record.todayHours || 0);
            
            // 如果正在工作，加上当前工作时间
            if (record.isWorking && record.startTime && isToday(record.startTime)) {
                const currentWorkTime = (Date.now() - record.startTime) / (1000 * 60 * 60);
                todayHours += currentWorkTime;
            }
            
            // 保留2位小数
            return todayHours.toFixed(2);
        }
        
        // 计算员工总工时
        function calculateTotalWorkTime(employeeId) {
            if (!workRecords[employeeId]) return 0;
            
            const record = workRecords[employeeId];
            let totalHours = parseFloat(record.totalHours || 0);
            
            // 如果正在工作，加上当前工作时间
            if (record.isWorking && record.startTime) {
                const currentWorkTime = (Date.now() - record.startTime) / (1000 * 60 * 60);
                totalHours += currentWorkTime;
            }
            
            // 保留2位小数
            return totalHours.toFixed(2);
        }
        
        // 更新工时排行
        function updateWorkRanking() {
            workRankingList.innerHTML = '';
            
            if (employees.length === 0) {
                workRankingList.innerHTML = '<div class="empty-state">暂无数据</div>';
                return;
            }
            
            // 计算每个员工的今日工时并排序
            const rankedEmployees = employees.map(emp => {
                return {
                    ...emp,
                    workTime: parseFloat(calculateTodayWorkTime(emp.id))
                };
            }).sort((a, b) => b.workTime - a.workTime);
            
            rankedEmployees.forEach((emp, index) => {
                const rankItem = document.createElement('div');
                rankItem.className = 'history-item';
                
                rankItem.innerHTML = `
                    <div class="history-date">${index + 1}. ${emp.name}</div>
                    <div class="history-duration">${emp.workTime.toFixed(2)} 小时</div>
                `;
                
                workRankingList.appendChild(rankItem);
            });
        }
        
        // 删除员工
        function deleteEmployee(employeeId) {
            if (confirm('确定要删除该员工吗？此操作不可恢复。')) {
                const employee = employees.find(emp => emp.id === employeeId);
                
                // 从员工列表中移除
                employees = employees.filter(emp => emp.id !== employeeId);
                localStorage.setItem('employees', JSON.stringify(employees));
                
                // 从工时记录中移除
                if (workRecords[employeeId]) {
                    delete workRecords[employeeId];
                    localStorage.setItem('workRecords', JSON.stringify(workRecords));
                }
                
                // 如果当前选择的员工被删除，清空选择
                if (currentEmployeeId === employeeId) {
                    currentEmployeeId = null;
                    selectedEmployeeSelect.value = '';
                }
                
                // 更新UI
                renderEmployeeList();
                updateEmployeeSelect();
                updateTotalHours();
                updateStats();
                
                showNotification('员工已删除', 'success');
                addSystemLog(`删除员工: ${employee.name} (${employeeId})`);
                
                // 从云端删除
                cloudSync.deleteEmployee(employeeId);
            }
        }
        
        // 更新员工选择下拉框
        function updateEmployeeSelect() {
            selectedEmployeeSelect.innerHTML = '<option value="">-- 请选择员工 --</option>';
            
            employees.forEach(employee => {
                const option = document.createElement('option');
                option.value = employee.id;
                option.textContent = `${employee.name} (${employee.id})`;
                selectedEmployeeSelect.appendChild(option);
            });
        }
        
        // 开始工作
        function startWork() {
            const employeeId = selectedEmployeeSelect.value;
            
            if (!employeeId) {
                showNotification('请先选择员工', 'error');
                return;
            }
            
            // 初始化员工记录
            if (!workRecords[employeeId]) {
                workRecords[employeeId] = {
                    totalHours: 0,
                    todayHours: 0,
                    isWorking: false,
                    startTime: null,
                    history: []
                };
            }
            
            const record = workRecords[employeeId];
            
            if (record.isWorking) {
                showNotification('该员工已在工作中', 'error');
                return;
            }
            
            // 开始计时
            record.isWorking = true;
            record.startTime = Date.now();
            
            // 保存到本地存储
            localStorage.setItem('workRecords', JSON.stringify(workRecords));
            
            // 更新UI
            renderEmployeeList();
            showNotification('工作计时已开始', 'success');
            
            // 添加工作历史记录
            const employee = employees.find(emp => emp.id === employeeId);
            addWorkHistory(employeeId, `手动开始工作 - ${formatDateTime(Date.now())}`);
            
            // 添加系统日志
            addSystemLog(`员工 ${employee.name} 手动开始工作`);
            
            // 更新工作历史显示
            renderWorkHistory(employeeId);
            
            // 同步到云端
            cloudSync.uploadAllData();
        }
        
        // 暂停工作
        function pauseWork() {
            const employeeId = selectedEmployeeSelect.value;
            
            if (!employeeId) {
                showNotification('请先选择员工', 'error');
                return;
            }
            
            if (!workRecords[employeeId]) {
                showNotification('该员工没有工作记录', 'error');
                return;
            }
            
            const record = workRecords[employeeId];
            
            if (!record.isWorking) {
                showNotification('该员工未在工作', 'error');
                return;
            }
            
            // 计算工作时间并暂停
            const workTimeHours = (Date.now() - record.startTime) / (1000 * 60 * 60);
            
            // 更新工时记录
            record.totalHours = parseFloat(record.totalHours || 0) + workTimeHours;
            
            // 如果是今天的工作，更新今日工时
            if (isToday(record.startTime)) {
                record.todayHours = parseFloat(record.todayHours || 0) + workTimeHours;
            }
            
            record.isWorking = false;
            record.startTime = null;
            
            // 保存到本地存储
            localStorage.setItem('workRecords', JSON.stringify(workRecords));
            
            // 更新UI
            renderEmployeeList();
            updateTotalHours();
            showNotification('工作已暂停', 'success');
            
            // 添加工作历史记录
            const employee = employees.find(emp => emp.id === employeeId);
            addWorkHistory(employeeId, `手动暂停工作 - 本次工作时长: ${workTimeHours.toFixed(2)}小时`);
            
            // 添加系统日志
            addSystemLog(`员工 ${employee.name} 手动暂停工作`);
            
            // 更新工作历史显示
            renderWorkHistory(employeeId);
            
            // 同步到云端
            cloudSync.uploadAllData();
        }
        
        // 保存工时
        function saveWork() {
            const employeeId = selectedEmployeeSelect.value;
            
            if (!employeeId) {
                showNotification('请先选择员工', 'error');
                return;
            }
            
            if (!workRecords[employeeId]) {
                showNotification('该员工没有可保存的工时记录', 'error');
                return;
            }
            
            // 确保先暂停计时
            if (workRecords[employeeId].isWorking) {
                pauseWork();
            }
            
            // 保存到localStorage
            localStorage.setItem('workRecords', JSON.stringify(workRecords));
            
            // 更新UI
            updateTotalHours();
            showNotification('工时记录已保存', 'success');
            
            // 添加系统日志
            const employee = employees.find(emp => emp.id === employeeId);
            addSystemLog(`保存员工 ${employee.name} 的工时记录`);
            
            // 同步到云端
            cloudSync.uploadAllData();
        }
        
        // 添加工作历史记录
        function addWorkHistory(employeeId, action) {
            if (!workRecords[employeeId].history) {
                workRecords[employeeId].history = [];
            }
            
            workRecords[employeeId].history.push({
                action,
                timestamp: new Date().toISOString()
            });
            
            // 更新工作历史显示
            renderWorkHistory(employeeId);
        }
        
        // 渲染工作历史
        function renderWorkHistory(employeeId) {
            workHistoryList.innerHTML = '';
            
            if (!workRecords[employeeId] || !workRecords[employeeId].history || workRecords[employeeId].history.length === 0) {
                workHistoryList.innerHTML = '<div class="empty-state">暂无工作记录</div>';
                return;
            }
            
            const history = workRecords[employeeId].history.slice(-5); // 只显示最近5条记录
            
            history.forEach(item => {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                
                const date = new Date(item.timestamp);
                const timeString = formatDateTime(date.getTime());
                
                historyItem.innerHTML = `
                    <div class="history-date">${item.action}</div>
                    <div class="history-time">${timeString}</div>
                `;
                
                workHistoryList.appendChild(historyItem);
            });
        }
        
        // 更新总工时显示
        function updateTotalHours() {
            let total = 0;
            
            for (const employeeId in workRecords) {
                total += parseFloat(calculateTodayWorkTime(employeeId));
            }
            
            totalHoursSpan.textContent = total.toFixed(2);
        }
        
        // 更新统计信息
        function updateStats() {
            // 员工统计
            statTotalEmployees.textContent = employees.length + engineers.length; // 统计工人+工程师总数
            
            // 工时统计
            let totalHours = 0;
            let todayHours = 0;
            let activeEmployees = 0;
            
            for (const employeeId in workRecords) {
                totalHours += parseFloat(calculateTotalWorkTime(employeeId));
                todayHours += parseFloat(calculateTodayWorkTime(employeeId));
                
                if (workRecords[employeeId].isWorking) {
                    activeEmployees++;
                }
            }
            
            statTotalHours.textContent = totalHours.toFixed(2);
            statTodayHours.textContent = todayHours.toFixed(2);
            statActiveEmployees.textContent = activeEmployees;
        }
        
        // 添加系统日志
        function addSystemLog(message) {
            const log = {
                message,
                timestamp: new Date().toISOString()
            };
            
            systemLogs.unshift(log);
            
            // 限制日志数量
            if (systemLogs.length > 50) {
                systemLogs.pop();
            }
            
            // 保存到localStorage
            localStorage.setItem('systemLogs', JSON.stringify(systemLogs));
            
            // 更新UI
            renderSystemLogs();
        }
        
        // 渲染系统日志
        function renderSystemLogs() {
            systemLogsList.innerHTML = '';
            
            if (systemLogs.length === 0) {
                systemLogsList.innerHTML = '<div class="empty-state">暂无系统日志</div>';
                return;
            }
            
            systemLogs.forEach(log => {
                const logItem = document.createElement('div');
                logItem.className = 'log-item';
                
                const date = new Date(log.timestamp);
                const timeString = formatDateTime(date.getTime());
                
                logItem.innerHTML = `
                    <div>${log.message}</div>
                    <div class="log-time">${timeString}</div>
                `;
                
                systemLogsList.appendChild(logItem);
            });
        }
        
        // 显示通知
        function showNotification(message, type) {
            notification.textContent = message;
            notification.className = `notification ${type} show`;
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // ==================== 微信扫码相关功能 ====================

        // 加载微信扫码记录
        async function loadWechatScans() {
            try {
                const { data: scans, error } = await cloudSync.supabase
                    .from('wechat_scans')
                    .select('*')
                    .order('scan_time', { ascending: false })
                    .limit(5); // 只显示最近5条记录

                if (error) {
                    console.error('加载微信扫码记录失败:', error);
                    return;
                }

                renderWechatScans(scans || []);
            } catch (error) {
                console.error('加载微信扫码记录异常:', error);
            }
        }

        // 渲染微信扫码记录
        function renderWechatScans(scans) {
            wechatScansList.innerHTML = '';

            if (scans.length === 0) {
                wechatScansList.innerHTML = '<div class="empty-state">暂无微信扫码记录</div>';
                return;
            }

            scans.forEach(scan => {
                const scanItem = document.createElement('div');
                scanItem.className = 'wechat-scan-item';
                
                const employee = employees.find(emp => emp.id === scan.employee_id);
                const employeeName = employee ? employee.name : scan.employee_id;
                const scanTime = new Date(scan.scan_time).toLocaleString('zh-CN');
                
                // 显示扫描者信息
                const scannerInfo = scan.scanner_id ? ` (扫描者: ${scan.scanner_id})` : '';

                scanItem.innerHTML = `
                    <div><strong>${employeeName}</strong> (${scan.employee_id}) ${scannerInfo}</div>
                    <div class="wechat-scan-time">${scanTime}</div>
                `;

                wechatScansList.appendChild(scanItem);
            });
        }
    </script>
</body>
</html>
